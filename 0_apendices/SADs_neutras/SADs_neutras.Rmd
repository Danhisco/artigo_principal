---
title: "SADs neutras"
author: "Mori, Danilo"
date: "19/11/2022"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE,message = FALSE,warning = FALSE)
# pacotes
library(twosamples)
library(sads)
library(doMC)
library(ggpmisc)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(insight)
library(bbmle)
library(DHARMa)
library(lme4)
library(plyr)
library(dplyr)
# funções
source("source/dinamica_coalescente.R")
source("source/2samples_testes.R")
source("source/f_plotSADacumulada.R")
source("source/chi2_2samples_bootstrap.R")
f_dfSADcsv <- function(l_files.path.full, site_pattern = "(?<=EE\\/).*?(?=.csv)"){
  mutate(data.frame(
    SAD.path = l_files.path.full),
    SiteCode = str_extract(SAD.path,site_pattern)
  )
}
## dados comuns
# df_p
df_p <- read_csv("dados/df_p.csv")
#df_sítios simuláveis em MNEE contemporâneo
v_site <- read_csv("dados/csv/resultados_MN/MNEE/cont/df_resultados.csv") |> 
  pull(SiteCode) |> unique()
# df_sim
df_sim <- read_csv("dados/df_simulacao.csv") |> 
  select(-tif.path) |> 
  inner_join(y=mutate(
    data.frame(txt.path = list.files(path="dados/simulacao",pattern=".txt")),
    SiteCode = str_extract(txt.path,".*?(?=.txt)")),
    by="SiteCode") |> 
  filter(SiteCode %in% v_site)
####### df_SADrep: correspondente, prístino, numerador, denominador #######
# df_SADrep
df_SADrep <- mutate(
  data.frame(
    SADrep.path = list.files(path = "dados/csv_SoE/SADs_neutras/MNEE",
                             pattern = ".csv",full.names = T,recursive = T)
    ),
  SiteCode = str_extract(SADrep.path,"(?<=[cont|frag|ideal]\\/).*?(?=_So)"),
  land_type = str_extract(SADrep.path,"(?<=MNEE\\/).*?(?=\\/)"),
  SoE = str_extract(
    gsub("dados/csv_SoE","",SADrep.path),
    "(?<=SoE).*?(?=km)"
    ),
  SADobs.path = paste0("dados/csv/SADs_observadas/",SiteCode,".csv")
)
df_SADrep_todos4km <- mutate(data.frame(
  SADrep.path = list.files(path = "dados/csv_SoE/SADs_neutras/MNEE",
                           pattern = ".csv",full.names = T,recursive = T)),
  SiteCode = str_extract(SADrep.path,"(?<=[cont|frag|ideal]\\/).*?(?=.csv)"),
  land_type = str_extract(SADrep.path,"(?<=MNEE\\/).*?(?=\\/)"),
  SADobs.path = paste0("dados/csv/SADs_observadas/",SiteCode,".csv"))
#
#
#
################################################
################## todos 4 km ##################
################################################
# # df_repMNEE
df_repMNEE <- read_csv("dados/csv/resultados_MN/MNEE/df_repMNEE")
# # df_resultMNEE
df_resultados <- read_csv("dados/csv/resultados_MN/df_resultados.csv")
# df_contrastes
df_contrastes <- read_csv(file="dados/csv/taxaU/df_contrastes.csv")
# df_ad
df_logOR <- df_resultados |> 
  inner_join(y=select(df_contrastes,-p),by=c("SiteCode","k")) |> 
  inner_join(y=distinct(select(df_sim,SiteCode,Ntotal,S_obs)),"SiteCode")
```

## Comparação com a SAD observada

### testes KS e a contagem de espécies

```{r versão nova para incluir SoE}
f_bySite_e_Land <- \(dfi){
  #
  l_csv <- lapply(dfi$SADrep.path,read_csv)
  names(l_csv) <- dfi$SoE
  #
  df_sad <- do.call("rbind",l_csv)
  temppath <- tempfile(fileext = ".csv")
  write_csv(df_sad,temppath)
  #
  dfi <- select(dfi,-SoE) %>% 
    mutate(SADrep.path=temppath) %>% 
    distinct()
  dfr <- f_resultsMN(dfi)
  #
  file.remove(temppath)
  #
  return(dfr)
}
#
registerDoMC(2)
df_KSrep <- ddply(df_SADrep,
                  c("SiteCode","land_type"),
                  f_bySite_e_Land,
                  .parallel = TRUE)
write_csv(df_KSrep,file="dados/csv_SoE/df_KSrep.csv")
```




```{r VERSÃO COM TODAS AS COMBINAÇÕES DE U - testes KS e S - taxa U por tipo de paisagem}
# preparação
path_repo <- "dados/csv/SADs_neutras/"
v_dirs <- list.dirs(path_repo,full.names = FALSE)
v_dirs <- v_dirs[v_dirs!=""] #? 
names(v_dirs) <- v_dirs
f_leitura_SADs <- \(v_path){
  v_path0="dados/csv/SADs_neutras/"
  mutate(data.frame(
  SADrep.path = list.files(path = paste0(v_path0,v_path),
                           pattern = ".csv",full.names = T,recursive = T)),
  SiteCode = str_extract(SADrep.path,"(?<=__).*?(?=\\.csv)"),
  land_type = str_extract(SADrep.path,"(?<=(contemp|non_frag|ideal)\\/).*?(?=__)"),
  SADobs.path = paste0("dados/csv/SADs_observadas/",SiteCode,".csv"))
}
# 
l_paths <- lapply(v_dirs,f_leitura_SADs)
lapply(names(l_paths),\(li){
  # setup
  df_SADrep <- l_paths[[li]]
  # rotina
  registerDoMC(3)
  df_repMNEE <- adply(df_SADrep,1,f_resultsMN,.parallel = TRUE)
  # salvamento
  v_path <- paste0("dados/csv/SADs_neutras/df_",li,".csv")
  write_csv(select(df_repMNEE,SiteCode:S), file = v_path)  
})
```

### Sumarização 

```{r 1a versão com SoE}
f_summarise_SAD_MNEE <- \(df){
#@ df: df por site, k, e  land_type
#@ e.g. ddply(.,c("SiteCode","k","land_type"))
 cbind(df[1,c("SiteCode","k","land_type")],with(df,data.frame(
   nCongKS = sum(p.KS>0.05),
   Smed = mean(S),
   Ssd = sd(S),
   Smin = min(S),
   Smax = max(S)))
  )
}
df_KSrep <- read_csv(file="dados/csv_SoE/df_KSrep.csv")
registerDoMC(3)
df_ad <- ddply(df_KSrep,c("SiteCode","k","land_type"),
               f_summarise_SAD_MNEE,
               .parallel = TRUE)
write_csv(df_ad,file="dados/csv_SoE/df_congruencia_simulacao.csv")
```


```{r todos os U possíveis}
l_df <- list.files(path="./dados/csv/SADs_neutras",
                   pattern="df_",full.names = T)
names(l_df) <- list.files(path="./dados/csv/SADs_neutras",pattern="df_") %>% 
  gsub("\\.csv","",.)
l_df <- lapply(l_df, read_csv) %>% 
  llply(.,\(dfi){
    registerDoMC(3)
    ddply(dfi,
          c("SiteCode","k","land_type"),
          f_summarise_SAD_MNEE,
          .parallel = TRUE)
  })
df_adSAD <- lapply(names(l_df),\(i){
  l_df[[i]] %>% 
    mutate(taxaU=str_extract(i,"(contemp|ideal|non_frag)")) %>% 
    relocate(taxaU)
}) %>% rbind.fill()
saveRDS(df_adSAD,file="5_resultados/df_adSAD.rds")
write_csv(df_adSAD,file="5_resultados/df_adSAD.csv")
```

## Conversão para 




#############################################
################## antigo ###################
#############################################

```{r testes KS e S - taxa U idealizado}
registerDoMC(3)
df_repMNEE <- adply(df_SADrep2,1,f_resultsMN,.parallel = TRUE)
write_csv(select(df_repMNEE,SiteCode:S), file = "dados/csv/resultados_MN/MNEE/df_repMNEE")
```

```{r}
df_repMNEE2 <- read.csv("./dados/csv/resultados_MN/MNEE/df_repMNEE2.csv")
registerDoMC(3)
df_repMNEE2 <- ddply(df_repMNEE2,c("SiteCode","k","land_type"),f_summarise_SAD_MNEE,.parallel = TRUE)


```



```{r summarise resultados de MNEE}
l_df <- 
  list.files("./dados/csv/resultados_MN/MNEE", pattern = "df_repMNEE",full.names = TRUE) %>% 
  llply(.,read.csv)
names(l_df) <- c("Ulivre","Upristino")
f_ldply <- \(vname){
  dfi <- l_df[[vname]] %>% 
    mutate(land_type=case_when(land_type=="cont" ~ "contemp",
                               land_type=="non_frag" ~ "aglomer",
                               land_type=="ideal" ~ "pristin",
                               TRUE ~ land_type),
           Uestimad = vname)
  registerDoMC(2)
  ddply(dfi,c("SiteCode","k","land_type"),f_summarise_SAD_MNEE,.parallel = TRUE)
}
df_resultados <- ldply(names(l_df),f_ldply)
write_csv(df_resultados,file = "dados/csv/resultados_MN/df_resultados.csv")
```




### Gráficos Exploratórios

```{r GE1 nCongKS ~ k by land type ~ |SiteCode ~ p AJUSTAR DIMENSÕES}
df_plot <- df_resultados |> 
  arrange(p) |> 
  mutate(label = paste0(SiteCode,", p=",round(p,2)))
df_plot$label <- factor(df_plot$label,levels=unique(df_plot$label))
df_plot |> 
  ggplot(aes(x=k,y=nCongKS,color=land_type)) +
  geom_smooth(method = "loess",se=F,alpha=0.4) +
  geom_point(alpha=0.4) +
  scale_x_reverse() +
  theme_bw() +
  labs(color="landscape type") +
  theme(legend.position = "top",
        axis.text=element_text(size=4.5),
        strip.text = element_text(size = 4.5, margin = margin())) +
  scale_color_manual(values=c("darkred","darkblue","darkgreen"),
                     labels=c("contemporâneo","idealizado","sem fragmentação")) +
  facet_wrap(~label,ncol=4)
ggsave("apendices/SADs_neutras/figuras/nCongKS_k_landType_Site.png",
       width = 7,
       height = 30)
```

```{r GE2 logOR cont.non_frag ~ contrastes by k ~ |SiteCode ~ p EM ESTUDO}
df_plot <- df_logOR |> 
  select(-c(cont.ideal:non_frag.ideal)) |>
  arrange(p) |> 
  mutate(label = paste0(SiteCode,", p=",round(p,2)))
df_plot$label <- factor(df_plot$label,levels=unique(df_plot$label))
df_plot |> 
  ggplot(aes(x=k,y=cont.non_frag)) +
  geom_hline(yintercept = 0,color="darkred") +
  geom_smooth(method = "loess",se=F) +
  geom_point() +
  scale_x_reverse() +
  theme_bw() +
  labs(color="landscape type") +
  theme(legend.position = "top",
        axis.text=element_text(size=4.5),
        strip.text = element_text(size = 4.5, margin = margin())) +
  # scale_color_manual(values=c("darkred","darkblue","darkgreen"),
  #                    labels=c("contemporâneo","idealizado","sem fragmentação")) +
  facet_wrap(~label,ncol=4)
ggsave("apendices/SADs_neutras/figuras/logOR_cont.non_frag_k_Site_p.png",
       width = 7,
       height = 30)
```


```{r GE3 nCongKS ~ contrastes EF}
df_plot <- df_logOR |> 
  select(-c(cont.ideal:non_frag.ideal)) |>
  arrange(p) |> 
  mutate(label = paste0(SiteCode,", p=",round(p,2)))
df_plot$label <- factor(df_plot$label,levels=unique(df_plot$label))
df_plot |> 
  ggplot(aes(x=k,y=cont.non_frag)) +
  geom_point()
```


## Comparação gráfica SAD acumulada e predita

```{r comparação SAD acumulada e predita}
df_plot <- inner_join(df_resultMNEE,df_SADrep,by="SiteCode") |> 
  left_join(y=distinct(select(df_sim,SiteCode:S_obs)),by="SiteCode")
d_ply(df_plot,"SiteCode",f_plot.SADacumulada)
```

Qual o comportamento geral?

Casos em que 
DTS parece ser melhor: BAlenc4,

KS parece ser melhor: MGlavr2, MGlavr3, MGlavr6, MGubera, MGuberl1, MGuberl3, MGuberl5, MGuberl6, MGuberl7,MGvico3, MGvico4, MGvico16, PEcabo2, PEcaru1, PEsvfer,PRanto5, PRanto7, PRanto8, PRanto9, PRanto10, PRanto11, PRanto14, PRdiam2, PRdiam3, PRipir, PRrico1, PRrico3, PRtiba1, PRvent, RJpnrj, RScach1, RScach3, RScach4, RScama, RSfaxi, RSgaur, RSpet1, RSrioz1, RSsetape, RSsmar4, RSvsol, SCcric1, SCorle, SCserra4, SCside, SCside1, SCside4, SCsjo1, SPcara3, SPeec1, SPeec4, SPeec5, SPjabo1, SPpecb1, SPpesmD, SPpesmH, SPpesmK, SPpesmL, SPpesmN,      

os dois são ruins: MGmadre4, MSdour, PEmata2, PRanto6, PRanto12, PRdiam4, PRsapo, RScach2, RScamb1, RScris, RSmaqu4, SCvolta1, SCvolta2, SPitir1, SPpei1, SPpesm6, SPpesmA, SPpesmB, SPpesmF, 

os dois são semelhantes: BAjuss, BAuruc, ESsoor, MGipia1, MGvico1, MSjatei, PEalia, PEbrejo, PRanto4, PRanto13, PRanto15, PRtele, RSmorr1, RSsini, SCilho, SCilho2, SCtimbe1, SPcana1, SPcara1, SPigua1, SPpesmC, SPpesmE, SPpesmI, SPpesmJ, SPpesmM, SPpesmS, SPpesmU, 

Comentários:
não é simples fazer essa classificação, em alguns casos (SiteCode) ambos parecem ser ruins, pois acertam em alguns k e erram em outros. E ser melhor não implica em ser bom em si.  


## Comparação entre os contrastes

```{r congruencia entre contrastes - obtenção dos dados}
#  obtenção dos dados
registerDoMC(3)
l_SADreps %>% names()
f_lSADreps <- \(li){
  df_SADrep <- li
  d_ply(df_SADrep,"SiteCode",f_congContrastes,.parallel = T)
}


# df_congContrastes <- d_ply(df_SADrep,"SiteCode",f_congContrastes,.parallel = T)
# write_csv(df_congContrastes,file="dados/csv/resultados_MN/df_congContrastesREP.csv")

```

```{r congruencia entre contrastes - sintese dos dados}
df_congContrastes <- list.files("dados/csv/congruencia_contrastes",pattern = ".csv",full.names = T) |> 
  map_dfr(\(path) read_csv(path) |> 
            group_by(SiteCode,pair,k) |> 
            summarise(nCong = sum(p.valor>0.05)))
write_csv(df_congContrastes,"dados/csv/resultados_MN/df_congContrastes.csv")
```

