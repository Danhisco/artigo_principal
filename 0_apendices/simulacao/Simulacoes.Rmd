---
title: "Simulacoes"
author: "Mori, Danilo"
date: "18/03/2023"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE,message = FALSE,warning = FALSE)
# funções (deixar sempre em cima pois alguns carregam suas próprias bibliotecas)
source("source/dinamica_coalescente.R")
source("source/mapa_p_MNEE.R")
# pacotes
library(doMC)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(plyr)
library(dplyr)
## dados comuns
# df_p
df_p <- read_csv("dados/df_p.csv")
#df_sítios simuláveis em MNEE contemporâneo
v_site <- read_csv("dados/csv/resultados_MN/MNEE/cont/df_resultados.csv") |> 
  pull(SiteCode) |> unique()
# df_sim
df_sim <- read_csv("dados/df_simulacao.csv") |> 
  dplyr::select(-tif.path) |> 
  inner_join(y=mutate(
    data.frame(txt.path = list.files(path="dados/simulacao",pattern=".txt")),
    SiteCode = str_extract(txt.path,".*?(?=.txt)")),
    by="SiteCode") |> 
  filter(SiteCode %in% v_site) |>
  left_join(df_p,by="SiteCode")
df_sim <- cbind(df_sim,land_type = rep(x=c("ideal","non_frag"),each=nrow(df_sim)))
#
df_simSAD <- inner_join(
  df_sim %>% filter(land_type=="ideal") %>% select(-land_type),
  read_csv("dados/csv/taxaU/df_U.csv") %>% filter(land_type!="ideal")
  ) %>% select(-Usd)
setwd("dados/simulacao")
# setwd("../..")
```



```{r desenvolvimento de peça de conexão}
# 1) para 1a paisagem qualquer a simulação de U e SAD
f_simUeSAD <- \(df_exti){
  folder_path <- paste0(general_path,
                        "/csv/taxaU/MNEE/",
                        df_exti$land_type[1],
                        "/")
  path_df_simSAD <- paste0(folder_path,
                           df_exti$SiteCode[1],
                           ".csv")
  if(!file.exists(path_df_simSAD)){
    # taxa U
    f_writeUcsv(df_bySite = df_exti,
                land_matrix = m_land,
                path_csv = folder_path,
                n_replicas = U_rep)
  }
  # síntese taxa U
  df_simSAD <- read_csv(path_df_simSAD) |> 
    pivot_longer(-c(SiteCode:d)) |> 
    summarise(Umed = mean(value),.by = "k") |> 
    inner_join(x=df_exti,by="k")
  # SAD
  folder_path <- paste0(general_path,
                        "/csv/SADs_neutras/MNEE/",
                        df_exti$land_type[1],
                        "/")
  f_writeSADcsv(df_bySite = df_simSAD,
                land_matrix = m_land, 
                path_csv = folder_path,
                n_replicas = SAD_rep)
}
```

Para cada extensão espacial adequada vai rodar todos os k na paisagem:
Começar com a maior extensão e então ir reduzindo para as escalas intermediárias 

1o filtrar a escala
2o simular todos os k filtrados em sequência: fragmentada, aglomerada e prístina
3o repetir na próxima escala

Como é hoje?
para cada paisagem é rodado a simulação.
Podemos considerar que entra uma paisagem fragmentada com extensão fixa e todo o processo de
simulação de U e SAD nas três paisagens é feita, esses documentos ficam no ambiente do R




```{r função para simular as SADs para MNEE em diferentes tipos de paisagens}
df <- df_simSAD %>% filter(SiteCode=="SPigua1")
registerDoMC(3)
v_gpath <- "/media/danilo/HD_externo/Documentos/mestrado_Ecologia/artigo_principal/dados"
# formals(f_simMNEE2)$
f_d_ply <- function(dataframe) f_simMNEE(df = dataframe,general_path = v_gpath)
d_ply(filter(df_sim,land_type=="ideal") %>% select(-land_type),
      c("SiteCode"),f_d_ply,.parallel = TRUE)
```




