---
title: "Simulacoes"
author: "Mori, Danilo"
date: "18/03/2023"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE,message = FALSE,warning = FALSE)
# funções (deixar sempre em cima pois alguns carregam suas próprias bibliotecas)
source("source/dinamica_coalescente.R")
source("source/mapa_p_MNEE.R")
# pacotes
library(doMC)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(plyr)
library(dplyr)
## dados comuns
# df_p
df_p <- read_csv("dados/df_p.csv")
#df_sítios simuláveis em MNEE contemporâneo
v_site <- read_csv("dados/csv/resultados_MN/MNEE/cont/df_resultados.csv") |> 
  pull(SiteCode) |> unique()
# df_sim
df_sim <- read_csv("dados/df_simulacao.csv") |> 
  dplyr::select(-tif.path) |> 
  inner_join(y=mutate(
    data.frame(txt.path = list.files(path="dados/simulacao",pattern=".txt")),
    SiteCode = str_extract(txt.path,".*?(?=.txt)")),
    by="SiteCode") |> 
  filter(SiteCode %in% v_site) |>
  left_join(df_p,by="SiteCode")
# df_sim <- cbind(df_sim,land_type = rep(x=c("ideal","non_frag"),each=nrow(df_sim)))
#
# df_simSAD <- inner_join(
#   df_sim %>% filter(land_type=="ideal") %>% select(-land_type),
#   read_csv("dados/csv/taxaU/df_U.csv") %>% filter(land_type!="ideal")
#   ) %>% select(-Usd)
#
df_SoE <- read_csv("./dados/csv/df_plotSoE.csv") %>% 
  select(k,SoE_0.95) %>% distinct() %>% 
  rename(SoE=2) %>% 
  mutate(SoE=ifelse(is.na(SoE),1,SoE))
#
df_sim <- inner_join(
  df_sim,
  df_SoE
)
# setwd("../..")
```



```{r desenvolvimento de peça de conexão}
# quais os sítios que estão simulados?
df_lf <- lapply(c("cont","ideal","non_frag"),\(li){
  data.frame(
    files = list.files(path=paste0("dados/csv_SoE/taxaU/MNEE/",li),
             pattern = ".csv",
             recursive = TRUE)
  ) %>% mutate(
    SiteCode = str_extract(files,"^[^_]+"),
    SoE = str_extract(files,"(?<=SoE)(.*?)(?=km)")
  ) %>% count(SiteCode) %>% mutate(contraste=li)
  }) 
# %>% do.call("rbind",.) 
# %>% 
#   filter(n==3) %>% 
#   count(SiteCode) %>% 
#   filter(n==3)
names(df_lf) <- c("cont","ideal","non_frag")
```

Para cada extensão espacial adequada vai rodar todos os k na paisagem:
Começar com a maior extensão e então ir reduzindo para as escalas intermediárias 

1o filtrar a escala
2o simular todos os k filtrados em sequência: fragmentada, aglomerada e prístina
3o repetir na próxima escala

Como é hoje?
para cada paisagem é rodado a simulação.
Podemos considerar que entra uma paisagem fragmentada com extensão fixa e todo o processo de
simulação de U e SAD nas três paisagens é feita, esses documentos ficam no ambiente do R




```{r função para simular as SADs para MNEE em diferentes tipos de paisagens}
setwd("dados/simulacao")
df <- df_sim %>% filter(SiteCode=="SPigua1")
registerDoMC(3)
v_gpath <- ".."
formals(f_simMNEE)$general_path <- v_gpath
#
# df_sim2 <- filter(df_sim,!SiteCode%in%df_lf$SiteCode)
df_sim2 <- filter(df_sim,SiteCode%in%vsite)
# f_d_ply <- function(dataframe) f_simMNEE(df = dataframe,general_path = v_gpath)
df <- df_sim2 %>% filter(SiteCode==vsite[2])
d_ply(df_sim2,"SiteCode",f_simMNEE,.parallel = TRUE)
```


## Síntese dos dados

```{r}
setwd("../..")
df_estudo <- mutate(
  data.frame(
    SADrep.path = list.files(path = "dados/csv_SoE/SADs_neutras/MNEE",
                             pattern = ".csv",full.names = T,recursive = T)
    ),
  SiteCode = str_extract(SADrep.path,"(?<=[cont|frag|ideal]\\/).*?(?=_So)"),
  land_type = str_extract(SADrep.path,"(?<=MNEE\\/).*?(?=\\/)"),
  SoE = str_extract(
    gsub("dados/csv_SoE","",SADrep.path),
    "(?<=SoE).*?(?=km)"
    ),
  SADobs.path = paste0("dados/csv/SADs_observadas/",SiteCode,".csv")
)
##################################################################
############## Existem sítios sem simulação? #####################
##################################################################
# vsite <- df_estudo %>% 
#   group_by(SiteCode,land_type) %>% 
#   tally() %>% 
#   filter(n!=3) %>% 
#   pull(SiteCode)
# df_estudo %>% filter(SiteCode%in%vsite,land_type=="ideal")
##################################################################
#
# é possível juntar os data frames em um só?
f_bySite_e_Land <- \(dfi){
  #
  l_csv <- lapply(dfi$SADrep.path,read_csv)
  names(l_csv) <- dfi$SoE
  #
  df_sad <- do.call("rbind",l_csv)
  temppath <- tempfile(fileext = ".csv")
  write_csv(df_sad,temppath)
  #
  dfi <- select(dfi,-SoE) %>% 
    mutate(SADrep.path=temppath) %>% 
    distinct()
  dfr <- f_resultsMN(dfi)
  #
  file.remove(temppath)
  #
  return(dfr)
}





```

f_resultsMN
