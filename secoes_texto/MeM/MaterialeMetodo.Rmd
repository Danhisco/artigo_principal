---
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = FALSE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE,eval=TRUE)
# pacotes adicionais´
library(doMC)
library(readr)
library(gridExtra)
library(ggplot2)
library(tidyr)
library(readr)
library(stringr)
library(plyr)
library(dplyr)
# dados disponíveis
df_dados <- read_csv(file = "dados/df_dados_disponiveis.csv")
df_sim <- read_csv("dados/df_simulacao.csv")
df_p_extensoes <- read_csv("dados/csv/df_p_extensoes.csv")
```

```{r trackdown rotine, include=FALSE,eval=FALSE}
# pacotes
library(trackdown)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
upload_file(file="secoes_texto/MeM/MaterialeMetodo.Rmd",
            gpath="mestrado/artigo_principal/secoes_texto/",
            hide_code=TRUE)
update_file(file ="secoes_texto/MeM/MaterialeMetodo.Rmd",
            gpath = "mestrado/artigo_principal/secoes_texto/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file = "secoes_texto/MeM/MaterialeMetodo.Rmd",
              gpath = "mestrado/artigo_principal/secoes_texto/")
```


## Materiais e Método

### Sítios selecionados e graus de limitação de dispersão

  Selecionamos na base de dados TreeCo inventários florestais que amostraram em parcela única pelo menos 1ha de floresta, com alta confiabilidade taxonômica dos indivíduos arbóreos com DBH>=5.0cm e da coordenada central da parcela, totalizando 109 sítios (figura 1). As coordenadas dos sítios variaram entre -31° e -7° de latitude e entre -55° e -35° de longitude (figura 1a). A área amostrada mediana foi de 1 ha; o número de indivíduos amostrado mediano foi de 1540 indivíduos; a riqueza observada mediana foi de 107 espécies; e o ano de amostragem ou publicação mediano foi 2007 (figura 1b). Os mapas de cobertura vegetal contemporâneos foram recortadas a partir da coleção 6 do mapbiomas (@mapbiomas), tomando a coordenada central da parcela e o ano que melhor aproxima a amostragem da SAD (ano da coleta ou da publicação). A resolução dos mapas foram ajustados para que a densidade de pixels seja igual a densidade de indivíduos na parcela. As áreas da parcela e da paisagem são aproximadas por quadrados, em uma paisagem não foi possível desenhar uma área quadrado devido à configuração espacial do habitat e foi descartada. As paisagens idealizadas são obtidas transformanda as unidades de não habitat (matriz) dos mapas contenporâneos em unidades de habitat. Os graus de limitação de dispersão __per capita__ foram modelados com a distribuição de Laplace (exponencial espelhada; @Bullock2017) para obter a posição do progenitor por dois sorteios ortogonais independentes (@Rosindell2008, @Campos2012). Os 20 grus de limitação de dispersão foram controlados pela proporção de propágulos que permanece até a vizinhança imediata da planta progenitora, a distância até o vizinho imediato. Quanto menor a densidade de indivíduos, maior a distância entre indivíduos; assim o parâmetro que controla o desvio-padrão da distribuição de Laplace diminui com a densidade (figura 1c).

```{r fig 1 - sitios amostrados e grau de limitação de dispersao,fig.width=12,fig.height=6}
df_plot <- df_dados |> 
  select(SiteCode, effort_ha, Ntotal, S_obs, year_bestProxy, forest_succession, lat:long_correct)
l_p <- list()
l_p[[1]] <- df_plot |> 
  ggplot(aes(y=lat,x=long)) +
  geom_point(alpha=0.5) +
  theme_light() +
  labs(subtitle = "a)")
v_labels <- c("effort_ha" = "plot area (ha)",
              "Ntotal" = "# ind",
              "S_obs" = "riqueza",
              "year_bestProxy" = "approx. data year")
df_plot[grep("\\_",df_plot$year_bestProxy),"year_bestProxy"] <- "2012.5"
l_p[[2]] <- df_plot |>
  mutate(year_bestProxy = as.numeric(year_bestProxy)) |> 
  pivot_longer(effort_ha:year_bestProxy) |> 
  ggplot(aes(x=name,y=value)) +
  geom_jitter(alpha=0.4) +
  geom_boxplot() +
  labs(x="",y="",subtitle="b)") +
  facet_wrap(~name,ncol=1,scales="free", labeller = as_labeller(v_labels), strip.position = "bottom") +
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside") +
  coord_flip()
l_p[[3]] <- df_sim |> 
  mutate(DA = Ntotal / effort_ha,
         k_factor = factor(round(k,2))) |> 
  ggplot(aes(x=k_factor,y=d)) +
  geom_jitter(aes(color=DA)) +
  geom_boxplot() +
  labs(subtitle = "c)",
       y = "disp. kernel sd",
       x = "k") +
  theme_light() +
  theme(legend.position = "top")
grid.arrange(grobs=l_p,ncol=3)
```

__Figura 1__ Sítios selecionados e graus de limitação de dispersão simulados. a) latitude e longitude das coordenadas centrais dos inventários florestais. b) boxplot de variáveis dos inventários: área da parcela, número de indivíduos amostrado, riqueza de espécies observado, e ano da amostragem ou da publicação. c) graus de limitação de dispersão: desvio-padrão da distribuição de laplace (eixo y), e a proporção de propágulos que permanece até a distância imediata (até o vizinho imediato, eixo x), quanto menor a densidade de indivíduos (DA) maior a distância entre vizinhos e por isso menor o desvio padrão para obter a mesma proporção de propágulos até a vizinhança imediata.

### Modelos Neutros

Os modelos neutros utilizam simulações coalescentes, onde se retrocede no tempo para reconstruir a trajetória de cada indivíduo na área amostral até o primeiro progenitor que surgiu na paisagem, unindo indivíduos de uma mesma espécie em ramos comuns, criando árvores genealógicas da comunidade (@Azaele2016, @Thompson2020). A abordagem pressupõe que apenas um indivíduo pode colonizar uma unidade de habitat por vez e toda morte é reposta pelo surgimento de um indivíduo adulto (pressuposto de soma zero). Em todo evento de nascimento há a probabilidade U de que o nascimento ocorra de uma nova espécie na paisagem. Nos 1-U casos é sorteado um indivíduo presente na paisagem (parcela ou paisagem ao redor) como progenitor. Nos modelos neutros espacialmente explícitos um progenitor é sorteado centralizando a função de dispersão no habitat vago e sorteando posições até obter uma unidade de habitat. Nos modelos espacialmente implícitos, se a posição sorteada está dentro da parcela, então um sorteio é feito entre os indivíduos da parcela para definir o progenitor; caso o sorteio ocorra na paisagem ao redor, então um sorteio é feito entre os indivíduos da paisagem ao redor. Nos modelos sem espaço, sortea-se o progenitor entre os indivíduos remanescentes na paisagem (parcela e paisagem ao redor). Com essa abordagem é possível predizer SADs pressuposto equilíbrio dinâmico na paisagem local, situação onde as extinções de espécies na paisagem por deriva ecológica são equivalentes à colonização de novas espécies na paisagem (descrita pela taxa U). 

### extensão espacial da paisagem ao redor 

  Um desafio para implementar os 6 modelos para descrever a SAD em função da dispersão de indivíduos entre parcela e paisagem local é definir a extensão espacial da paisagem ao redor (@Jackson2015, @Miguet2017, @Fahrig2021). A extensão espacial da paisagem determina a quantidade máxima de habitat disponível ao redor dos sítios de estudo (figura 2). Os modelos sem espaço e de espaço implícito requerem que o pool de propágulos da paisagem ao redor seja pré delimitados, portanto precisam de uma extensão ótima (@Fahrig2021). Os modelos de espaço explícito requerem um tamanho minímo da paisagem ao redor, para que a construção da árvore genealógica da comunidade (@Thompson2020) não seja restringida pela extensão espacial da paisagem, mas sim pela limitação de dispersão. 
    

A análise de escala de efeito (@Jackson2015) propõe que a extensão espacial adequada é aquela que maximiza o peso de evidência da associação estatística entre o padrão de biodiversidade local estudado e a variável de interesse, por exemplo, a proporção de cobertura vegetal na paisagem. Essa abordagem tem sido adotada em diversos estudos (@Crouzeilles2016,@Stuber2020). Optamos por não utilizar a análise de escala de efeito, pois ela pressupõe que existe equilíbrio da resposta ecológica à heterogeneidade contemporânea da paisagem. Outros trabalhos com árvores na Floresta Atlântica utilizam paisagens de até 4 km de diâmetro (@Rocha-Santos2017, @Puttker2020, @Lima2020), uma argumentação é que a dispersão de propágulos e efeito de borda podem se extender em até 3 km (revisado por @Lima2020 e @Benchimol2017). Optamos por seguir a maior extensão espacial da paisagem usada nos estudos com árvores na Floresta Atlântica que encontrei (até ~ 4x4km2) e avaliamos quais os graus de limitação de dispersão inicialmente propostos são adequados para simular os modelos espacialmente explícitos nessa escala. Uma extensão adequada é aquela onde a árvore genealógica da comunidade é restringida apenas pela limitação de dispersão e não pela extensão espacial da paisagem, na situação idealizada de ausência de perda de habitat. Proponho selecionar os graus de dispersão no qual a escala de 4x4km2 é uma extensão adequada. Para um determinado grau de limitação de dispersão deve existir uma extensão espacial que acumule a maior parte do efeito da escala na contribuição de propágulos para a parcela. Assim, também é possível estabelecer correspondência entre grau de limitação de dispersão e subescala da paisagem ao redor suficiente para simular a árvore genealógica da comunidade. Os modelos espacialmente implícitos e sem espaço serão simulados utilizando a subescala suficiente, em acordo com o conceito de paisagem local, como área que contempla a maior parte da fonte dos propágulos que podem contribuir com a substituição de indivíduos na parcela (@Fahrig_2013, @Watling_2020).

```{r figura 2 p pelas extensões espaciais}
df_p_extensoes |> 
  ggplot(aes(x=lado_km,y=p)) + 
  geom_point(alpha=0.2,size=0.2) +
  geom_line(aes(group=SiteCode),linewidth=0.2,alpha=0.2) +
  labs(x="lado da paisagem quadrada (km)",y="proporção de cobertura vegetal",
       subtitle="Mudança na extensão espacial da paisagem e a proporção de cobertura vegetal") +
  scale_y_continuous(breaks = seq(0,1,by=0.1)) +
  coord_cartesian(expand = F) +
  theme_light()
```

__Figura 2__ Mudança na extensão espacial da paisagem a proporção de cobertura vegetal. Cada ponto representa a proporção de cobertura vegetal (eixo y) para aquela determinada extensão espacial da paisagem ao redor (eixo x), as linhas ligam pontos de um sítio de amostragem. Detalhes do procedimento em SI.

#### Proposta para determinar a relação entre dispersão e extensão espacial da paisagem

Uma forma de avaliar se a árvore genealógica da comunidade está sendo restringida pela extensão espacial da paisagem é investigar a taxa U, pois ela informa, indiretamente, a contribuição dos propágulos da paisagem ao redor na reposição das espécies perdidas localmente. Se a extensão espacial restringir a árvore genealógica para aquele cenario de limitacao de dispersão, a taxa U deve ser superestimada, pois a contribuição do pool de propágulos da paisagem local deve ser significamente menor do que a contribuição na situação de paisagem infinita, resultando em aumento da taxa U necessária para manter um valor de riqueza de espécies na parcela para aquele grau de limitação de dispersão. Exploramos paisagens quadradas que variaram de lado 0.5 km até 16 km e sem perda de habitat, para excluir os casos em que a taxa U se estabiliza por conta do isolamento do habitat da parcela em relação ao habitat remanescente na paisagem (@Thompson2019). Vamos pressupor que a maior extensão de 16x16km2 é aproximadamente similar à situação de paisagem infinita para os 20 graus de limitação de dispersão simulados e usar essa escala como referência para as outras 5 subescalas. Sorteamos 36 sítios dos 108 sítios totais para avaliar o efeito da escala na estimativa da taxa U, buscamos explorar a amplitude de valores de riqueza de espécies, número de indivíduos e área da parcela. Cada combinação de parâmetro terá 10 réplicas, somando 7200 simulações. Para comparar os sítios utilizaremos um protocolo de transformações na taxa U. O valor médio será obtido das replicas de uma bateria de simulações. Então, por sítio e grau de limitação de dispersão, a diferença das médias de escalas consecutivas foi dividida pela diferença entre os valores extremos para o conjunto de todas as escalas. O valor desta quanidade acumulada com o aumento da escala, pode informar quanta variação na taxa U foi acumulada até determinada escala.

No modelo espacialmente explícito em paisagens infinitas e sem perda de habitat, espera-se que a taxa U necessária para manter uma determinada riqueza na parcela apresente padrão não linear com o aumento da capacidade de dispersão (@May2012). Em graus de limitação à dispersão severa a taxa U estimada deve ser pequena, pois a perda de espécies deve ser pequena, uma vez que a maior parte das substituições ocorre entre indivíduos de uma mesma espécie devido à elevada agregação de coespecíficos. Com o relaxamento da limitação de dispersão a perda de espécies deve aumentar ao passo que a substituição de coespecíficos diminui, aumentando a perda de espécies por deriva ecológica. O aumento da erosão de espécies com o aumento da capacidade de dispersão não se mantem sempre, ao passo que outras subpopulações mais distantes da parcela podem repor espécies perdidas localmente, reduzindo a estimativa da taxa U. Assim, uma forma de avaliar se a maior extensão espacial de lado 16 km é suficiente para ser referência na avaliação do efeito da escala é observar se há o padrão não linear na taxa U. 

```{r figura 3 U para todo k em paisagens nulas na maior escala investigada,fig.width=12,fig.height=7,eval=FALSE,include=FALSE}
df_plot <- df_Unull |> 
  arrange(S_obs) |> 
  mutate(label = paste(SiteCode,S_obs,Ntotal,effort_ha,sep = ", "))
df_plot$label <- factor(df_plot$label,levels = unique(df_plot$label))
df_plot |> 
  ggplot(aes(x=k,y=Umed)) +
  geom_line() +
  geom_point() +
  labs(title = "U estimado por grau de dispersão em paisagens nulas de lado 16 km",
       subtitle = "label = SiteCode, S, N, plot area(ha); free y axis; reverse x axis") +
  # geom_vline(xintercept = c(0.25, 0.1,0.05),color="red",alpha=0.4) +
  scale_x_reverse() +
  facet_wrap(~label, ncol=6,scales="free_y")
```

<!-- <p> __Figura 3__ U estimado (eixo y) por grau de limitação de dispersão (eixo x) em paisagens sem perda de cobertura vegetal (nulas) na maior extensão espacial (lado de 16 km). Os pontos representam a média de 4 réplicas e as linhas ligam pontos de um mesmo sítio de amostragem. Os paineis estão separados por sítios de amostragem, cujo mapa de cobertura vegetal foi modificado para ter apenas unidades de habitat. As linhas em vermelho representam os graus de limitação de dispersão usados na análise de escala de efeito, k = 0.25, 0.10 e 0.05. Eixo y varia entre paineis e eixo x está reverso. Quanto menor k, maior a capacidade de dispersão simulada. S = riqueza da espécie, N = número de indivíduos, DA = densidade de indivíduos.</p> -->

<!-- # versão pré projeto -->
<!-- Um padrão não linear da taxa U em função da capacidade de dispersão pode ser observado nas simulações feitas nas paisagens de 16x16 km2 (Figura 3 U ~ k, 16x16km2). Estimamos a taxa U nos 20 graus de limitação de dispersão nas outras 5 subescalas exploradas (Figura 4). Então comparamos os valores de U estimados em escalas consecutivas, dividindo a diferença do valor de U entre escalas consecutivas pela diferença na amplitude das estimativas para aquele sítio e grau de limitação de dispersão (Figura 5). Em geral as escalas com valores extremos são as escalas extremas (0.5km e 16km de lado), mas em alguns casos em que há estabilização a variação de uma mesma bateria pode fazer com que a média flutue em torno de um patamar, e dessa forma a maior escala (de 16km de lado) não apresenta o valor mínimo em todos os casos (Figura 4).   -->

<!-- # versão para projeto -->

### SADs réplicas

Para cada sítios de observação serão simuladas 100 SADs réplicas por grau de limitação de dispersão e modelo neutro. Pressupondo que os 20 graus de limitação de dispersão são adequados nas paisagens de 4x4km2 serão feitas 1 milhão e 296 mil simulações. As simulações com os 20 graus de limitação de dispersão já foram feitas para os modelos espacialmente explícitos (de paisagem idealizada e contemporânea). Restam os modelos espacialmente implícitos e sem espaço, que estão em desenvolvimento pelo grupo. 

### Comparação SADs réplicas e observadas

Comparamos as SADs preditas com a respectiva SAD observada usando uma versão bootstrap do teste de Kolmogorov-Smirnov (@2samples); consideramos que a SAD predita será congruente se o valor p do teste for superior à 0.05. Por modelo neutro, investigamos a probabilidade de congruência da SAD predita com a observada comparando GLMMs binomiais que incluíram a interação entre polinômios de segundo grau da proporção de cobertura vegetal e do desvio padrão da função de dispersão e também a ausência destas variáveis. Interpretaremos a predição do modelo médio a partir de um modelo cheio selecionado considerando a estrutura fixa e aleatória do GLMM (@Harrison2018)
