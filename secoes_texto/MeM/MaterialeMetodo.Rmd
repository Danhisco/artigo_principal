---
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = FALSE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE,eval=TRUE)
# pacotes adicionais´
library(doMC)
library(readr)
library(gridExtra)
library(ggplot2)
library(tidyr)
library(readr)
library(stringr)
library(plyr)
library(dplyr)
source("source/mapa_p_MNEE.R")
# dados disponíveis
df_dados <- read_csv(file = "dados/df_dados_disponiveis.csv")
df_sim <- read_csv("dados/df_simulacao.csv")
df_plot <- read_csv("dados/csv/df_plotSoE.csv")
df_p_extensoes <- read_csv("dados/csv/df_p_extensoes.csv")
```

```{r trackdown rotine, include=FALSE,eval=FALSE}
# pacotes
library(trackdown)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
upload_file(file="secoes_texto/MeM/MaterialeMetodo.Rmd",
            gpath="mestrado/artigo_principal/secoes_texto/",
            hide_code=TRUE)
update_file(file ="secoes_texto/MeM/MaterialeMetodo.Rmd",
            gpath = "mestrado/artigo_principal/secoes_texto/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file = "secoes_texto/MeM/MaterialeMetodo.Rmd",
              gpath = "mestrado/artigo_principal/secoes_texto/")
```

## Métodos para o 2o Comitê

Aqui comparamos a congruência do predito para a diversidade local de árvores por um modelo mínimo de dinâmica ecológica no equilíbrio (Campos et al. 2012,2013; Thompson et al. 2019) na configuração espacial contemporânea do habitat remanescente na paisagem ao redor (Villard & Metzger 2014; Frazier et al. 2017), com a situação de ausência de isolamento estrutural (Fahrig et al. 2017, 2020; Fletcher Jr et al. 2018; Fahrig et al. 2019; Miller-Rushing et al. 2019), onde todo o habitat remanescente está aglomerado ao redor da parcela. A situação de ausência de perda de habitat na paisagem ao redor foi simulada como referência nula do efeito da perda de habitat (Fahrig et al. 2022). Para cada sítio de amostragem exploramos graus de limitação de dispersão per capita (Chisholm & Lichtenstein 2009?; Campos 2012,2013; Villard & Metzger 2014). O modelo prevê a possibilidade de que o isolamento estrutural da parcela na paisagem possa reduzir o input de espécies vindos da paisagem ao redor e/ou reduzir a erosão de espécies por deriva ecológica (veja Campos et al. 2012, 2013; Condit et al. 2012; May et al. 2012; Thompson et al. 2019). A taxa de colonização de novas espécies na paisagem por evento de nascimento (U, espacialmente aleatória na paisagem) foi ajustada para obter a riqueza observada localmente, dado o número de indivíduos na amostra. O contraste na taxa U estimado entre paisagens hipotéticas pode informar o efeito da perda de habitat per se (contraste entre controle e sem isolamento estrutural) e do efeito da fragmentação per se (contraste entre sem isolamento estrutural e paisagem contemporânea) na manutenção da riqueza local. Esses contrastes informam a dependência de propágulos vindos da paisagem ao redor para repor espécies perdidas localmente. Nos perguntamos se desconsiderar o efeito do isolamento estrutural contemporâneo é suficiente para predizer a distribuição de abundância de espécies (SAD) de árvores observadas em parcelas contíguas na Floresta Atlântica e como a chance relativa de congruência varia em função dos efeitos estimados de área e fragmentação per se ao longo do gradiente de cobertura vegetal observado e graus de limitação de dispersão simulados (Fletcher Jr et al. 2018; Fahrig et al. 2019; Miller-Rushing et al. 2019; Watling et al. 2020; Pütkker et al. 2020). 

### Sítios selecionados

Selecionamos na base de dados TreeCo inventários florestais que amostraram em parcela única pelo menos 1ha de floresta, com alta confiabilidade taxonômica dos indivíduos arbóreos com DBH>=5.0cm e da coordenada central da parcela, totalizando 109 sítios (figura 1). As coordenadas dos sítios variaram entre -31° e -7° de latitude e entre -55° e -35° de longitude (figura 1a). A área amostrada mediana foi de 1 ha; o número de indivíduos amostrado mediano foi de 1540 indivíduos; a riqueza observada mediana foi de 107 espécies; e o ano de amostragem ou publicação mediano foi 2007 (figura 1b). A maioria dos trabalhos ocorreu em áreas de florestas classificadas como primárias no TreeCo (Figura 1c). Os mapas de cobertura vegetal contemporâneos foram recortadas a partir da coleção 6 do mapbiomas (@mapbiomas), usando a coordenada central da parcela e o ano que melhor aproxima a amostragem da SAD (ano da coleta ou da publicação). A resolução dos mapas foi ajustados para que a densidade de pixels seja igual a densidade de indivíduos na parcela. As áreas da parcela e da paisagem foram aproximadas por quadrados. Em uma paisagem não foi possível desenhar uma área quadrado devido à configuração espacial do habitat e foi descartada. 

```{r fig 1 - sitios amostrados e grau de limitação de dispersao,fig.width=12,fig.height=6}
df_plot <- df_dados |> 
  select(SiteCode, effort_ha, Ntotal, S_obs, year_bestProxy, forest_succession, lat:long_correct)
l_p <- list()
l_p[[1]] <- df_plot |> 
  ggplot(aes(y=lat,x=long)) +
  geom_point(alpha=0.5) +
  theme_light() +
  labs(subtitle = "a)")
v_labels <- c("effort_ha" = "plot area (ha)",
              "Ntotal" = "# ind",
              "S_obs" = "riqueza",
              "year_bestProxy" = "approx. data year")
df_plot[grep("\\_",df_plot$year_bestProxy),"year_bestProxy"] <- "2012.5"
l_p[[2]] <- df_plot |>
  mutate(year_bestProxy = as.numeric(year_bestProxy)) |> 
  pivot_longer(effort_ha:year_bestProxy) |> 
  ggplot(aes(x=name,y=value)) +
  geom_jitter(alpha=0.4) +
  geom_boxplot() +
  labs(x="",y="",subtitle="b)") +
  facet_wrap(~name,ncol=1,scales="free", labeller = as_labeller(v_labels), strip.position = "bottom") +
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside") +
  coord_flip()
l_p[[3]] <- df_plot |> 
  ggplot(aes(x=forest_succession)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", vjust = -0.2, colour = "black") +
  labs(x="classificação de estágio sucessional do TreeCo",
       y="countagem",subtitle="c)")
grid.arrange(grobs=l_p,ncol=3)
```

__Figura 1__ Sítios selecionados na base de dados TreeCo. a) latitude e longitude das coordenadas centrais dos inventários florestais. b) boxplot de variáveis dos inventários: área da parcela, número de indivíduos amostrado, riqueza de espécies observado, e ano da amostragem ou da publicação. c) Classificação do estado de conservação ou sucessional da área amostrada no inventário: primary (floresta primária, não-alterada, primitiva, old-growth (≥80 anos de sucessão) ); primary/secondary (floresta em estágio avançado de sucessão (50 a 80 anos de sucessão)); secondary (floresta secundária, alterada, em estágio médio de regeneração (20 a 50 anos de sucessão)); capoeira (floresta em estado inicial de sucessão (<20 anos de sucessão)).

### Modelo neutro e função de dispersão

O modelo neutro espacialmente explícito utiliza uma simulação coalescentes, onde se retrocede no tempo para reconstruir a trajetória de cada indivíduo na área amostral até o primeiro progenitor que surgiu na paisagem, unindo indivíduos de uma mesma espécie em ramos comuns, criando árvores genealógicas da comunidade (@Azaele2016, @Thompson2020). O modelo pressupõe equilíbrio dinâmico na paisagem local. A situação de equilíbrio dinâmico ocorre quando na escala da paisagem as extinções por deriva ecológica são compensadas pela colonização novas espécies por evento de nascimento, descrita pela taxa U (@Azaele2016, @Thompson2020). O modelo pressupõe que apenas um indivíduo pode colonizar uma unidade de habitat por vez e toda morte é reposta pelo surgimento de um indivíduo adulto (pressuposto de soma zero). Por evento de nascimento, há a probabilidade U de que o nascimento seja de uma nova espécie na paisagem. Nos 1-U casos é sorteado um indivíduo presente na paisagem (parcela ou paisagem ao redor) como progenitor. O progenitor é sorteado centralizando a função de dispersão no habitat vago e sorteando posições até obter uma unidade de habitat. Os graus de limitação de dispersão __per capita__ foram modelados com a distribuição de Laplace (exponencial espelhada; @Bullock2017). A posição do progenitor é obtida por dois sorteios ortogonais independentes (@Rosindell2008, @Campos2012). Foram simulados 20 graus de limitação de dispersão variando a proporção de propágulos que permanece até a vizinhança imediata da planta progenitora, a distância até o vizinho imediato (figura 2a). A distância até o vizinho imediato depende da densidade de indivíduos na parcela. 


```{r graus de limitação de dispersão simulados}
df_sim |> 
  mutate(DA = Ntotal / effort_ha,
         k_factor = factor(round(k,2))) |> 
  ggplot(aes(x=k_factor,y=d)) +
  geom_jitter(aes(color=DA)) +
  geom_boxplot() +
  labs(subtitle = "c)",
       y = "disp. kernel sd",
       x = "k") +
  theme_light() +
  theme(legend.position = "top")
```

__Figura 2__ Graus de limitação de dispersão: desvio-padrão da distribuição de laplace (eixo y), e a proporção de propágulos que permanece até a vizinhança imediata (até o vizinho imediato - k, eixo x), quanto menor a densidade de indivíduos (DA) maior a distância entre vizinhos e por isso menor o desvio padrão para obter a mesma proporção de propágulos até a vizinhança imediata.


### Extensão espacial da paisagem

Um desafio para criar os contrastes é definir a extensão espacial da paisagem ao redor (@Jackson2015, @Miguet2017, @Fahrig2021). A extensão espacial da paisagem determina a quantidade máxima de habitat disponível ao redor dos sítios de estudo (figura 3). A análise de escala de efeito (@Jackson2015) propõe que a extensão espacial adequada é aquela que maximiza o peso de evidência da associação estatística entre o padrão de biodiversidade local estudado e a variável de interesse, por exemplo, a proporção de cobertura vegetal na paisagem. Essa abordagem tem sido adotada em diversos trabalhos (@Crouzeilles2016, @Stuber2020). Optamos por não utilizar a análise de escala de efeito, pois ela pressupõe que existe equilíbrio da resposta ecológica à heterogeneidade contemporânea da paisagem. Alternativamente, vamos investigar a extensão mínima da paisagem ao redor para que a construção da árvore genealógica da comunidade não seja restringida pela extensão espacial da paisagem, mas sim pela limitação de dispersão. 

```{r figura 3 p em funcao das extensoes espaciais}
df_p_extensoes |> filter(lado_km<=16.02) |> 
  ggplot(aes(x=lado_km,y=p)) + 
  geom_point(alpha=0.2,size=0.2) +
  geom_line(aes(group=SiteCode),linewidth=0.2,alpha=0.2) +
  labs(x="lado da paisagem quadrada (km)",y="proporção de cobertura vegetal") +
  scale_y_continuous(breaks = seq(0,1,by=0.1)) +
  coord_cartesian(expand = F) +
  theme_light()
```

__Figura 3__ Variação da proporção de cobertura vegetal contemporânea ao evento de amostragem do inventário florestal e a extensão espacial da paisagem ao redor. 

Uma forma de avaliar se a árvore genealógica da comunidade está sendo restringida pela extensão espacial da paisagem é investigar a taxa U (Apêndice: Efeito de Escala). A taxa U necessária para manter a riqueza local compensa o número de espécies perdidas localmente que não são repostas por subpopulações da paisagem (@May2012). Então quando a paisagem é pequena para um grau de limitação de dispersão, a taxa U deve ser elevada para compensar a ausência da chuva de propágulos esperada para aquele grau de limitação de dispersão. Com o aumento da extensão da paisagem a taxa U pode diminuir. Para um determinado grau de limitação de dispersão deve existir uma extensão espacial que acumula a maior parte do efeito de aumentar a escala na contribuição de propágulos para a parcela. Exploramos 6 extensões espaciais das paisagem ao redor que variaram de lado 0.5 km até 16 km. Investivamos paisagens sem perda de habitat para excluir os casos em que a taxa U se estabiliza por conta do isolamento do habitat da parcela em relação ao habitat remanescente na paisagem (@Thompson2019). Sorteamos 36 sítios dos 108 sítios totais, buscamos explorar a amplitude de valores de riqueza de espécies e número de indivíduos. Cada bateria de simulações teve 10 réplicas, totalizando 43 mil e 200 simulações para os 20 graus de limitação de dispersão e 6 escalas (Apêndice Efeito de Escala figura 3). Ajustamos um LMM que considerou a riqueza de espécies e número de indivíduos na escala log, e o grau de limitação de dispersão e a escala como duas variáveis categoricas. Pressupomos que a taxa U estimada na extensão de lado 16 km é referência e avaliamos o efeito de aumentar a escala na média do predito pelo LMM. Definimos como escala adequada aquela escala que acumula 0.95% de toda redução esperada da menor escala de 0.5 km até a maior escala simulada de lado 16 km.

O observado na maior extensão (lado 16 km) é qualitativamente similar ao observado em paisagens infinitas (Apêndice Efeito de Escala, figura 2). Em paisagens infinitas sem perda de habitat a taxa U necessária para manter uma determinada riqueza na parcela apresenta um máximo global quando o grau de limitação de dispersão é pouco brando (@May2012). Em graus de limitação à dispersão severa a taxa U estimada é baixa, pois a perda de espécies é pequena: a maior parte das substituições ocorre entre coespecíficos. Com o relaxamento da limitação de dispersão a perda de espécies aumenta com a redução da substituição de coespecíficos, aumentando a perda de espécies por deriva ecológica. O aumento da erosão de espécies com o aumento da capacidade de dispersão não se mantem sempre, com o aumento da contribuição de supopulações da paisagem mais distante da parcela, reduzindo a estimativa da taxa U.

A extensão espacial mínima adequada aumenta com a redução da limitação de à dispersão (figura 4, detalhes em Apêndice Efeito de Escala). Em k entre 0.99 e 0.90 a extensão espacial da paisagem adequada é de 1 km lado. Em k entre 0.80 e 0.55 não é possível determinar uma tendência de redução da média da estimativa de U; a variação entre escalas para um mesmo sítio em geral é baixa (Apêndice efeito de Escala, figura 4) e a variação entre sítios é grande. Nesses k, o aumento do número de espécies per capita pode levar a divergência da média geral de estabilidade e apresentar padrões não lineares. Os graus de limitação de dispersão com k entre 0.80 e 0.40, onde não foi possível determinar a escala mínima adequada ou há incerteza, são os graus onde o modelo neutro espacialmente explícito opera no máximo global da estimativa média da taxa U (Apêndice Efeito de Escala, Figura 2). Em k entre 0.50 e 0.40 há incerteza entre o lado 1 e 2 km. Em k 0.35 e 0.30 o lado adequado é 2 km e k igual 0.25 é 4 km. Os k entre 0.20 e 0.05 são adequados em paisagens de lado 8 km.  


```{r análise de escala de efeito figura 4}
v_threshold <- paste0("SoE >= ",
                      str_extract(paste(names(df_plot),collapse = " "),
                                  "(?<=SoE\\_)[0-9]{1}[.][0-9]{1,2}")) 
cols <- c("blue","red") # "#f04546","3 quant"=
names(cols) <- c("avg+-sd",v_threshold )
a <- 0.5
df_plot |> 
  ggplot(aes(x=lado_numeric,y=Pre_Umed)) + #,group=k_factor,color=k
  geom_point(alpha=0.40,aes(color=S.N)) +
  geom_line(aes(group=SiteCode,color=S.N),alpha=0.25) +
  scale_color_distiller(palette = "Spectral",name="S / N") +
  new_scale_color() +
  stat_summary(fun.data = mean_se,geom ="line",aes(group=k_factor,color="avg+-sd"),alpha=0.6,size=a) +
  stat_summary(fun = mean,
               fun.min = function(x) mean(x) - sd(x), 
               fun.max = function(x) mean(x) + sd(x), 
               geom = "pointrange",
               aes(x=lado_numeric,y=Pre_Umed,color="avg+-sd"),alpha=0.6,size=a) +
  geom_vline(aes(xintercept=SoE_0.95,color=names(cols)[2]),alpha=0.5) +
  scale_color_manual(name="",values=cols) +
  scale_x_continuous(trans = log2_trans(),
                     breaks = trans_breaks("log2", function(x) 2^x)) +
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
  facet_wrap(~k_factor,ncol=5) +
  theme_classic() +
  labs(title = "Média da estimativa média da taxa U predito pelo LMM:",
       subtitle="logit(Umed) ~ log(S) * log(N) * k * scale + (1|Site)",
       x="scale (landscape side, km)",
       y="avg U rate (Umed)",
       color="") +
  theme(legend.position = "top")
```

__Figura 4__ Média das estimativas médias da taxa U (eixo x) em fução do lado da paisagem ao redor (scale, eixo x). Em azul a média e o desvio padrão para cada combinação de grau de limitação de dispersão (título dos paineis, k = proporção de propágulos que permanece até a vizinhança imediata) e scale. S = número de espécies, N = número de indivíduos. As linhas verticais em vermelho marcam a escala que acumula pelo menos 0.99 de toda a variação da média com o aumento da escala (Ver seção "Escala que acumula a maior parte do efeito da escala").


### Paisagens Hipotéticas

```{r exemplo apresentacao Felipe}
f_image <- \(mat,title){
  image(mat,
        main=title,
        zlim=c(0,2),
        axes=FALSE,
        col=terrain.colors(12,rev = TRUE))
}
#
par(mfrow=c(1,3))
#
path_name <- "dados/simulacao/MGipia1.txt"
m <- read_table(file = path_name) |> as.matrix()
f_image(mat=m,title="Contemporâneo")
# sem frag
m_sem_frag <- f_nonFragLand(m)
f_image(mat=m_sem_frag,title="Sem Isolamento Estrutural")
# idealizado
m_ideal <- m
m_ideal[m_ideal==0] <- 1
f_image(mat=m_ideal,title="Idealizado")
```

__Figura 5__ Paisagens hipotéticas na escala de 4x4km2. Na esquerda a paisagem contemporânea ao evento da amostragem da SAD. No centro, paisagem sem isolamento estrutural, onde aproximadamente todo habitat remanescente está aglomerado ao redor da parcela. Na direita, paisagem idealizada sem perda habitat, situação de satuação de progenitores.


### SADs réplicas: 

Para cada sítios de observação foram simuladas 100 SADs réplicas por grau de limitação de dispersão adequado na extensão de 4x4 km2 e modelo neutro. Comparamos as SADs preditas com a respectiva SAD observada usando uma versão bootstrap do teste de Kolmogorov-Smirnov (@2samples); consideramos que a SAD predita será congruente se o valor p do teste for superior à 0.05. Por modelo neutro, investigamos a probabilidade de congruência da SAD predita com a observada comparando GLMMs binomiais que incluíram a interação entre polinômios de segundo grau da proporção de cobertura vegetal e do desvio padrão da função de dispersão e também a ausência destas variáveis. Interpretaremos a predição do modelo médio a partir de um modelo cheio selecionado considerando a estrutura fixa e aleatória do GLMM (@Harrison2018)
