---
title: "Resultados Completos"
author: "Mori, Danilo"
date: "19/11/2022"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = TRUE,message = FALSE,warning = FALSE,cache=TRUE)
# pacotes
library(dagitty)
library(ggdag)
library(gratia)
library(sads)
library(doMC)
library(metR)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(MuMIn)
library(AICcmodavg)
library(insight)
library(bbmle)
library(DHARMa)
library(mgcv)
library(lme4)
library(gamm4)
library(plyr)
library(dplyr)
source("source/nameModel.R")
source("source/GAMMtools.R")
f_z <- function(x) (x-mean(x))/sd(x)
# Rdata e data frames
load("dados/Rdata/l_md.contrastes.Rdata")
load("dados/Rdata/l_md_congContrastes.Rdata")
load("dados/Rdata/l_md.logOR.Rdata")
load("dados/Rdata/md_frag_area.Rdata")
## df_dados_disponiveis
df_dados_disponiveis <- read_csv(file = "dados/df_dados_disponiveis.csv")
## df_p
df_p <- read_csv("dados/df_p.csv")
## df_resultados 
df_resultados <- read_csv("dados/csv/resultados_MN/df_resultados.csv")
## df_sim
df_sim <- read_csv("dados/df_simulacao.csv")
## df_ad: dados completos, com todos os logOR e as proporções observadas para os 3 e as preditoras
df_ad <- df_resultados |>
  arrange(p) |> 
  inner_join(distinct(select(df_sim,SiteCode,Ntotal:S_obs)),"SiteCode") |> 
  mutate(diffS = (Smed - S_obs)/S_obs)
## df_contrastes: contrastes por sítio e grau de limitação de dispersão
df_contrastes <- read_csv(file="dados/csv/taxaU/df_contrastes.csv") |> 
  inner_join(df_sim |> select(SiteCode,Ntotal:S_obs) |> distinct(),
             by="SiteCode") |> 
  rename(N=Ntotal,S=S_obs) |> 
  mutate(across(N:S,log,.names="log.{.col}"),
         across(c(p,k,log.N:log.S),f_z,.names = "{.col}_z"),
         SiteCode = factor(SiteCode)) |> 
  select(-c(N:log.S))
# df_intePred_contrastes.csv
df_intPred <- read_csv("dados/csv/df_intePred_contrastes.csv")
## df_md: dados necessários para os modelos
df_md <- df_ad |> 
  inner_join(df_contrastes |> 
               select(SiteCode:efeito_conf) |> 
               mutate(across(.cols=c(p,k,contains("efeito")),f_z,.names="{.col}_z")) |> 
               select(-c(p,efeito_area:efeito_conf)) |> 
               pivot_longer(starts_with("efeito_"),names_to="logOR_pair",values_to="contraste_z") |> 
               mutate(logOR_pair = case_when(logOR_pair == "efeito_area_z" ~ "non_frag.ideal",
                                             logOR_pair == "efeito_frag_z" ~ "cont.non_frag",
                                             TRUE ~ "cont.ideal")),
             by=c("SiteCode","k","logOR_pair")) |> 
  mutate(SiteCode = factor(SiteCode),
         land_hyp = factor(land_type))
## df_newdata
df_newpred <- read_csv(file="dados/csv/df_newpred.csv") |> 
  select(-starts_with("log_"))
## df_congContrastetsREP.cvs
df_congContrastes <- read_csv("dados/csv/resultados_MN/df_congContrastes.csv") |> 
  inner_join(df_md |> 
               select(SiteCode,p,k,logOR_pair,contraste_z),
             by=c("SiteCode","k","pair" = "logOR_pair")) |> 
  arrange(p) |> 
  relocate(p,.after=k) |> 
  mutate(SiteCode = factor(SiteCode))
```

```{r trackdown chunk, include=FALSE}
# pacotes
library(trackdown)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
# upload_file(file="secoes_texto/Resultados/Resultados.Rmd",
#             gpath="mestrado/artigo_principal/secoes_texto/",
#             hide_code=TRUE)
update_file(file ="secoes_texto/Resultados/Resultados.Rmd",
            gpath = "mestrado/artigo_principal/secoes_texto/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file = "secoes_texto/Resultados/Resultados.Rmd",
              gpath = "mestrado/artigo_principal/secoes_texto/")
```


# Inventários Florestais Selecionados

As coordenadas dos sítios variaram entre -31° e -7° de latit”ude e entre -55° e -35° de longitude (figura A2 1a). A maioria dos trabalhos foi realizada  em áreas de florestas classificadas como primárias no TreeCo (Figura A2 1c). A área amostrada mediana foi de 1 ha; o número de indivíduos amostrados mediano foi de 1540 indivíduos; a riqueza observada mediana foi de 107 espécies; e o ano de amostragem ou publicação variou entre 1986 e 2016 (Figura A2 1b). Portanto, todos os sítios dentro dos critérios de seleção possuem paisagens contemporâneas na base de mapas de cobertura vegetal do mapbiomas 6. Uma paisagem foi descartada, pois não foi possível delimitar uma área amostral quadrada por conta da particular configuração espacial do habitat remanescente. 

# Efeito de Escalar

Dentre os 36 sítios usados para avaliar o efeito de escalar (Figura A1 1), o observado na maior extensão (lado 16 km) é qualitativamente similar ao padrão médio observado em paisagens infinitas (figura A1 2). Em paisagens infinitas sem perda de habitat a taxa U necessária para manter uma determinada riqueza na parcela apresenta um máximo global quando o grau de limitação de dispersão é pouco brando (@May2012). Em graus de limitação à dispersão severa a taxa U estimada é baixa, pois a perda de espécies é pequena: a maior parte das substituições ocorre entre coespecíficos. Com o relaxamento da limitação de dispersão a perda de espécies aumenta com a redução da substituição de coespecíficos, aumentando a perda de espécies por deriva ecológica. Com o aumento da capacidade de dispersão, há o aumento da contribuição de subpopulações da paisagem mais distante da parcela, reduzindo a estimativa da taxa U.

Na escala do sítio de amostragem o padrão da taxa U estimada difere do padrão médio por apresentar um padrão de patamares (Figura A1 2a e 2b). Nos graus de limitação de dispersão mais severos a taxa U permanece em um valor médio (Figura A1 2b). O máximo global é atingido de forma brusca com a mudança na limitação de dispersão e pode seguir nesse valor máximo por todos os graus de limitação de dispersão simulados nos sítios com os maiores números de indivíduos na parcela (figura A1 2b). O maior relaxamaneto da limitação de dispersão reduz os valores médios da taxa U (figura A1 2). O tamanho dos patamares e a forma com que a redução na taxa U ocorre parece depender de uma relação não trivial entre número de indivíduos e de espécies (figura A1 2b). 

Pressuposto que a extensão espacial da paisagem adequada é aquela que acumula pelo menos 95% de toda diminuição na taxa U observada ao aumentar a extensão espacial de 0.5 km de lado até 16 km de lado (figura A1 5). A extensão espacial adequada tende a aumentar com a redução da limitação de à dispersão (figura A1 5). Quando a proporção de propágulos que permanece até a vizinhança imediata do progenitor (k) varia entre 0.99 e 0.90 a extensão espacial da paisagem adequada é de 1 km de lado (Figura A1 5). Em k entre 0.80 e 0.55 não é possível determinar uma tendência de redução da média da estimativa de U; a variação entre escalas para um mesmo sítio é baixa (figura A1 4). Nesses graus de limitação de dispersão, o aumento do número de espécies per capita pode aumentar a divergência da média geral de estabilidade e apresentar padrões não lineares (Figuras A1 2 e 3). Os graus de limitação de dispersão com k entre 0.80 e 0.55, onde não foi possível determinar a escala mínima adequada ou há incerteza, são os graus onde o modelo neutro espacialmente explícito opera no máximo global da estimativa média da taxa U (Figura A1 2). Em k entre 0.50 e 0.35 a extensão adequada foi de 1 km de lado; entre 0.30 e 0.20, 2 km de lado; e entre 0.15 e 0.05, 4 km de lado (Figura A1 5 e 6). 

# Contrastes entre paisagens hipotéticas

Comparamos as simulações nas 3 paisagens hipotéticas par a par. Avaliamos 2 tipos de contrastes: entre a taxa U estimada; e a congruência nas SADs preditas. Os contraste entre a paisagem contemporânea e a idealizada podem ser compreendidos como o efeito completo da conectividade contemporânea entre parcela e paisagem ao redor na manutenção do padrão avaliado. Os contrastes entre a paisagem contemporânea e sem fragmentação per se podem ser interpretados como o efeito da fragmentação per se, o componente da conectividade contemporânea que depende apenas da configuração espacial do habitat remanescente. Os contrastes entre a paisagem sem fragmentação per se e a idealizada podem ser interpretados como o efeito da perda de área, o componente da conectividade contemporânea que depende apenas da quantia de habitat perdido. Uma vez que a extensão da paisagem ao redor de 4x4km2 é suficiente para simular todos os graus de limitação de dispersão (Apêndice 1 Efeito de Escala), os contrastes entre paisagens contemporâneas e idealizadas são condicionais apenas à escala espacial determinada pelo grau de limitação de dispersão e a configuração espacial do habitat remanescente. A estimativa da taxa U e a SAD predita nas paisagens sem fragmentação per se são condicionais também à extensão espacial de 4x4km2, pois ela é usada como referência para determinar a quantidade de habitat que será aglomerado ao redor da parcela (Figura A1 1). Um conjunto de simulações que não fizemos foi o de usar a menor extensão espacial adequada para cada respectivo grau de limitação de dispersão, assim teríamos simulações também nas extensão de 1x1 km2 e 2x2km2 para alguns graus de limitação de dispersão (Figura A1 6).

## taxa U
Quando há pouca perda de habitat a estimativa da taxa U não difere entre paisagens hipotéticas (Figura A2 2 e 3). Com a redução da cobertura vegetal a estimativa da taxa U pode ser distinta entre paisagens hipotéticas. Em graus de limitação de dispersão mais relaxados pode existir o aumento da taxa U estimada nas paisagem contemporâneas ou sem fragmentação (Figura A2 3). Em geral a taxa U estimada nas paisagens contemporâneas é a maior das três paisagens hipotéticas (Figura A2 3). Em alguns casos a paisagem sem fragmentação per se pode apresentar estimativas superiores (Figura A2 3). Nos graus onde há pouca variação no efeito de escalar (k entre 0.80 e 0.55) também há pouca variação entre paisagens hipotéticas (Figura A2 2 e 3). As diferenças entre paisagens hipotéticas ocorre em geral em graus de limitação de dispersão mais brandos (Figura A2 2 e 3). Em paisagens com baixa proporção de cobertura florestal as estimativas em graus severos de limitação de dispersão também podem ser distintas entre paisagens hipotéticas (Figura A2 2 e 3). 

A distribuição de contrastes apresenta elevada assimetria, com a maioria dos valores próximos do observado em paisagens com pouca perda de habitat e poucos casos distante desta faixa de valores (Figura A2 4). O contraste de fragmentação per se apresentou alguns sítios com valores negativos maiores do que a faixa de valores dos sítios em paisagens com pouca perda de habitat (Figura A2 4). O contraste de área per se apresentou os menores valores em magnitude (Figura A2 4). Os contrastes aumentam com a perda de habitat e com o redução da limitação de dispersão (Figura A2 4). Os GAMMs podem fazer boa predição dos contrastes observados (Apêndice 2, avaliação GAMM 1). O intervalo de predição dos GAMMs informa que o contraste entre paisagens hipotéticas aumenta com a perda de cobertura florestal e redução da limitação de dispersão (Figura X[a]). Os intervalos de predição do contraste de contemporaneidade podem apresentar aumento do contraste em graus de limitação de dispersão severos em paisagens com pouca cobertura vegetal (Figura X).
O GAMM que descreve o contraste de fragmentação per se em função do contraste de área per se não apresenta um boa predição dos valores observados (Figura X+1[b] e Apêndice 2, avaliação GAMM 2). O intervalo de predição sugere que o contraste de fragmentação per se aumenta com o contraste de área per se, porém, em valores diminutos de área per se há diversos valores elevados de fragmentação per se (Figura X+1). 


```{r figura 1 intervalo de predição para os contrastes segundo estimado pelo GAMM,fig.height=8,fig.width=12}
df_plot <- df_intPred |> 
  mutate(p = p_z*sd(df_ad$p) + mean(df_ad$p),
         k = k_z*sd(df_ad$k) + mean(df_ad$k),
         name=factor(name,levels=paste0("efeito_",c("area","frag","conf")))) |> 
  select(-contains("_z"),-predito) |> 
  pivot_longer(starts_with("Q_0."),values_to = "pred",names_to = "label")
df_plot$label <- factor(df_plot$label,levels = unique(df_plot$label)[c(3,2,4,1,5)])
# gráficos
v_range <- range(df_plot$pred)
l_plot <- dlply(df_plot,"name",f_ggplot_PI2d)
p <- grid.arrange(grobs=l_plot,ncol=3)
ggsave("apendices/analise_dados/figuras/FigFinal_contrastes.png",p,
       width = 13,
       height = 9)
```

__Figura 1__ Intervalo de Predição estimado pelos GAMM. 



```{r figura 2 gamm para descreve contraste de frag per se em funcao do contraste de area per se}
# dados
df <- df_md |> 
  filter(logOR_pair == "cont.non_frag") |> 
  rename(frag_z=contraste_z) |> 
  mutate(area_z = df_md |> 
           filter(logOR_pair == "non_frag.ideal") |> 
           pull(contraste_z),
         SiteCode = factor(SiteCode))
df_newpred <- data.frame(area_z = seq(min(df$area_z),max(df$area_z),length.out=200)) |> 
  mutate(SiteCode = "SPigua1")
df_pred_newdata <- f_PredInt.GAMM(data=df_newpred,
                                  gamm=md_frag_area,
                                  v_exclude=c("s(area_z,SiteCode)","s(SiteCode)"))
df$predito <- predict(md_frag_area)
# gráfico
v_devexp <- summary(md_frag_area)$dev.exp
df |> 
  ggplot(aes(x=area_z,y=frag_z)) +
  geom_point(alpha=0.2) +
  geom_line(aes(y=predito,group=SiteCode),alpha=0.2) +
  # geom_line(data=df_pred_newdata,aes(x=area_z,y=predito),color="darkgreen") +
  geom_line(data=df_pred_newdata,aes(x=area_z,y=Q_0.5),color="darkred") +
  geom_line(data = df_pred_newdata |> 
              select(-Q_0.5) |> 
              pivot_longer(starts_with("Q_0.")),
            aes(x=area_z,y=value,group=name),color="darkblue") +
  # scale_y_continuous(limits=range(df$frag_z)) +
  annotate("rect",xmin = -1,xmax=1,ymin=14,ymax=16) +
  annotate("text",x = 0,y = 15,
           label=paste0("dev. exp. = ",round(v_devexp*100,digits = 1),"%*"),color="white") +
  labs(x="z(contraste área per se)",y="z(contraste frag. per se)",
       title="observado e predito pelo modelo completo e sem a variação entre sítios",
       subtitle = "horizontal lines = quantile(x, probs=c(0.95,0.99))",
       caption = "*full model") +
  geom_vline(xintercept = quantile(df$area_z,probs = c(0.95,0.99)),linetype="dashed",alpha=0.3) +
  theme_bw() +
  theme(plot.caption = element_text(hjust=0))
```

__Figura 2__ Intervalo de Predição estimado pelos GAMM. 

## congruência da SAD predita 

```{r tabela 1 selecao dos GAMM mais plausiveis para descrever,cache=TRUE}
df_tab <- ldply(l_md_congContrastes,f_TabSelGAMM)
df_tab
# |> to the final table style
```



```{r figura 3 final GAMM CongContrastes}
l_df <- list.files(path = "./dados/csv",pattern = "df_PIcongCont",full.names = T) |> 
  lmap(~read_csv(.))
names(l_df) <- list.files(path = "./dados/csv",pattern = "df_PIcongCont",full.names = F) |> 
  str_extract("(?<=Cont).+?(?=\\.csv)")


```

__Figura 3__ Congruência da SAD predita entre contrastes: observada e estimada quando se pressupõe ausência de variabilidade entre sítios. 

# SAD observada e SAD predita entre paisagens hipotéticas

## Log Odds Ratio

```{r figura 4 GE logOR contemp em relacao ao sem frag}
geom_final <- \(){
  list(
    geom_point(alpha=0.4),
    geom_quantile(method="rqss",quantiles = c(0.05,0.5,0.95),
                  lambda=0.1,color="darkgreen",linewidth=1.5,alpha=0.5),
    geom_smooth(method="gam"),
    geom_hline(yintercept = 0,color="darkred")
  )
}
l_p <- list()
l_p[[1]] <- df_md |> 
  ggplot(aes(x=contraste_z,y=logOR_value)) +
  geom_final() +
  facet_wrap(~logOR_pair,ncol=3)
l_p[[2]] <- df_md |> 
  pivot_longer(p:k) |> 
  ggplot(aes(x=value,y=logOR_value)) +
  geom_final() +
  facet_grid(name~logOR_pair)
grid.arrange(grobs=l_p,ncol=1)
```

__Figura 4__ Gráficos exploratórios do log odds ratio em função das possíveis preditoras.
  
    
__Tabela 1__ Seleção de GAMM 

```{r tabela 1 de selecao dos GAMM criacao,eval=T,include=FALSE}
f_correcaoNomes <- \(l_md){
  names(l_md) <- str_remove(names(l_md),",ssbs.type") # corrigir na próxima versão de f_nameModel 
  return(l_md)
}
l_md.logOR <- llply(l_md.logOR,f_correcaoNomes)
# não entendo qual o problema...
# Error in get(mnames) : objeto 'l_md' não encontrado
# gambiarra:
l_md <- l_md.logOR[[1]] # gambiarra
df_tabelaSelecao <- ldply(l_md.logOR,\(x) f_TabSelGAMM(l_md=x),.id="pair")
write_csv(df_tabelaSelecao,file="dados/csv/df_tabSel_GAMM_congSADobs.csv")
# ldply(l_md.logOR,f_teste,.id="pair")
# alternativa que funciona normal
# l_df <- list()
# for(i in 1:length(l_md.logOR)){
#   l_df[[i]] <- f_TabSelGAMM(l_md.logOR[[i]])
#   l_df[[i]] <- cbind(pair=names(l_md.logOR)[i],l_df[[i]])
# }
# rbind.fill(l_df)
```
```{r display tabela selecao GAMM cong SADobs}
df_tabelaSelecao <- read_csv("dados/csv/df_tabSel_GAMM_congSADobs.csv") |> as.data.frame()
df_tabelaSelecao
```

```{r figura 5 log odds ratio contrastes intervalo de predicao e observado}
f_SML.gamm <- \(df){md <- l_md.logOR[[df$pair[1]]][[df$modelo[[1]]]]}
l_p <- dlply(df_tabelaSelecao,"pair",f_SML.gamm) |> 
  f_l_mdGAMM_FiguraFinal_1dGAMM()
grid.arrange(grobs=l_p,ncol=3)
```

__Figura 5__ Log Odds Ratio ~ contrastes: intervalo de predição e observado
