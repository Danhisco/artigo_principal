---
title: "Resultados Completos"
author: "Mori, Danilo"
date: "19/11/2022"
output: 
  bookdown::html_document2:
    toc: true
    toc_depth: 5
    fig_caption: yes
  bookdown::pdf_document2:
    fig_caption: yes
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = TRUE,message = FALSE,warning = FALSE,cache=TRUE,
                      fig.align='center',tab.align='center')
# pacotes
library(ggpubr)
library(gt)
library(dagitty)
library(ggdag)
library(gratia)
library(sads)
library(doMC)
library(metR)
library(gridExtra)
library(ggplot2)
theme_set(theme_bw())
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(MuMIn)
library(AICcmodavg)
library(insight)
library(bbmle)
library(DHARMa)
library(mgcv)
library(lme4)
library(gamm4)
library(plyr)
library(dplyr)
source("source/general_tools.R")
source("source/GAMMtools.R")
f_z <- function(x) (x-mean(x))/sd(x)
## df_dados_disponiveis
df_dados_disponiveis <- read_csv(file = "dados/df_dados_disponiveis.csv")
## df_p
df_p <- read_csv("dados/df_p.csv")
## df_resultados 
df_resultados <- read_csv("dados/csv/resultados_MN/df_resultados.csv")
## df_sim
df_sim <- read_csv("dados/df_simulacao.csv")
## df_ad: dados completos, com todos os logOR e as proporções observadas para os 3 e as preditoras
df_ad <- df_resultados |>
  arrange(p) |> 
  inner_join(distinct(select(df_sim,SiteCode,Ntotal:S_obs)),"SiteCode") |> 
  mutate(diffS = (Smed - S_obs)/S_obs)
## df_contrastes: contrastes por sítio e grau de limitação de dispersão
df_contrastes <- read_csv(file="dados/csv/taxaU/df_contrastes.csv") |> 
  inner_join(df_sim |> select(SiteCode,Ntotal:S_obs) |> distinct(),
             by="SiteCode") |> 
  rename(N=Ntotal,S=S_obs) |> 
  mutate(across(N:S,log,.names="log.{.col}"),
         across(c(p,k,log.N:log.S),f_z,.names = "{.col}_z"),
         SiteCode = factor(SiteCode)) |> 
  select(-c(N:log.S))
# df_intePred_contrastes.csv
df_intPred <- read_csv("dados/csv/df_intePred_contrastes.csv")
## df_md: dados necessários para os modelos
df_md <- read_csv("dados/csv/df_md.csv")
## df_newdata
df_newpred <- read_csv(file="dados/csv/df_newpred.csv") |> 
  select(-starts_with("log_"))
## df_congContrastetsREP.cvs
df_congContrastes <- read_csv("dados/csv/resultados_MN/df_congContrastes.csv") |> 
  mutate(SiteCode = factor(SiteCode),
         contrasteSAD_z = ifelse(nCong==500,499.9,nCong),
         contrasteSAD_z = log((contrasteSAD_z/500)/(1-(contrasteSAD_z/500))),
         contrasteSAD_z = f_z(contrasteSAD_z)) |> 
  inner_join(df_contrastes |> 
               pivot_longer(cols=starts_with("efeito"),
                            names_to="pair",
                            values_to="contraste_z") |> 
               mutate(pair = case_when(pair == "efeito_frag"~"cont.non_frag",
                                       pair == "efeito_area"~"non_frag.ideal",
                                       pair == "efeito_conf"~"cont.ideal")) ) |> 
  relocate(contraste_z,.before = contrasteSAD_z)
# themes
basic_theme <- function(data, ...){
  data %>% 
    tab_options(
      table.background.color = "white",
      ...
    )
}
```

```{r trackdown chunk, include=FALSE}
# pacotes
library(trackdown)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
# upload_file(file="secoes_texto/Resultados/Resultados.Rmd",
#             gpath="mestrado/artigo_principal/secoes_texto/",
#             hide_code=TRUE)
update_file(file ="secoes_texto/Resultados/Resultados.Rmd",
            gpath = "mestrado/artigo_principal/secoes_texto/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file = "secoes_texto/Resultados/Resultados.Rmd",
              gpath = "mestrado/artigo_principal/secoes_texto/")
```

# Inventários Florestais Selecionados

As coordenadas dos sítios variaram entre -31° e -7° de latit”ude e entre -55° e -35° de longitude (figura A2 1a). A maioria dos trabalhos foi realizada  em áreas de florestas classificadas como primárias no TreeCo (Figura A2 1c). A área amostrada mediana foi de 1 ha; o número de indivíduos amostrados mediano foi de 1540 indivíduos; a riqueza observada mediana foi de 107 espécies; e o ano de amostragem ou publicação variou entre 1986 e 2016 (Figura A2 1b). Portanto, todos os sítios dentro dos critérios de seleção possuem paisagens contemporâneas na base de mapas de cobertura vegetal do mapbiomas 6. Uma paisagem foi descartada, pois não foi possível delimitar uma área amostral quadrada por conta da particular configuração espacial do habitat remanescente. 


```{r GE-sitios-amostrados,fig.width=12,fig.height=6,fig.cap="Características dos sítios selecionados",cache=TRUE}
load("./dados/Rdata/figA21.Rdata")
grid.arrange(grobs=l_p,nrow=1)
```

__\@ref(fig:GE-sitios-amostrados)__ Sítios selecionados na base de dados TreeCo. a) latitude e longitude das coordenadas centrais dos inventários florestais. b) boxplot de variáveis dos inventários: área da parcela, número de indivíduos amostrado, riqueza de espécies observado, e ano da amostragem ou da publicação. c) Classificação do estado de conservação ou sucessional da área amostrada no inventário: primary (floresta primária, não-alterada, primitiva, old-growth (≥80 anos de sucessão) ); primary/secondary (floresta em estágio avançado de sucessão (50 a 80 anos de sucessão)); secondary (floresta secundária, alterada, em estágio médio de regeneração (20 a 50 anos de sucessão)); capoeira (floresta em estado inicial de sucessão (<20 anos de sucessão)).



# Efeito de Escalar

Dentre os 36 sítios usados para avaliar o efeito de escalar (Figura A1 1), o observado na maior extensão (lado 16 km) é qualitativamente similar ao padrão médio esperado em paisagens infinitas (figura A1 2). Em paisagens infinitas sem perda de habitat a taxa U necessária para manter uma determinada riqueza na parcela apresenta um máximo global quando o grau de limitação de dispersão é pouco brando (@May2012). Em graus de limitação à dispersão severa a taxa U estimada é baixa, pois a perda de espécies é pequena: a maior parte das substituições ocorre entre coespecíficos. Com o relaxamento da limitação de dispersão a perda de espécies aumenta com a redução da substituição de coespecíficos, aumentando a perda de espécies por deriva ecológica. Com o aumento da capacidade de dispersão, há o aumento da contribuição de subpopulações da paisagem mais distante da parcela, reduzindo a estimativa da taxa U.

Na escala do sítio de amostragem o padrão da taxa U estimada difere do padrão médio por apresentar um padrão de patamares (Figura A1 2a e 2b). Nos graus de limitação de dispersão mais severos a taxa U permanece em um valor médio (Figura A1 2b). O máximo global é atingido de forma brusca com a mudança na limitação de dispersão e pode seguir nesse valor máximo por todos os graus de limitação de dispersão simulados nos sítios com os maiores números de indivíduos na parcela (figura A1 2b). O maior relaxamaneto da limitação de dispersão reduz os valores médios da taxa U (figura A1 2). O tamanho dos patamares e a forma com que a redução na taxa U ocorre parece depender de uma relação não trivial entre número de indivíduos e de espécies (figura A1 2b). 

Pressupomos que a extensão espacial da paisagem adequada é aquela que acumula pelo menos 95% de toda diminuição na taxa U observada ao aumentar a extensão espacial de 0.5 km de lado até 16 km de lado (figura A1 5). A extensão espacial adequada tende a aumentar com a redução da limitação de à dispersão (figura A1 5). Quando a proporção de propágulos que permanece até a vizinhança imediata do progenitor (k) varia entre 0.99 e 0.90 a extensão espacial da paisagem adequada é de 1 km de lado (Figura A1 5). Em k entre 0.80 e 0.55 não é possível determinar uma tendência de redução da média da estimativa de U; a variação entre escalas para um mesmo sítio é baixa (figura A1 4). Nesses graus de limitação de dispersão, o aumento do número de espécies per capita pode aumentar a divergência da média geral de estabilidade e apresentar padrões não lineares (Figuras A1 2 e 3). Os graus de limitação de dispersão com k entre 0.80 e 0.55, onde não foi possível determinar a escala mínima adequada ou há incerteza, são os graus onde o modelo neutro espacialmente explícito opera no máximo global da estimativa média da taxa U (Figura A1 2). Em k entre 0.50 e 0.35 a extensão adequada foi de 1 km de lado; entre 0.30 e 0.20, 2 km de lado; e entre 0.15 e 0.05, 4 km de lado (Figura A1 5 e 6). 



<!-- # Contrastes entre paisagens hipotéticas -->

<!-- Comparamos as simulações nas 3 paisagens hipotéticas par a par. Avaliamos 2 tipos de contrastes: entre a taxa U estimada; e a congruência nas SADs preditas. Os contraste entre a paisagem contemporânea e a idealizada podem ser compreendidos como o efeito completo da conectividade contemporânea entre parcela e paisagem ao redor na manutenção do padrão avaliado. Os contrastes entre a paisagem contemporânea e sem fragmentação per se podem ser interpretados como o efeito da fragmentação per se, o componente da conectividade contemporânea que depende apenas da configuração espacial do habitat remanescente. Os contrastes entre a paisagem sem fragmentação per se e a idealizada podem ser interpretados como o efeito da perda de área, o componente da conectividade contemporânea que depende apenas da quantia de habitat perdido. Uma vez que a extensão da paisagem ao redor de 4x4km2 é suficiente para simular todos os graus de limitação de dispersão (Apêndice 1 Efeito de Escala), os contrastes entre paisagens contemporâneas e idealizadas são condicionais apenas à escala espacial determinada pelo grau de limitação de dispersão e a configuração espacial do habitat remanescente. A estimativa da taxa U e a SAD predita nas paisagens sem fragmentação per se são condicionais também à extensão espacial de 4x4km2, pois ela é usada como referência para determinar a quantidade de habitat que será aglomerado ao redor da parcela (Figura A1 1). Um conjunto de simulações que não fizemos foi o de usar a menor extensão espacial adequada para cada respectivo grau de limitação de dispersão, assim teríamos simulações também nas extensão de 1x1 km2 e 2x2km2 para alguns graus de limitação de dispersão (Figura A1 6). -->


# taxa U
<!-- A distribuição de contrastes apresenta elevada assimetria, com a maioria dos valores próximos do observado em paisagens com pouca perda de habitat e poucos casos distante desta faixa de valores (Figura A2 4). Quando há pouca perda de habitat a estimativa da taxa U não difere entre paisagens hipotéticas (Figuras A2, 2 e 3). Com a redução da cobertura vegetal a estimativa da taxa U pode ser distinta entre paisagens hipotéticas. Em graus de limitação de dispersão mais relaxados pode existir o aumento da taxa U estimada nas paisagem contemporâneas ou sem fragmentação (Figura 1). Em geral a taxa U estimada nas paisagens contemporâneas é a maior das três paisagens hipotéticas (Figura A2 3). Em alguns casos a paisagem sem fragmentação per se pode apresentar estimativas superiores (Figura A2 3). Nos graus onde há pouca variação no efeito de escalar (k entre 0.80 e 0.55) também há pouca variação entre paisagens hipotéticas (Figura A2 2 e 3). As maiores diferenças entre paisagens hipotéticas ocorre em graus de limitação de dispersão mais brandos (Figura A2 2 e 3). Em paisagens com baixa proporção de cobertura florestal as estimativas em graus severos de limitação de dispersão também podem ser distintas entre paisagens hipotéticas (Figura A2 2 e 3). Alguns sítios apresentaram contraste de fragmentação per se com valores negativos maiores do que o observado nos sítios em paisagens com pouca perda de habitat (Figura A2 4). O contraste de área per se apresentou os menores valores em magnitude (Figura A2 4).  -->

<!-- Os GAMMs podem fazer boa predição dos contrastes observados (Apêndice 2, avaliação GAMM 1). O intervalo de predição dos GAMMs informa que o contraste entre paisagens hipotéticas aumenta com a perda de cobertura florestal e redução da limitação de dispersão (Figura \@ref{contrastes_pk}). Os intervalos de predição do contraste de contemporaneidade podem apresentar aumento do contraste em graus de limitação de dispersão severos em paisagens com pouca cobertura vegetal (Figura \@ref{contrastes_pk}). -->

```{r ip contrastes ~ p k,fig.height=8,fig.width=12,eval=FALSE,include=FALSE}
df_plot <- df_intPred |> 
  mutate(p = p_z*sd(df_ad$p) + mean(df_ad$p),
         k = k_z*sd(df_ad$k) + mean(df_ad$k),
         name=factor(name,levels=paste0("efeito_",c("area","frag","conf")))) |> 
  select(-contains("_z"),-predito) |> 
  pivot_longer(starts_with("Q_0."),values_to = "pred",names_to = "label")
df_plot$label <- factor(df_plot$label,levels = unique(df_plot$label)[c(3,2,4,1,5)])
# gráficos
v_range <- range(df_plot$pred)
v_breaks1 <- c(-0.2,0,0.2,0.5,1)
f_plot <- function(df){
  f_ggplot <- function(df,facets=2){
  ggplot(df,aes(x=p,y=k,z=pred,fill=pred)) +
    geom_raster() +
    geom_contour(aes(z=pred),
                 size=0.5,color="darkblue",
                 breaks=v_breaks1) +
    geom_text_contour(aes(z=pred),
                      breaks=v_breaks1,
                      label.placer = label_placer_flattest()) +
    scale_fill_gradient2(low="green",
                         mid="red",
                         high="black",
                         midpoint = 0.5,
                         limits=v_range,
                         # round(seq(v_range[1],v_range[2],length.out = 5)[1:4],2)
                         breaks=v_breaks1) +
    scale_y_reverse() +
    theme_classic() +
    guides(fill = guide_colourbar(title = gsub("efeito_","",df$name[1]))) +
    coord_cartesian(expand = FALSE) +
    labs(fill=df$name[1]) +
    facet_wrap(~label,ncol = facets,scales="free")
  }
  l_p <- list()
  l_p[[1]] <- df |> 
    filter(label == "Q_0.5") |>
    f_ggplot() + labs(x="")
  l_p[[2]] <- df |> 
    filter(label != "Q_0.5") |>
    f_ggplot()
  ggpubr::ggarrange(plotlist = l_p,nrow=2, common.legend = TRUE, legend="top")
}
l_plot <- dlply(df_plot,"name",f_plot)
p <- grid.arrange(grobs=l_plot,ncol=3)
ggsave("apendices/analise_dados/figuras/FigFinal_contrastes.png",p,
       width = 13,
       height = 9)
```

<!-- __Figura \@ref{contrastes_pk}__ Intervalo de Predição estimado pelos GAMM.  -->

```{r GE-Urep-sitio-k-land,eval=TRUE,fig.height=30,fig.width=15,fig.cap="Características dos Sítios Selecionados"}
load("./dados/Rdata/figA23.Rdata")
p
```

__\@ref(fig:GE-Urep-sitio-k-land)__ Taxa U estimada em cada sítio nos 20 graus de limitação de dispersão simulados e coloridos pelo tipo de paisagem hipotética. Os sítios estão organizados pela proporção de cobertura vegetal na paisagem de 4x4 km2 (p). Nos rótulos dos paineis há o código do sítio de amostragem, a proporção de cobertura vegetal (p), e a classe do estágio sucessional da área amostrada segundo o TreeCo (\@ref(fig:GE-sitios-amostrados))


# SAD observada e SAD predita entre paisagens hipotéticas

```{r GE-nCong,eval=TRUE,fig.height=30,fig.width=15,fig.cap="nCong por sítio, k, land, forest s"}
df_plot <- df_md |> select(SiteCode:diffS,p_z:k_z) |> 
  inner_join(df_p) |> 
  inner_join(df_dados_disponiveis |> 
               filter(forest_succession != "capoeira") %>% 
               select(SiteCode, forest_succession)) %>% 
  arrange(p) |> 
  mutate(succession = case_when(forest_succession == "primary" ~ "1°",
                                forest_succession == "secondary" ~ "2°",
                                forest_succession == "primary/secondary" ~ "1.5°"),
         label = paste0(SiteCode,", p=",round(p,2)," ,suc=",succession)) %>% 
  select(-succession)
df_plot$label <- factor(df_plot$label,levels=unique(df_plot$label))
#
f_plot <- \(nvresp,
            png_repo = "apendices/analise_dados/figuras/",
            end_name = "_k_land.hyp_site"){
  p <- df_plot %>% 
    ggplot(aes(x=k,y=.data[[nvresp]],color=land_hyp)) +
    geom_point(alpha=0.5) +
    geom_line(alpha=0.5) +
    # geom_smooth(method = "gam",se=FALSE) +
    scale_x_reverse() +
    # scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
    theme_bw() +
    labs(color="landscape hyp.") +
    theme(legend.position = "top",
          axis.text=element_text(size=4.5),
          strip.text = element_text(size = 4.5, margin = margin())) +
    scale_color_manual(values=c("darkred","darkblue","darkgreen"),
                       labels=c("contemporâneo","idealizado","sem fragmentação")) +
    facet_wrap(~label,ncol=5)
  ggsave(paste0(png_repo,nvresp,end_name,".png"),
         plot = p,
         width = 7,height = 30)
  save(p,file=paste0("./dados/Rdata/",nvresp,end_name,".Rdata"))
  return(p)
}
f_plot("nCong")
```

__Figura \@ref(fig:GE-nCong)__ Número de SADs simuladas congruentes com a SAD empírica (eixo y). A classificação da SAD simulada como congruente ocorreu quando a comparação entre SADs segundo um teste de Kolmogorov-Smirnov apresentou p-valor igual ou maior do que 0.05. No eixo x há o grau de limitação de dispersão per capita (k). Os pontos são coloridos pelo tipo de paisagem hipotética pressuposta pela simulação. Os paíneis estão organizados pela proporção de cobertura vegetal na paisagem ao redor de 4x4km2.

```{r ts-re-ncong}
df_ts_re <- read.csv("./dados/csv/df_ts_re_nCong.csv")
df_ts_re %>% 
  gt(caption = "Seleção da Estrutura Aleatória") %>% 
  tab_source_note(source_note = "estrutura fixa do modelo cheio usada em ambos modelos") %>% 
  basic_theme()
```

A estrutura aleatória mais plausível dentre os modelos candidatos é aquela com 1 intercepto por tipo de paisagem hipotética por sítio de amostragem (\@ref(tab:ts-re-ncong)) 


```{r ts-ncong}
df_ts <- read.csv("./dados/csv/df_ts_defesa_congruencias.csv")
df_ts %>% 
  gt(caption = "Seleção da Estrutura Fixa") %>% 
  tab_source_note(source_note = "estrutura aleatória mais plausível usada em todos os modelos")
```

O único modelo plausível é o modelo cheio  \@ref(tab:ts-ncong), que tem como preditoras: proporção de cobertura vegetal (p, variável contínua); forest succession (variável categórica com 3 níveis, ver \@ref(fig:GE-sitios-amostrados)) ;grau de limitação de dispersão (k, variável contínua); e o tipo da paisagem hipotética (land. hyp., com 3 níveis). As variáveis contínuas estão 'z' transformadas. 


```{r estudo dos parametros dos modelos mais plausíveis,eval=FALSE,include=FALSE}
v_path <- formals(f_glmm)$Rdata_path %>% sub("\\/glmm_","",.)
l_md <- list.files(path = v_path,pattern="glmm_l_md_",full.names = TRUE) %>% 
  f_loadll()
df_ts <- read_csv(file="./dados/csv/df_ts_defesa_congruencias.csv")
l_md <- alply(filter(df_ts,dAICc==0),1,
              \(x) l_md[[paste0("l_md_",x$resp_var)]][[paste0(x$md," ")]] )
names(l_md) <- filter(df_ts,dAICc==0) %>% pull(resp_var)
f_coef_glmm <- \(md){
  df_ret <- coef(summary(md)) %>% as.data.frame() %>% mutate(coef = row.names(.)) %>% relocate(coef)
  row.names(df_ret) <- NULL
  return(df_ret)
}
l_df <- llply(l_md,f_coef_glmm)
v_title <- c("Erro na riqueza estimada",
             "Número de SADs simuladas congruentes com a empírica")
l_p <- l_df %>%
  f_gt(.,v_title) %>%
  f_gt_to_ggplot()
save(l_p,file="./dados/Rdata/l_ts_glmm.Rdata")
# gridExtra::grid.arrange(grobs=l_df,layout_matrix=rbind(c(1,1),
#                                                        c(2,2),
#                                                        c(3,3)),
#                         top="Glossário")
```

```{r ts glmm display,cache=FALSE,eval=FALSE,include=FALSE}
vname <- load("./dados/Rdata/l_ts_glmm.Rdata",verbose = T)
get(vname)
```



<!-- ### antigo, util?-->
```{r exemplo tabela,eval=FALSE,include=FALSE}
df_tab <- read_csv("./dados/csv/ts_congCont.csv")
df_tab |> 
  gt(groupname_col = "pair",
     # rowname_col = "modelo",
     rownames_to_stub = F) |> 
  # tab_header(title = "GAMM usados para descrever a congruência na SAD entre contrastes") |> 
  fmt_number(columns = dAICc:dev.expl,decimals = 2, suffixing = TRUE) |> 
  cols_label(dev.expl = "dev. expl.") |> 
  tab_row_group(label = md("<center><b>Sem Fragmentação <i>per se</i> : Idealizado<b/></center>"),
                rows = 5:6) |> 
  tab_row_group(label = md("<center><b>Contemporâneo : Sem Fragmentação <i>per se</i><b/></center>"),
                rows = 3:4) |>
  tab_row_group(label = md("<center><b>Contemporâneo : Idealizado</center></b>"),
                rows = 1:2) |>
  tab_style(style = cell_fill(color = "gray75"),
            locations = cells_row_groups(groups = 1:3)) |> 
  cols_align(align = "right") |> 
  tab_style(style = cell_text(align = "left",
                              weight = "bold"),
            locations = cells_column_labels(columns = modelo:dev.expl)) |> 
  text_case_when(x == "f(contraste_z)" ~ "~ f(contraste U)",
                 x == "f(k_z,p_z)" ~ "~ f(k, p)",
                 .default = "",.locations = cells_body(columns = "modelo")) |> 
  cols_width(modelo ~ px(130),where(is.numeric) ~ px(100))
```
