---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r trackdown rotine, include=FALSE}
# pacotes
library(trackdown)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
upload_file(file="secoes_texto/introducao/MaterialeMetodo.Rmd",
            gpath="mestrado/artigo_principal/secoes_texto/",
            hide_code=TRUE)
update_file(file ="secoes_texto/introducao/MaterialeMetodo.Rmd",
            gpath = "mestrado/artigo_principal/secoes_texto/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file = "secoes_texto/introducao/MaterialeMetodo.Rmd",
              gpath = "mestrado/artigo_principal/secoes_texto/")
```

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = FALSE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE,eval=FALSE)
# pacotes adicionais´
library(doMC)
library(readr)
library(gridExtra)
library(ggplot2)
library(tidyr)
library(readr)
library(stringr)
library(plyr)
library(dplyr)
# dados disponíveis
df_dados <- read_csv(file = "dados/df_dados_disponiveis.csv")
df_sim <- read_csv("dados/df_simulacao.csv")
df_p_extensoes <- read_csv("dados/csv/df_p_extensoes.csv")
```

## Materiais e Método

### Sítios selecionados e cenários de limitação de dispersão

  Selecionamos na base de dados TreeCo inventários florestais que amostraram em parcela única pelo menos 1ha de floresta, com alta confiabilidade taxonômica dos indivíduos arbóreos com DBH>=5.0cm e da coordenada central da parcela, totalizando 109 sítios (figura 1). As coordenadas dos sítios variaram entre -31° e -7° de latitude e entre -55° e -35° de longitude (figura 1a). A área amostrada mediana foi de 1 ha; o número de indivíduos amostrado mediano foi de 1540 indivíduos; a riqueza observada mediana foi de 107 espécies; e o ano de amostragem ou publicação mediano foi 2007 (figura 1b). Os mapas de cobertura vegetal contemporâneos foram recortadas a partir da coleção XX do mapbiomas (REF), tomando a coordenada central da parcela e o ano que melhor aproxima a amostragem da SAD (ano da coleta ou da publicação). A resolução dos mapas foram ajustados para que a densidade de pixels seja igual a densidade de indivíduos na parcela. As áreas da parcela e da paisagem são aproximadas por quadrados. As paisagens idealizadas são obtidas transformanda as unidades de não habitat (matriz) dos mapas contenporâneos em unidades de habitat. Os cenários de limitação de dispersão __per capita__ foram modelados com a distribuição de Laplace (exponencial espelhada) para obter a posição do progenitor por dois sorteios ortogonais independentes (Rosindell et al. 2008, Thompson et al. 2019). Os 20 cenários de limitação de dispersão foram controlados pela proporção de propágulos que permanece até a vizinhança imediata da planta progenitora, a distância até o vizinho imediato. Quanto menor a densidade de indivíduos, maior a distância entre indivíduos; assim o parâmetro que controla o desvio-padrão da distribuição de Laplace diminui com a densidade (figura 1c).

```{r fig 1 - sitios amostrados e cenário de limitação de dispersao}
df_plot <- df_dados |> 
  select(SiteCode, effort_ha, Ntotal, S_obs, year_bestProxy, forest_succession, lat:long_correct)
l_p <- list()
l_p[[1]] <- df_plot |> 
  ggplot(aes(y=lat,x=long)) +
  geom_point(alpha=0.5) +
  theme_light() +
  labs(subtitle = "a)")
v_labels <- c("effort_ha" = "plot area (ha)",
              "Ntotal" = "número de indivíduos amostrado",
              "S_obs" = "riqueza de espécies observada",
              "year_bestProxy" = "ano de amostragem ou publicação")
df_plot[grep("\\_",df_plot$year_bestProxy),"year_bestProxy"] <- "2012.5"
l_p[[2]] <- df_plot |>
  mutate(year_bestProxy = as.numeric(year_bestProxy)) |> 
  pivot_longer(effort_ha:year_bestProxy) |> 
  ggplot(aes(x=name,y=value)) +
  geom_jitter(alpha=0.4) +
  geom_boxplot() +
  labs(x="",y="",subtitle="b)") +
  facet_wrap(~name,ncol=1,scales="free", labeller = as_labeller(v_labels), strip.position = "bottom") +
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside") +
  coord_flip()
l_p[[3]] <- df_sim |> 
  mutate(DA = Ntotal / effort_ha) |> 
  ggplot(aes(x=k,y=d,color=DA,group=k)) +
  geom_jitter() +
  geom_boxplot() +
  labs(subtitle = "c)",
       y = "SD da dist. de Laplace usada na função de dispersão",
       x = "proporção de propágulos até a vizinhança imediata do progenitor") +
  theme_light()
grid.arrange(grobs=l_p,ncol=3)
```

__Figura 1__ Sítios selecionados e cenários de limitação de dispersão simulados. a) latitude e longitude das coordenadas centrais dos inventários florestais. b) boxplot de variáveis dos inventários: área da parcela, número de indivíduos amostrado, riqueza de espécies observado, e ano da amostragem ou da publicação. c) cenários de limitação de dispersão: desvio-padrão da distribuição de laplace (eixo y), e a proporção de propágulos que permanece até a distância imediata (até o vizinho imediato, eixo x), quanto menor a densidade de indivíduos (DA) maior a distância entre vizinhos e por isso menor o desvio padrão para obter a mesma proporção de propágulos até a vizinhança imediata.

### Modelos Neutros

Os modelos neutros utilizam simulações coalescentes, onde se retrocede no tempo para reconstruir a trajetória de cada indivíduo na área amostral até o primeiro progenitor que surgiu na paisagem, unindo indivíduos de uma mesma espécie em ramos comuns, criando árvores genealógicas da comunidade (Azaele et al. 2016, Thompson et al. 2021 Package ref). A abordagem pressupõe que apenas um indivíduo pode colonizar uma unidade de habitat por vez e toda morte é reposta pelo surgimento de um indivíduo adulto (pressuposto de soma zero). A todo evento de nascimento há a probabilidade U de que o nascimento ocorra de uma nova espécie na paisagem. Nos 1-U casos é sorteado um indivíduo presente na paisagem (parcela ou paisagem ao redor) como progenitor. Nos modelos neutros espacialmente explícitos um progenitor é sorteado centralizando a função de dispersão no habitat vago e sorteando posições até obter uma unidade de habitat. Nos modelos espacialmente implícitos, se a posição sorteada está dentro da parcela, então um sorteio é feito entre os indivíduos da parcela para definir o progenitor; caso o sorteio ocorra na paisagem ao redor, então um sorteio é feito entre os indivíduos da paisagem ao redor. Nos modelos sem espaço, sortea-se o progenitor entre os indivíduos remanescentes na paisagem (parcela e paisagem ao redor). Com essa abordagem é possível predizer SADs pressuposto equilíbrio dinâmico na paisagem local, situação onde as extinções de espécies na paisagem por deriva ecológica são equivalentes à colonização de novas espécies na paisagem (descrita pela taxa U). 

### extensão espacial da paisagem ao redor 

  Um desafio para implementar os 6 modelos para descrever a SAD em função da dispersão de indivíduos entre parcela e paisagem local é definir a extensão espacial da paisagem ao redor (Jackson & Fahrig 2015??REFs). A extensão espacial da paisagem determina a quantidade máxima de habitat disponível ao redor dos sítios de estudo (figura 2). Os modelos sem espaço e de espaço implícito requerem que o pool de propágulos da paisagem ao redor seja pré delimitados, portanto precisam de uma extensão ótima (Fahrig 2021/20222 Reply to Sauro 2021/2022 J Biogeo). Os modelos de espaço explícito requerem um tamanho minímo da paisagem ao redor, para que a construção da árvore genealógica da comunidade (glossário, Thompson et al. 2019/2020 Rcoalescent package paper) não seja restringida pela extensão espacial da paisagem, mas sim pela limitação de dispersão. 



A análise de escala de efeito (Jackson & Fahrig 2015) propõe que a extensão espacial adequada é aquela que maximiza o peso de evidência da associação estatística entre o padrão de biodiversidade local estudado e a variável de interesse, por exemplo, a proporção de cobertura vegetal na paisagem. Essa abordagem tem sido adotada em diversos estudos (REF 2018?). Optamos por não utilizar a análise de escala de efeito (Jackson & Fahrig 2015), pois ela pressupõe que existe equilíbrio da resposta ecológica à heterogeneidade contemporânea da paisagem. Outros trabalhos com árvores na Floresta Atlântica utilizam paisagens de até 4 km de diâmetro (Rocha-Santos et al. 2017PlosOne; Püttker et al. 2020ConBio; Lima et al. 2020NatCom), uma argumentação é que a dispersão de propágulos e efeito de borda podem se extender em até 3 km (revisado por Lima et al. 2020NatCom),  

```{r figura 2 p pelas extensões espaciais}
df_p_extensoes |> 
  ggplot(aes(x=lado_km,y=p)) + 
  geom_point(alpha=0.2,size=0.2) +
  geom_line(aes(group=SiteCode),linewidth=0.2,alpha=0.2) +
  labs(x="lado da paisagem quadrada (km)",y="proporção de cobertura vegetal",
       subtitle="Mudança na extensão espacial da paisagem e a proporção de cobertura vegetal") +
  scale_y_continuous(breaks = seq(0,1,by=0.1)) +
  coord_cartesian(expand = F) +
  theme_light()
```

__Figura 2__ Mudança na extensão espacial da paisagem a proporção de cobertura vegetal. Cada ponto representa a proporção de cobertura vegetal (eixo y) para aquela determinada extensão espacial da paisagem ao redor (eixo x), as linhas ligam pontos de um sítio de amostragem. Detalhes do procedimento em SI.

### proposta de avaliação dos cenários de limitação de dispersão adequados 

Para paisagens de 4x4 km2, algum dos 20 cenários de limitação de dispersão simulados pode não ser adequado, ou seja, a árvore genealógica da comunidade pode ser restringida pela extensão espacial e não pela limitação de dispersão? Uma expectativa é que no modelo espacialmente explícito a redução da limitação de dispersão deve aumentar a paisagem local necessária para construir a árvore genealógica da comunidade. Uma forma de avaliar se a árvore genealógica da comunidade está sendo restringida pela extensão espacial da paisagem é investigando a taxa U, pois ela informa indiretamente a contribuição dos propágulos da paisagem ao redor na reposição das espécies perdidas localmente. Se a extensão espacial restringir a árvore genealógica para aquele cenario de limitacao de dispersão, a taxa U deve ser superestimada, pois a contribuição do pool de propágulos da paisagem local deve ser significantemente menor do que a contribuição na situação de paisagem infinita, resultando em aumento da taxa U necessária para manter um valor de riqueza de espécies na parcela. Exploramos paisagens quadradas que variaram de lado 0.5 km até 16 km e sem perda de habitat, para excluir os casos em que a taxa U se estabiliza por conta do isolamento do habitat da parcela em relação ao habitat remanescente na paisagem (Thompson et al. 2019 Eco Let). Vamos pressupor que a maior extensão de 16x16km2 é aproximadamente similar à situação de paisagem infinita para os 20 cenários de limitação de dispersão simulados e usar essa escala como referência.
No modelo espacialmente explícito em paisagens infinitas e sem perda de habitat, espera-se que a taxa U necessária para manter uma determinada riqueza na parcela apresente padrão não linear com o aumento da capacidade de dispersão (May et al. 2011). Em cenários de limitação à dispersão severa a taxa U estimada deve ser pequena, pois a perda de espécies deve ser pequena, uma vez que a maior parte das substituições ocorre entre indivíduos de uma mesma espécie devido à elevada agregação de coespecíficos. Com o relaxamento da limitação de dispersão a perda de espécies deve aumentar ao passo que a substituição de coespecíficos diminui, aumentando a perda de espécies por deriva ecológica. O aumento da erosão de espécies com o aumento da capacidade de dispersão não se mantem sempre, ao passo que outras subpopulações mais distantes da parcela podem repor espécies perdidas localmente, reduzindo a estimativa da taxa U. 
O padrão não linear da taxa U em função da capacidade de dispersão pode ser observado nas simulações feitas nas paisagens de 16x16 km2 (Figura 3 U ~ k, 16x16km2). Estimamos a taxa U nos 20 cenários de limitação de dispersão nas 5 subescalas exploradas (Figura 4). Então comparamos os valores de U estimados em escalas consecutivas, dividindo a diferença do valor de U entre escalas consecutivas pela diferença na amplitude das estimativas para aquele sítio e cenário de limitação de dispersão. 

## Comparação SADs réplicas e observadas

 Para cada sítio, cenário de limitação de dispersão e modelo neutro, simulamos 100 SADs. Comparamos as SADs preditas com a respectiva SAD observada usando uma versão do teste de Kolmogorov-Smirnov; consideramos que a SAD predita era congruente se o valor p do teste era superior à 0.05. Por modelo neutro, investigamos a probabilidade de congruência da SAD predita com a observada comparando GLMMs binomiais que incluíram a interação entre polinômios de segundo grau da proporção de cobertura vegetal e do desvio padrão da função de dispersão e também a ausência destas variáveis.
