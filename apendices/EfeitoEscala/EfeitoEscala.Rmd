---
title: "Efeito de escala"
author: 
  - Danilo Pereira Mori, Laboratório de Ecologia Teórica (IBUSP)
date: "2022-08-20"
output:
  pdf_document:
    latex_engine: xelatex
    extra_dependencies: ["tabu"]
  html_document: default
editor_options:
  chunk_output_type: console
# bibliography: citations.bib
csl: plos.csl
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = FALSE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE,eval=TRUE)
# pacotes
library(lubridate)
library(doMC)
library(raster)
library(bbmle)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr) 
library(tidyr)
library(plyr)
library(dplyr)
# funções
source("source/dinamica_coalescente.R")
source("source/SoE_MNEE.R")
source("source/f_z.R")
# df dados da proporção de cobertura vegetal
df_p <- read_csv("dados/df_p.csv")
# df dados para simulação
df_sim <- read_csv("dados/df_simulacao.csv") |> 
  inner_join(x=df_p,by="SiteCode")
# df_sorteio_sitios
df_sorteio_sitios <- read_csv(file="dados/csv/df_sorteio_sitios.csv") |> 
  select(-d) |> 
  inner_join(x=select(df_sim,SiteCode,d,k),by="SiteCode")
# v_sim_sites: se precisar é só mover as paisagens de volta ou incluir um programa coalescente na outra pasta
## acabei perdendo a mão e deletei as paisagens nulas de ambas situações, mas tudo bem faz mais em mapas_...Rmd
# v_sim_sites <- list.files(path="dados/simulacao",pattern = "_null.txt")
# file.copy(from=paste0("dados/simulacao/",v_sim_sites),
#           to=paste0("dados/paisagens/paisagens_SoE_MNEE/",v_sim_sites))
# file.remove(paste0("dados/simulacao/",v_sim_sites))
# df_SoE
df_Usoe.rep <- read_csv("dados/csv/df_Usoe.csv") |> 
  pivot_longer(cols=`1`:`10`, names_to = "n", values_to = "U") |> 
  inner_join(x=distinct(select(df_sim,SiteCode,effort_ha:S_obs)),by="SiteCode") |> 
  arrange(S_obs,k)
# df_Unull
df_Unull <- df_Usoe.rep |> filter(round(lado_km) == 16) 
# df_Usoe
df_Usoe <- df_Usoe.rep |> 
  arrange(lado_km) |> 
  group_by(SiteCode,k,lado_km) |> 
  summarise(Umed = mean(U),
            Umedian = median(U)) |> 
  mutate(diffU = Umed - Umedian)
f_lag.U <- function(df){
  v_Udiff <- diff(range(df$Umed))
  df$Ulag <- c((df$Umed[1:(nrow(df)-1)] - df$Umed[2:nrow(df)])/v_Udiff,NA)
  df <- df |> mutate(Ulag0 = ifelse(Ulag<0,0,Ulag))
  df$Ucsum <- cumsum(df$Ulag0)
  df <- df |> mutate(Ucsum = ifelse(Ucsum>1,1,Ucsum))
  return(df)
}
registerDoMC(3)
df_Usoe <- ddply(df_Usoe,c("SiteCode","k"),f_lag.U,.parallel = TRUE)
df_Usoe$lado_factor <- factor(df_Usoe$lado_km,labels=c(paste(0.5,"->",16/(2^(4:0))),NA))
df_Usoe$k_factor <- factor(df_Usoe$k,levels = sort(unique(df_Usoe$k),decreasing = T))
# df_resultadoSoE
f_ddply <- function(df){
  df |> 
    filter(Ucsum >= 0.9) |> 
    head(n=1)
}
df_soe90 <- ddply(df_Usoe,c("SiteCode","k"),f_ddply)
df_aud <- anti_join(df_sorteio_sitios,df_soe90,by=c("SiteCode","k")) |> 
  inner_join(df_Usoe,by=c("SiteCode","k")) |> 
  select(-(txt.file:DA))
```

```{r trackdown,eval=FALSE}
library(trackdown)
# 1a vez:
upload_file(file="apendices/EfeitoEscala/EfeitoEscala.Rmd",
            gpath = "mestrado/DaniloPMori-artigo_mestrado/",
            hide_code = TRUE)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
update_file(file ="apendices/EfeitoEscala/EfeitoEscala.Rmd",
            gpath = "mestrado/DaniloPMori-artigo_mestrado/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file ="apendices/EfeitoEscala/EfeitoEscala.Rmd",
              gpath = "mestrado/DaniloPMori-artigo_mestrado/")
```

 
## Introdução

<p> Para comparar os modelos neutros é necessário primeiro determinar a extensão espacial da paisagem ao redor (REF), pois os modelos neutros derivados da HAH (MNEI extremo e brando) requerem que o pool de propágulos da paisagem ao redor seja pré delimitados (Fahrig 2021/20222 Reply to Sauro 2021/2022 J Biogeo) e o modelo neutro derivado de HCH (MNEE) requer paisagem ao redor da parcela suficiente para que a simulação coalescente não seja restringinda pela extensão espacial da paisagem (Thompson et al. 2019/2020 Rcoalescent package paper). Não há consenso em como estimar uma extensão espacial da paisagem ao redor comum às parcelas reunidas para estudo (REF). </p>

<p> 
</p>
<p> Nossa proposta se baseia na taxa U, colonização de novas espécies na paisagem por evento de nascimento, estimada por MNEE para obter a riqueza observada na parcela dado um cenário de limitação à dispersão e mapa de cobertura vegetal. Em paisagens infinitas e sem perda de habitat, espera-se que a taxa U necessária para manter uma determinada riqueza na parcela apresente padrão não linear (May et al. 2011). Em cenários de limitação à dispersão severa a  taxa U estimada deve ser pequena, pois a perda de espécies deve ser pequena, uma vez que a maior parte das substituições ocorre entre indivíduos de uma mesma espécie devido à elevada agregação de coespecíficos. Com o relaxamento da limitação de dispersão a perda de espécies deve aumentar ao passo que a substituição de coespecíficos diminui, aumentando a perda de espécies por deriva ecológica. O aumento da erosão de espécies com o aumento da capacidade de dispersão não se mantem sempre, ao passo que outras subpopulações mais distantes da parcela podem repor espécies perdidas localmente, fazendo com que a perda de espécies local seja parcialmente compensada pela dispersão de propágulos da paisagem ao redor em cenários de limitação de dispersão brandos. Para determinar a extensão espacial adequada da paisagem vamos buscar aquela extensão espacial que não limite a redução da taxa U em cenários de limitação à dispersão brandos. Então vamos pressupor que não há perda de cobertura vegetal na paisagem, desse modo a possível estabilização de U não pode ser resultado do isolamento do habitat da parcela na paisagem.  </p>
<!-- <p> Primeiro vamos avaliar como a estimativa de U varia com a redução da limitação de di
spersão quando a paisagem apresenta a maior extensão considerada (16x16km2) e não há perda de habitat. Dessa forma avaliamos se a maior extensão considerada é suficiente para obter o padrão não linear esperado em paisagens infinitas. E depois vamos selecionar alguns cenários de limitação à dispersão brandos para avaliar como a taxa U varia com a redução da extensão espacial. </p> -->
<!-- <p> Dos 106 sítios selecionados para a comparação dos modelos neutros, 36 foram sorteados e selecionados para avaliar qual a extensão espacial suficiente para comparar os modelos neutros. Esses 36 sítios incluem os extremos da riqueza de espécies e densidade de indivíduos observada e outros 32 sítios sorteados na amplitude de valores dessas duas variáveis (figura 1a). Para cada sítio simulamos 20 cenários de limitação de dispersão (Figura 1b e Figura 2). Então selecionamos 3 cenários de limitação à dispersão mais brandos (Figura 2) para avaliar se alguma sub extensão espacial da paisagem ao redor é suficiente para comparar os modelos neutros. As subescalas avaliadas variaram de 0.5 km de lado até 16 km de lado, totalizando 6 escalas espaciais da paisagem ao redor. Aquela subescala que acumular a maior parte da variação pode ser candidata como extensão espacial da paisagem apropriada para comparar os modelos neutros. </p> -->

```{r figura 1 variaveis de controle e cenarios de limitacao de dispersao,fig.height=4}
df_plot <- df_sim |>
  filter(k==0.05) |> 
  mutate(sorteio_site = ifelse(SiteCode %in% unique(df_Unull$SiteCode),"SoE","non SoE"),
         DA = Ntotal / effort_ha)
l_p <- list()
l_p[[1]] <- df_plot |> 
  ggplot(aes(x=DA,y=S_obs,color=sorteio_site)) +
  geom_point(alpha=0.8) +
  scale_color_manual(values=c("black","red"),name="SoE: 36 sites") +
  labs(x="density (individuals / ha)", 
       y="spp richness",
       title="a) 108 sítios selecionados") +
  theme(legend.position = "bottom")
l_p[[2]] <- df_sim |> 
  ggplot(aes(x=k,y=d,group=k)) +
  geom_jitter() +
  geom_boxplot() +
  labs(x = "k",
       y = "d",
       title = "b) cenários de dispersão")
grid.arrange(grobs=l_p,ncol=2)
```

<p> __Figura 1__ a) Riqueza de espécies e densidade de indivíduos nas parcelas dos 106 sítios selecionados (parcela contígua de pelo menos 1ha). Em vermelho os pontos amostrados e selecionados para investigar a extensão espacial da paisagem ao redor usando MNEE (Scale of Effect, SoE). b) Cenários de limitação de dispersão simulados. k = proporção de propágulos que permanece até a vizinhança imediata (distância média entre indivíduos); d = desvio padrão da função de dispersão com distribuição de Laplace. Para detalhes sobre a seleção dos sítios na base TreeCo e sobre os cenários de limitação à dispersão olhar o texto principal.</p>

```{r figura 2 U para todo k em paisagens nulas na maior escala investigada,fig.width=12,fig.height=7}
df_plot <- df_Unull |> 
  arrange(S_obs) |> 
  mutate(label = paste(SiteCode,S_obs,Ntotal,effort_ha,sep = ", "))
df_plot$label <- factor(df_plot$label,levels = unique(df_plot$label))
df_plot |> 
  ggplot(aes(x=k,y=U)) +
  # geom_line() +
  # geom_smooth(method = "loess",se=F) +
  geom_point(alpha=0.4) +
  stat_summary(geom = "line",fun.data = mean_se) +
  stat_summary(geom = "pointrange",fun.data = mean_se, color="red",size=0.1) +
  stat_summary(geom = "errorbar",fun.data = mean_se, color="red",linewidth=0.5) +
  labs(title = "U estimado por cenário de dispersão em paisagens nulas de lado 16 km",
       subtitle = "label = SiteCode, S, N, plot area(ha); free y axis; reverse x axis") +
  # geom_vline(xintercept = c(0.25, 0.1,0.05),color="red",alpha=0.4) +
  scale_x_reverse() +
  facet_wrap(~label, ncol=6,scales="free_y") +
  theme_classic()
ggsave("apendices/EfeitoEscala/fig2_U16_k.png",
       width = 17.2,
       height = 6.7)
```

<p> __Figura 2__ U estimado (eixo y) por cenário de limitação de dispersão (eixo x) em paisagens sem perda de cobertura vegetal (nulas) na maior extensão espacial (lado de 16 km). Os pontos são as estimativas réplicas de U, os pontos vermelhos marcam o valor médio e a linha une os valores médios entre cenários de limitação de dispersão. Eixo y varia entre paineis e eixo x está reverso. Quanto menor k, maior a capacidade de dispersão, simulada com um kernel de dispersão com decaimento exponencial da probabilidade de colonização com o aumento da distância. S = riqueza da espécie, N = número de indivíduos.</p>




### Taxa U e a variação na extensão espacial da paisagem local

```{r figura 3 Umed por lado da paisagem,fig.width=13,fig.height=8}
df_plot <- df_Usoe.rep |> 
  mutate(DA = Ntotal / effort_ha,
         label = paste(SiteCode,S_obs,Ntotal,round(DA,1),sep = ", "),
         k = round(k,2)) 
df_plot$label <- factor(df_plot$label,levels = unique(df_plot$label))
df_plot |>
  ggplot(aes(x=lado_km,y=U,color=k,group=factor(k))) +
  geom_point(alpha=0.4) +
  stat_summary(geom = "line",fun.data = mean_se) +
  stat_summary(geom = "pointrange",fun.data = mean_se, color="black",size=0.1) +
  scale_x_continuous(trans='log2',breaks = round(16.02/2^(5:0),0)) +
  # scale_color_gradient2(low="red",mid = "green",high = "blue", midpoint = 0.5) +
  scale_color_distiller(palette = "Spectral") +
  theme_gray() +
  # theme(legend.position = "bottom") +
  labs(title = "U estimado em diferentes subescalas da paisagem ao redor para os 20 cenários de limitação de dispersão (k)",
       subtitle="facet label = Site code, riqueza, número de indivíduos ,densidade; free y axis",
       x = "lado da paisagem (km)",
       y = "taxa U estimada") +
  # guides(color = guide_legend(title.position = "right")) + # gostaria de deixar o k para a direita e completar a descição dele, mas não tive tempo para fazer
  theme(legend.position= c(0.57,1.10),
        legend.direction = "horizontal",
        legend.justification='left',
        legend.background = element_rect(fill=alpha('white', 0.1))) +
  facet_wrap(~label,ncol = 6,scales="free_y")
ggsave("apendices/EfeitoEscala/fig3_Uk_ladoKM.png",
       width = 17.2,
       height = 6.7)
```

<p> __Figura 3__ U estimado (eixo y) nas diferentes extensões espaciais (eixo x) e para os 20 cenários de limitação de dispersão (cor dos pontos e linhas). Pontos representam a média de 10 réplicas por bateria de simulação. Eixo y varia entre paineis</p>

<!-- <p> A taxa U estimada apresenta padrão de diminuir com o aumento da extensão espacial da paisagem, apesar de variar entre sítios e cenários de limitação de dispersão (Figura 3). O aumento da limitaçã à dispersão (de k = 0.05 dos propágulos permanece na vizinhança imediata do progenitor para k = 0.25) reduz a sensibilidade ao aumento da extensão espacial, pois para todos os sítios a taxa U no cenário de limitação mais severo é superior ao segundo mais severo e este ao cenário mais brando de limitação de dispersão (Figura 3). Em alguns casos a taxa U estimada no cenário de limitação mais severo tem um perfil similar aos dois mais brandos, enquanto em outros a taxa estabiliza em escalas menores para cenários de limitação mais brandos (Figura 3). A resposta de U em função da variação da escala parece depender também da riqueza de espécies, número total de indivíduos amostrado e da densidade de indivíduos (Figura SI 1 - INCLUIR A AMPLITUDE DE VARIAÇÃO DE U NOMINALMENTE NA LEGENDA).</p> -->

<!-- <p> Para comparar os sítios utilizei um protocolo de transformações na taxa U. O valor médio foi obtido das replicas de uma bateria de simulações. Então, por sítio e cenário de limitação de dispersão, a diferença das médias de escalas consecutivas foi dividida pela diferença entre os valores extremos para o conjunto de todas as escalas (Ulag1). Dessa forma, avaliamos a mudança da taxa U com a variação da escala (Figura 4). De maneira geral, U diminui cada vez menos com a escala, então os valores extremos de U tendem a ser os valores extremos de escala; mas em alguns casos, onde houve a estabilização da taxa U em escalas mais baixas, também houve maior variação de modo que o menor valor podem ser escalas intermedárias (e.g. SPpesmD para k=0.25), apesar de serem valores próximos com os da maior escala (Figura 3). Então o acumulo de Ulag1 em escalas consecutivas pode informar quanta variação na taxa U foi acumulada até determinada escala (Figura 4b).</p>  -->

```{r figura 4 Ucv por k}
df_Usoe |> 
  group_by(SiteCode,k) |> 
  summarise(Ucv = sd(Umed)*100/mean(Umed)) |> 
  ggplot(aes(x=k,y=Ucv, group=k)) +
  geom_jitter() +
  geom_boxplot() +
  labs(x="k, prop. de propágulos até a vizinhança imediata",
       y="Coef. Var. de Umed (%)",
       title="Variação da média de U considerando todas as escalas")
```

__Figura 4__ Coeficiente de variação (sd/mean) de Umed (eixo y) para um mesmo cenário de limitação de dispersão (eixo x) e sítio, considerando todas as escalas. 




```{r figura 5 Ucumulative,fig.height=8,fig.width=8}
# gráficos
# plot(density(na.omit(df_U$Ulag)))
# l_p <- list()
# l_p[[1]] <- df_U |>
#   drop_na() |>
#   filter(Ulag>=0) |> 
#   ggplot(aes(x=k_factor,y=Ulag)) +
#   geom_ji() +
#   geom_boxplot() +
#   labs(x = "k",
#        y="U_i - U_i+1 / diff(range(U))",
#        title="a) Ulag") +
#   facet_wrap(~lado_factor,nrow=1)
# l_p[[2]] <- 
  df_Usoe |>
  drop_na() |>
  ggplot(aes(x=lado_factor, y = Ucsum, 
             group=interaction(k_factor,lado_factor))) +
  geom_jitter() +
  geom_boxplot(aes(color=k)) +
  geom_hline(yintercept = 0.9,color="red",alpha=0.6) +
  ## na próxima versão do gráfico a idea é:
  # stat_summary(aes(group=interaction(k_factor,lado_factor)),
  #              geom = "ribbon",fun.data = mean_se, color="green",alpha=0.4) +
  # stat_summary(aes(group=interaction(k_factor,lado_factor)),
  #              geom = "line",fun.data = mean_se,color="green") +
  labs(x="mudança de escala",
       y="Ucsum",
       title="U_breadth = diff(range(Umed)); Ulag = (U_i - U_i+1) / U_breadth; Ucs = cumsum(Ulag) ,Ulag e Ucs são forçados a c [0,1]*") +
  theme_classic()
  # facet_wrap(~k_factor,ncol=3)
# ggsave("apendices/EfeitoEscala/fig4_Ucs.png",
#        width = 17.2,
#        height = 6.7)
# grid.arrange(grobs=l_p,nrow=2)
```

<p> __Figura 5__ O efeito de escala acumulado entre escalas consecutivas. 
<!-- No conjunto de paineis em 'a' os valores calculados para cada mudança de escala, em 'b' o valor acumulado. Os subpainíeis estão dividos pelo cenário de limitação de dispersão.</p> -->


```{r figura 6 1a escala que acumula pelo menos 90% do efeito de escala,eval=FALSE}
df_soe90 |> 
  mutate(fst_scale90 = as.numeric(str_extract(lado_factor,"[0-9.]+$"))) |> 
  ggplot(aes(x=k,y=fst_scale90,group=k)) +
  geom_point(alpha=0.1,size=2) #+
  # geom_boxplot()
```

<!-- __Figura 6__ Primeira escala que acumula pelo menos 90% do efeito da escala -->

<!-- <p> Quanto maior a dupla de escalas consecutivas menor o valor de Ulag1, apesar de existir variação entre cenários de limitação de dispersão (figura 4). A amplitude de valores de Ulag1 aumenta com a limitação de dispersão (figura 4a), por exemplo, nas simulações em que k=0.25 a primeira mudança de escala (de 0.5 km para 1 km) pode variar entre 80% e 30% de toda a variação da taxa U com o aumento da escala; enquanto para k=0.10 e 0.05 essa mudança de escala representa em geral até 40% de variação na taxa U (Figura 4a). O Ulag1 acumulado dos cenários mais brandos de limitação (k=0.10 e 0.05) chega aos 90% quando passamos para a escala de 8 km (Figura 4b); enquanto no cenário de limitação mais brando esse valor pode ser observado quando passamos para a escala de 4 km, com mais da metade dos sítios, ou de 2 km, com menos de um quarto dos sítios (Figura 4b).</p> -->

<!-- ## Discussão -->
<!-- IDEIAS: -->
<!-- - Na maior extensão espacial considerada da paisagem local (16x16km2) observamos um padrão que é qualitativamente similar ao esperado em paisagens infinitas (May et al. 2011), assim pressupomos que a maior extensão espacial é a referência de menor valor da taxa U para uma determinada bateria de simulações (cenário de limitação de dispersão, riqueza de espécies, número de indivíduos na parcela e densidade de indivíduos na paisagem). -->
<!-- - Dado a natureza não truncada da função de dispersão, a extensão espacial da paisagem que estabiliza a taxa U estimada em cenários de limitação de dispersão muito brandos (e.g. k=0.05) pode ser superior à maior extensão simulada (16x16km2) - aqui não fizemos essa avaliação, porém em todos os sítios a taxa de U no cenário mais brando está na mesma ordem de magnitude do primeiro cenário, possibilitando o padrão não linear.   -->
<!-- - A riqueza de espécies, número de indivíduos na parcela e densidade de indivíduos na paisagem influencia na magnitude da estimativa de U e da variação de U em função da limitação de dispersão e da extensão espacial da paisagem (Figuras 2, 3 e 4). -->
<!-- - Nosso método para avaliar a extensão espacial que acumula a maior variação da taxa U, padroniza a amplitude de valores de um sítio como diferença total para aquela sítio, possibilitando a comparação de sítios com diferentes amplitudes de valores.  -->



<!-- - Outros trabalhos na Floresta Atlântica utilizam a extensão espacial de cerca de 4x4 km2. Nessa escala observamos que a taxa U pode ser superestimada em até 20% (quando comparado com paisagens de 16x16 km2) no cenário de maior capacidade de dispersão (k=0.05), por conta da restrição espacial da paisagem ao redor. Esse efeito deve ser observado em paisagens com pouca perda de habitat e bem funcionalmente conectados. A superestimava da taxa U na escala de 4x4 km2 compensa a redução da contribuição de propágulos para a reposição de espécies perdidas localmente que estariam presentes em paisagens de 16x16 km2 -->



### Support Information

```{r figura SI 1 amplitude de U em funcao das variaveis de controle Sobs e DA,fig.height=3,fig.width=8,eval=F,include=F}
df_Usoe$k_factor <- factor(round(df_Usoe$k,2))
l_p <- list()
l_p[[1]] <- df_Usoe |> 
  ggplot(aes(x=S_obs,y=Umed,color=DA)) +
  geom_smooth(method="lm",se=F) +
  geom_line(aes(group=SiteCode),alpha=0.4) +
  geom_point(size=2,aes(shape=k_factor))
l_p[[2]] <- df_Usoe |> 
  ggplot(aes(x=DA,y=Umed,color=S_obs)) +
  geom_smooth(method="lm",se=F) +
  geom_line(aes(group=SiteCode),alpha=0.4) +
  geom_point(size=2,aes(shape=k_factor))
grid.arrange(grobs=l_p,ncol=2)
```

<!-- <p> __Figura SI1__ Amplitude da taxa U estimada em função da densidade de indivíduos (DA) e da riqueza de espécies (S_obs). </p> -->


<!-- ## Códigos para estimar U nas diferentes extensões espaciais -->

<!-- <p>Olhar source/SoE_MNEE.R para os códigos que estimam U para diferentes extensões espaciais.</p> -->

```{r codigos para estimar U para uma mesma extensao espacial e diferentes k,eval=FALSE}
# usado para estimar o U para uma determinada
setwd("dados/simulacao")
f_siteU <- function(df,replicas=4,csv.repo="../csv/U_nullLand_16km/"){
  l_dfU <- list()
  for(i in 1:nrow(df)){
    v_U <- replicate(n=replicas,f_simU(df = df[i,]))
    l_dfU[[i]] <- cbind(select(df[i,],-(txt.file:DA)),matrix(v_U,nrow = 1))
  }
  df_write <- rbind.fill(l_dfU)
  write_csv(df_write,file = paste0(csv.repo,df$SiteCode[1],".csv"))
}
registerDoMC(2)
df_sorteio_sitios$txt.file <- gsub(".txt","_null.txt",df_sorteio_sitios$txt.file)
d_ply(df_sorteio_sitios,"SiteCode",f_siteU,.parallel = TRUE)
```

```{r codigos para estimar U SoE, eval=FALSE}
setwd("dados/simulacao")
df_sorteio_sitios$txt.file <- gsub(".txt","_null.txt",df_sorteio_sitios$txt.file)
df_se <- df_sorteio_sitios # |> filter(k %in% unique(df_sim$k)[c(16,19)]) # para seleção de alguns cenários
registerDoMC(3)
a_ply(df_se[-1,],1,f_SoE_MNEE_null,.parallel = TRUE)
##
df_sitios_2lote <- data.frame(path.file = list.files("../csv/SoE",".csv",full.names = T)) |>
  mutate(ctime = as.Date(file.info(path.file)$ctime),
         SiteCode = str_extract(path.file,"(?<=E\\/).*?(?=\\_k)"),
         k = as.numeric(str_extract(path.file,"(?<=\\_k).*?(?=\\.csv)")),
         label = paste(SiteCode, k/100)) |>
  filter(ctime>"2023-01-02")
df_se2 <- df_sorteio_sitios |> 
  mutate(label = paste(SiteCode, round(k,2))) |>
  anti_join(select(df_sitios_2lote,SiteCode:label),by="label") |> 
  select(-label)
registerDoMC(2)
a_ply(df_se2,1,f_SoE_MNEE_null,.parallel = TRUE)
#
df <- df_se |> filter(SiteCode == "PRrico3",k==unique(df_se$k)[3])

```

Em alguns sítios não foi possível simular a extensão de 0.5 km para nenhum cenário de dispersão. Nesse extensão espacial, a parcela corresponde à 0.64 da área da parcela, ta certo isso?

o erro informado é:
A practical cause to "corrupted size vs. prev_size" is quite simple - memory chunk control structure fields in the adjacent following chunk are being overwritten due to out-of-bounds access by the code. if you allocate x bytes for pointer p but wind up writing beyond x in regards to the same pointer, you might get this error, indicating the current memory allocation (chunk) size is not the same as what's found in the next chunk control structure (due to it being overwritten).


```{r arrumando os dados do SoE para k05,eval=FALSE}
v_csv.path <- list.files(path = "dados/csv/SoE", pattern = "_null.csv",full.names = T)
v_k <- unique(df_sim$k)
f_csv <- function(path.csv){
  df <- read_csv(path.csv)
  df$k <- v_k[20]
  df <- cbind(df[,c(1:2,7)],df[,3:6])
  file.remove(path.csv)
  write_csv(df,file = gsub("null",paste0("k",v_k[20]*100),path.csv))
}
v_logical <- sapply(v_csv.path[-1],f_csv)
system("du -s dados/csv/SoE/")
```

```{r df sorteios sitios, eval=FALSE}
df_sorteio_sitios <- df |> 
  filter(S_obs %in% sample(size = 15,df$S_obs) | DA %in% sample(size = 15,df$DA)) |> 
  rbind(filter(df,S_obs %in% range(df$S_obs) | DA %in% range(df$DA))) |>  distinct()
write_csv(df_sorteio_sitios,file = "dados/csv/df_sorteio_sitios.csv")
```


