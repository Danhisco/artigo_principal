---
title: Determinação da extensão espacial da paisagem local
authors:
  - name: Danilo Pereira Mori
    affiliation: LET - IBUSP
# bibliography: references.bib
# biblio-style: unsrt
# output: rticles::arxiv_article
output: html_document
editor_options: 
  chunk_output_type: console
---

## Introdução

<p> Aqui determino a extensão espacial da paisagem local ao redor da parcela amostrada usando a análise de escala de efeito (REF). A análise de escala de efeito se baseia em determinar a extensão espacial da paisagem local que maximiza o peso de evidência da regressão entre o número de espécies na parcela e a proporção de cobertura vegetal dos 109 sítios de amostragens selecionados na base TreeCo. Primeiro calculamos a proporção de cobertura vegetal para paisagens locais quadradas em que variamos a extensão espacial da paisagem. Fizemos uma sequência de extensões espaciais somando 0.12 km no lado da paisagem. A menor paisagem apresentou 0.3km de lado,  aproximadamente o lado da maior parcela caso ela fosse quadrada (área de  10.24 ha, lado de 0.32 km). E a maior extensão espacial apresentou 22.26 km de lado. Ao todo foram 184 extensões espaciais. Então é calculado o peso de evidência da regressão para cada extensão espacial. Aquela extensão que atribuir maior peso de evidência será selecionada para determinar a extensão espacial da paisagem local.</p>  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = FALSE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE,eval=TRUE)
# pacotes
library(doMC)
library(raster)
library(bbmle)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(plyr)
library(dplyr)
select <- dplyr::select
# dados
getwd()
df_dados <- read_csv(file = "./dados/df_dados_disponiveis.csv") |> 
  mutate(year_bestProxy = ifelse(is.na(year_data),year,year_data),
         tif.path = list.files(path="./dados/paisagens_mapbiomas6_padronizadas/",pattern = ".tif",full.names=T)) |> 
  select(SiteCode,effort_ha,year_bestProxy,Ntotal,S_obs,tif.path)
```

### calcular a proporção de cobertura vegetal para cada extensão espacial

```{r calcular a prop CV para cada extensão espacial,eval=FALSE}
f_pEscalas <- function(df){
  df_p <- data.frame(p = NA, lado_km = NA)
  m_full <- raster(df$tif.path) |> raster::as.matrix()
  i_centro <- nrow(m_full)/2
  v_last_i <- (i_centro-5+2)/2
  for(i in 1:v_last_i){
    v_add <- 5+2*(i-1)
    m_i <- m_full[(i_centro+1-v_add):(i_centro+v_add),
                  (i_centro+1-v_add):(i_centro+v_add)]
    df_p[i,] <- c(length(m_i[m_i==1])/length(m_i),
                  nrow(m_i) * 30/1000)
  }
  df_p$SiteCode <- df$SiteCode
  return(df_p)
}
registerDoMC(3)
df_pEscalas <- adply(df_dados,1,f_pEscalas,.id = "SiteCode",.parallel = TRUE)
write_csv(x = select(df_pEscalas,Ntotal,S_obs,p:SiteCode),
          file = "./dados/csv/df_EscalaEfeito.csv")
```

### Ajustar os modelos para um mesmo lado_km

S_obs = riqueza observada na parcela;  
  
p = proporção de cobertura vegetal;  
  
Ntotal = número de indivíduos vivos na parcela;  
  

```{r 2o passo}
df_se <- read_csv("./dados/csv/df_EscalaEfeito.csv")
f_glm.nb <- function(data_){
  md_ <- MASS::glm.nb(S_obs ~ p + I(p^2) + I(p^3) + offset(log(Ntotal)), data = data_)
}
registerDoMC(3)
l_md <- dlply(df_se,"lado_km",f_glm.nb,.parallel = TRUE)
```

### Calcular o peso de evidência por lado da paisagem local (km)

```{r 3o passo,results='hide'}
df_averageSE <- print(AICctab(l_md,weights=TRUE),min.weight=10^(-10)) %>% 
  as.data.frame()
df_averageSE$lado_km <- row.names(df_averageSE) %>% as.numeric()
df_averageSE$weight <- as.numeric(as.character(df_averageSE$weight))
df_averageSE$dAICc <- as.numeric(as.character(df_averageSE$dAICc))
```
  
    
### Selecionar o lado da paisagem local que atribuiu maior peso de evidência

```{r 4o passo,echo=FALSE}
v_lado_max_weight <- df_averageSE |> filter(weight==max(df_averageSE$weight)) |> pull(lado_km)
df_averageSE |> 
  ggplot(aes(x=lado_km,y=weight)) +
  geom_line() +
  labs(title = paste0("O maior weight foi no maior lado = ",v_lado_max_weight,"km"))
```


### Avaliação

```{r figura p por lado da paisagem,echo=FALSE,fig.width=10,fig.height=6}
# df_se |> 
#   mutate(log_SN = log(S_obs/Ntotal)) |> 
#   filter(lado_km == max(df_se$lado_km)) |> 
#   ggplot(aes(x=p,y=S_obs,color=lado_km)) +
#   geom_point(alpha=0.4) #+
  # geom_line()
  # geom_smooth(aes(group=lado_km),method = "lm", formula = "y ~ x+x^2",se=FALSE)
l_p <- list()
l_p[[1]] <- df_se |>
  group_by(lado_km) |> 
  summarise(var_p = var(p)) |> 
  ggplot(aes(x=lado_km,y=var_p)) +
  geom_point() + labs(y="var(p)")
l_p[[2]] <- df_se |> 
  ggplot(aes(x=lado_km,y=p)) + 
  geom_point(alpha=0.4,size=0.4) +
  geom_line(aes(group=SiteCode),size=0.4) +
  scale_y_continuous(breaks = seq(0,1,by=0.1))
v_levels <- df_se |> 
  group_by(SiteCode) |> 
  summarise(p_change=max(p) - min(p)) |> 
  arrange(p_change) |> pull(SiteCode)
l_p[[3]] <- df_se |> 
  ggplot(aes(x=SiteCode,y=p)) +
  geom_point(aes(color=lado_km),alpha=0.3,size=0.4) +
  scale_x_discrete(limits=v_levels) + theme(axis.text.x = element_blank(),axis.ticks.x = element_blank())
grid.arrange(grobs=l_p,ncol=1,top="%CV (p) em função da mudança do lado da paisagem",
             layout_matrix=rbind(c(NA,NA,1,1,NA,NA),
                                 c(2,2,2,3,3,3),
                                 c(2,2,2,3,3,3)))
```

__Figura 1__ Proporção de cobertura vegetal (%CV) em relação ao lado da paisagem (lado_km). SiteCode = código da paisagem. 


