---
title: Determinação da extensão espacial da paisagem local
authors:
  - name: Danilo Pereira Mori
    affiliation: LET - IBUSP
# bibliography: references.bib
# biblio-style: unsrt
# output: rticles::arxiv_article
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = FALSE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE,eval=TRUE)
# pacotes
library(doMC)
library(raster)
library(bbmle)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(plyr)
library(dplyr)
# df dados para simulação
df_sim <- read_csv("dados/df_simulacao.csv")
# df_se_completa e df_se
df_se_completo <- read_csv("./dados/csv/df_p_extensoes.csv")
df_se <- data.frame(txt.file = list.files(path = "dados/simulacao",pattern = ".txt"),
                    SiteCode = str_extract(list.files(path = "dados/simulacao",pattern = ".txt"),".*?(?=.txt)")) |> 
  inner_join(select(filter(df_sim,k==0.05),SiteCode,d,S_obs),by="SiteCode")
  # |> select(SiteCode, lado_km, p, Ntotal, S_obs,d,txt.file)
# função que encapsula o programa coalescente em C++
source(file = "source/dinamica_coalescente.R")
```
 
## Introdução

<p> Busco Determinar a extensão espacial da paisagem local ao redor da parcela amostrada. Comparo duas abordagens. Primeiro, estimarei a taxa U no cenário de limitação à dispersão __per capita__ mais brando em 6 paisagens (a com menor perda de habitat e as 5 com maior perda). Esse método será usado para determinar aquela extensão espacial em que o valor de U para de reduriz. A extensão espacial que estabilizar a estimativa de U indica que a maior porção de contribuição dos indivíduos da paisagem ao redor à chuva de propágulos que pode repor a diversidade local foi atingida. Por conta do pressuposto de soma zero de MNEE, ou seja, toda morte é reposta por um nascimento, dessa forma a probabilidade das unidades de matriz serem sorteadas como parentais é redistribuída para as unidades de habitat remanescente. Então esparamos que a extensão espacial da paisagem ao redor que irá estabilizar a estimativa de U no cenário de limitação à dispersão mais brando deve ser maior quanto menor a proporção de cobertura vegetal. Assim, as paisagens de menor proporção de cobertura vegetal devem indicar extensão espacial suficiente em valores superiores à da paisagem com maior proporção de cobertura vegetal. Segundo, faço a análise de escala de efeito como proposto por Jackson & Fahrig (2015), utilizarei a abordagem mais comum - apesar das limitações (REF), em que se estima aquela extensão espacial que maximiza o peso de evidência da regressão binomial negativa da riqueza local pelo polinômio de terceiro grau da cobertura vegetal e do log do número de indivíduos. PUtkker et al (2020) em análise similar para a Floresta Atlântica encontrou a extensão espacial de cerca de 4x4km. As duas abordagens pressupõe que a paisagem ao redor é a área que pode fornecer propágulos para a paisagem ao redor com maior frequência (REF ECO LET), porém a primeira abordagem pressupõe explicitamente a dinâmica ecológica idealizada usada para comparar as hipóteses investigadas, enquanto a segunda utiliza outro arcabouço teórico. Assim, Optei por não usar a análise de escala de efeito para determinar a escala espacial da paisagem ao redor para comparar as hipóteses investigadas.</p>

### Como a proporção de cobertura vegetal varia com a extensão espacial da paisagem?


```{r figura p por lado da paisagem,echo=FALSE,fig.width=10,fig.height=6}
l_p <- list()
l_p[[1]] <- df_se_completo |>
  group_by(lado_km) |> 
  summarise(var_p = var(p)) |> 
  ggplot(aes(x=lado_km,y=var_p)) +
  geom_point(size=0.4,alpha=0.4) + labs(y="var(p)")
l_p[[2]] <- df_se_completo |> 
  ggplot(aes(x=lado_km,y=p)) + 
  geom_point(alpha=0.2,size=0.2) +
  geom_line(aes(group=SiteCode),size=0.2,alpha=0.2) +
  scale_y_continuous(breaks = seq(0,1,by=0.1))
v_levels <- df_se_completo |> 
  group_by(SiteCode) |> 
  summarise(p_change=max(p) - min(p)) |> 
  arrange(p_change) |> pull(SiteCode)
l_p[[3]] <- df_se_completo |> 
  ggplot(aes(x=SiteCode,y=p)) +
  geom_point(aes(color=lado_km),alpha=0.3,size=0.2) +
  scale_x_discrete(limits=v_levels) + theme(axis.text.x = element_blank(),axis.ticks.x = element_blank())
grid.arrange(grobs=l_p,ncol=1,top="%CV (p) em função da mudança do lado da paisagem",
             layout_matrix=rbind(c(NA,NA,1,1,NA,NA),
                                 c(2,2,2,3,3,3),
                                 c(2,2,2,3,3,3)))
```

__Figura 1__ Como a proporção de cobertura vegetal varia com a extensão espacial da paisagem ao redor?


Primeiro calculamos a proporção de cobertura vegetal para paisagens locais quadradas em que variamos a extensão espacial da paisagem. Fizemos uma sequência de extensões espaciais somando 0.12 km no lado da paisagem inicial. A menor paisagem apresentou 0.3km de lado,  aproximadamente o lado da maior parcela caso ela fosse quadrada (área de  10.24 ha, lado de 0.32 km). E a maior extensão espacial apresentou 22.26 km de lado. Ao todo foram 184 extensões espaciais. Esse conjunto de dados foi usado na análise de escala de efeito. Para A determinação da extensão espacial com MNEE utilizamos 6 extensões espaciais (lado da paisagem em km: `r round(16.02/(2^0:5,2)`).</p>  


# Support Information


## Códigos para estimar U nas diferentes extensões espaciais

```{r codigos para estimar U, eval=FALSE}
setwd("dados/simulacao")
registerDoMC(3)
df_U <- adply(df_se,1,f_SoE_MNEE,.id = "SiteCode",.parallel = TRUE)
write_csv(df_U,file="../csv/df_Urep.csv")
```





## Códigos para análise de escala de efeito

Essa abordagem apresenta alguns problemas pois não ocnsidera: a colinearidade dos valores de p entre lados da paisagem e a autocorrelação espacial entre sítios próximos (REF). Contudo, essa ainda é a abordagem mais executada (REF) e foi usada aqui para comparar com a seleção da escala de efeito que fizemos via simulação de MNEE.



#### Análise exploratória variáveis primárias: S_obs e Ntotal

```{r análise exploratória variáveis primárias Sobs e Ntotal,echo=FALSE}
df_dados |> 
  ggplot(aes(x=Ntotal,y=S_obs)) + 
  # geom_smooth() +
  geom_point(alpha=0.5) + 
  labs(title="S_obs = Riqueza observada; Ntotal = total indivíduos")
```

__Figura 1__ Análise exploratória variáveis primárias: riqueza observada (S_obs) e número total de indivíduos (Ntotal)

### 1o Passo: calcular a proporção de cobertura vegetal para cada extensão espacial



Para determinar a extensão espacial da escala de paisagem 

```{r 2o passo}
f_glm.nb <- function(data_){
  md_ <- MASS::glm.nb(S_obs ~ poly(p, 3) + log(Ntotal), data = data_)
}
registerDoMC(3)
l_md <- dlply(df_se,"lado_km",f_glm.nb,.parallel = TRUE)
```

### 3o Passo: Calcular o peso de evidência por lado da paisagem local (km)

```{r 3o passo,results='hide'}
df_averageSE <- print(AICctab(l_md,weights=TRUE),min.weight=10^(-10)) %>% 
  as.data.frame()
df_averageSE$lado_km <- row.names(df_averageSE) %>% as.numeric()
df_averageSE$weight <- as.numeric(as.character(df_averageSE$weight))
df_averageSE$dAICc <- as.numeric(as.character(df_averageSE$dAICc))
```
  
    
### 4o Passo: Selecionar o lado da paisagem local que atribuiu maior peso de evidência

```{r 4o passo,echo=FALSE}
v_lado_max_weight <- df_averageSE |> filter(weight==max(df_averageSE$weight)) |> pull(lado_km)
df_averageSE |> 
  ggplot(aes(x=lado_km,y=weight)) +
  geom_line() +
  labs(title = paste0("O maior weight foi no maior lado = ",v_lado_max_weight,"km"))
```

__Figura 2__ Peso de evidência pelo lado da paisagem local.

### Avaliação

#### Gráficos Exploratórios das preditoras para o lado selecionado

```{r graf exp lado selecionado,echo=FALSE}
df_data <- df_se |> 
  filter(lado_km == 22.26) |> 
  mutate(log_S = log(S_obs))
f_ggplot <- function(y){
  ggplot(df_data,aes(x=p,y=.data[[y]])) +
    geom_smooth(color="red") +
    geom_point(aes(color=log(Ntotal))) + 
    theme_minimal() +
    theme(legend.position = "bottom")
}
# f_ggplot(y="log_SN")
l_p <- alply(c("S_obs","log_S"),1,f_ggplot)
grid.arrange(grobs=l_p,ncol=2,top="Smooth: Riqueza observada(S) e log(S) ~ p, lado paisagem = 22.26")
```

__Figura 3__ Gráficos Exploratórios das preditoras do modelo mais plausível, quando %CV(p) é calculado usando o maior lado da paisagem. Em vermelho uma funçõa loess considerando apenas p como preditora.

#### Como está o ajuste do modelo que atribuiu maior peso de evidência?
  
__tabela 1__ Sumário do modelo mais plausível, lado da paisagm = 22.26 km  
  
```{r sumário modelo mais plausível, echo=FALSE}
md_ee <- l_md[[as.character(v_lado_max_weight)]]
summary(md_ee)
```


```{r dharma residuals modelo com maior peso de evidência,echo=FALSE}
res.Dharma <- DHARMa::simulateResiduals(md_ee,n = 250,refit = FALSE)
plot(res.Dharma)
```

__figura 5__ Resíduos quantilícos (DHARMa) do modelo mais plausível. 


```{r predito contra observado, echo=FALSE}
df_plot <- df_se |> 
  filter(lado_km == 22.26) |> 
  mutate(log_S = log(S_obs))
df_plot$fit <- predict(md_ee,type = "response",newdata=df_data)
df_plot |> 
  ggplot(aes(x=S_obs,y=fit)) +
  geom_point() +
  geom_smooth(method = "lm",formula="y~0+x") +
  geom_abline(slope=1,intercept = 0,color="red")
```

__figura 6__ Predito pelo modelo mais plausível e observado. Em vermelho reta 1:1; em azul a regressão linear entre predito e observado. 

```{r predito por p quando Ntotal é igual a mediana,echo=FALSE}
df_data <- df_se |> 
  filter(lado_km == 22.26) |> 
  mutate(log_S = log(S_obs))
df_plot <- data.frame(p=df_data$p, Ntotal=median(df_data$Ntotal))
df_plot$fit <- predict(md_ee,type="response",newdata=df_plot)
df_plot |> 
  ggplot(aes(x=p,y=fit)) + 
  geom_line() +
  labs(y="Riqueza predita",title=paste0("Ntotal = median(Ntotal observado)=",median(df_data$Ntotal)))
```

__figura 7__ Riqueza predita quando Ntotal é mantido constante no valor mediano.


