---
title: "SADs neutras"
author: "Mori, Danilo"
date: "19/11/2022"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE,message = FALSE,warning = FALSE)
# pacotes
library(twosamples)
library(sads)
library(doMC)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(insight)
library(bbmle)
library(DHARMa)
library(lme4)
library(plyr)
library(dplyr)
# dados
# df_sim
df_sim <- read_csv("dados/df_simulacao.csv") |> 
  mutate(txt.path = gsub("dados/simulacao/","",txt.path))
# df_Urep
df_Urep <- read_csv("dados/csv/df_Urep.csv")
df_U <- df_Urep |> 
  drop_na() |> 
  pivot_longer(cols = `1`:`10`,names_to = "n",values_to = "U") |> 
  group_by(SiteCode,k) |> 
  summarise(Umed = mean(U)) |> 
  inner_join(x=select(df_sim,SiteCode, k, txt.path, d),by=c("SiteCode","k"))
# df_SADrep
df_SADrep <- mutate(data.frame(
  SADrep.path = list.files(path = "dados/csv/SADs_neutras/MNEE",
                           pattern = ".csv",full.names = T)),
  SADobs.path = gsub("neutras/MNEE","observadas",SADrep.path),
  SiteCode = str_extract(SADrep.path,"(?<=EE\\/).*?(?=.csv)"))
# df_KSrep
df_KSrep <- read_csv("dados/csv/df_KSrep.csv")
# funções
source("source/dinamica_coalescente.R")
source("source/2samples_testes.R")
```

# MNEE

## Simulação das SADs por sítio de amostragem

```{r MNEE simulação das SADs por sítio de amostragem e k}
setwd("dados/simulacao/")
f_sadMNEE <- function(df, n_replicas=100){
  land_path <- df$txt.path[1]
  f_simCoalescente <- function(X){
    dinamica_coalescente(U = X$Umed, S=0, disp_range = X$d, N_simul=n_replicas,landscape = land_path)
  }
  m_SADreplicas <- adply(df,1,f_simCoalescente)
  write_csv(select(m_SADreplicas,-(txt.path:Umed)),
            file = paste0("../csv/SADs_neutras/MNEE/",df$SiteCode[1],".csv"))
}
registerDoMC(3)
d_ply(filter(df_U,SiteCode != "BAjuss"),"SiteCode",f_sadMNEE,.parallel = TRUE)
```

## Comparação com a SAD observada

```{r MNEE comparação com a SAD observada usadn o teste KS}
registerDoMC(3)
df_KSrep <- adply(df_SADrep,1,f_KSrep,.parallel = TRUE)
write_csv(select(df_KSrep,SiteCode:p.value),file = "dados/csv/df_KSrep.csv")
```

```{r MNEE comparação com a SAD observada usando o teste DTS} 
registerDoMC(3)
df_DTSrep <- adply(df_SADrep,1,f_DTSrep,.parallel = TRUE)
write_csv(select(df_DTSrep,SiteCode:p.value),file = "dados/csv/df_DTSrep.csv")
```

# abundance.csv para SAD observada para cada sítio amostrado

```{r abundance para SAD por SiteCode}
df_abundance <- 
  read.csv("/home/danilo/Documentos/artigo_mestrado/1A.P_MOVER/dados_para_iniciar_artigo/abundances.csv",
           header = TRUE,as.is = TRUE)
df_SADobs <- df_abundance |> 
  filter(SiteCode %in% unique(df_sim$SiteCode)) |> 
  select(SiteCode, species.correct, N)
f_SADobs <- function(df){
  write_csv(select(df,-SiteCode),
            file = paste0("../csv/SADs_observadas/",df$SiteCode[1],".csv"))
}
d_ply(df_SADobs,"SiteCode",f_SADobs)
```

