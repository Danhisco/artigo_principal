---
title: "SADs neutras"
author: "Mori, Danilo"
date: "19/11/2022"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE,message = FALSE,warning = FALSE)
# pacotes
library(twosamples)
library(sads)
library(doMC)
library(ggpmisc)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(insight)
library(bbmle)
library(DHARMa)
library(lme4)
library(plyr)
library(dplyr)
# funções
source("source/dinamica_coalescente.R")
source("source/2samples_testes.R")
source("source/f_plotSADacumulada.R")
source("source/chi2_2samples_bootstrap.R")
f_dfSADcsv <- function(l_files.path.full, site_pattern = "(?<=EE\\/).*?(?=.csv)"){
  mutate(data.frame(
    SAD.path = l_files.path.full),
    SiteCode = str_extract(SAD.path,site_pattern)
  )
}
## dados comuns
# df_p
df_p <- read_csv("dados/df_p.csv")
#df_sítios simuláveis em MNEE contemporâneo
v_site <- read_csv("dados/csv/resultados_MN/MNEE/cont/df_resultados.csv") |> 
  pull(SiteCode) |> unique()
# df_sim
df_sim <- read_csv("dados/df_simulacao.csv") |> 
  select(-tif.path) |> 
  inner_join(y=mutate(
    data.frame(txt.path = list.files(path="dados/simulacao",pattern=".txt")),
    SiteCode = str_extract(txt.path,".*?(?=.txt)")),
    by="SiteCode") |> 
  filter(SiteCode %in% v_site)
# df_taxaU
df_taxaU <- read_csv("dados/csv/df_taxaU.csv")
# df_SADrep
df_SADrep <- mutate(data.frame(
  SADrep.path = list.files(path = "dados/csv/SADs_neutras/MNEE",
                           pattern = ".csv",full.names = T,recursive = T)),
  SiteCode = str_extract(SADrep.path,"(?<=[cont|frag|ideal]\\/).*?(?=.csv)"),
  land_type = str_extract(SADrep.path,"(?<=MNEE\\/).*?(?=\\/)"),
  SADobs.path = paste0("dados/csv/SADs_observadas/",SiteCode,".csv"))
# # df_repMNEE
# df_repMNEE <- read_csv("dados/csv/resultados_MN/MNEE/df_repMNEE")
# # df_resultMNEE
# df_resultMNEE <- read_csv("dados/csv/resultados_MN/MNEE/df_resultMNEE.csv")
```

## Comparação com a SAD observada

### testes KS e a contagem de espécies

```{r testes KS DTS e S}
registerDoMC(3)
df_repMNEE <- adply(df_SADrep,1,f_resultsMN,.parallel = TRUE)
write_csv(select(df_repMNEE,SiteCode:S), file = "dados/csv/resultados_MN/MNEE/df_repMNEE")
```

```{r summarise resultados de MNEE para df_resultMNEE}
df_resultMNEE <- df_repMNEE |> 
  group_by(SiteCode,k) |> 
  summarise(nCongKS = sum(p.KS>0.05),
            nCongDTS = sum(p.DTS>0.05),
            Smed = mean(S),
            Ssd = sd(S),
            Smin = min(S),
            Smax = max(S))
df_resultMNEE <- df_resultMNEE |> 
  inner_join(x=df_p,by="SiteCode")
write_csv(df_resultMNEE,file = "dados/csv/resultados_MN/MNEE/df_resultMNEE.csv")
```

## Comparação gráfica SAD acumulada e predita

```{r comparação SAD acumulada e predita}
df_plot <- inner_join(df_resultMNEE,df_SADrep,by="SiteCode") |> 
  left_join(y=distinct(select(df_sim,SiteCode:S_obs)),by="SiteCode")
d_ply(df_plot,"SiteCode",f_plot.SADacumulada)
```

Qual o comportamento geral?

Casos em que 
DTS parece ser melhor: BAlenc4,

KS parece ser melhor: MGlavr2, MGlavr3, MGlavr6, MGubera, MGuberl1, MGuberl3, MGuberl5, MGuberl6, MGuberl7,MGvico3, MGvico4, MGvico16, PEcabo2, PEcaru1, PEsvfer,PRanto5, PRanto7, PRanto8, PRanto9, PRanto10, PRanto11, PRanto14, PRdiam2, PRdiam3, PRipir, PRrico1, PRrico3, PRtiba1, PRvent, RJpnrj, RScach1, RScach3, RScach4, RScama, RSfaxi, RSgaur, RSpet1, RSrioz1, RSsetape, RSsmar4, RSvsol, SCcric1, SCorle, SCserra4, SCside, SCside1, SCside4, SCsjo1, SPcara3, SPeec1, SPeec4, SPeec5, SPjabo1, SPpecb1, SPpesmD, SPpesmH, SPpesmK, SPpesmL, SPpesmN,      

os dois são ruins: MGmadre4, MSdour, PEmata2, PRanto6, PRanto12, PRdiam4, PRsapo, RScach2, RScamb1, RScris, RSmaqu4, SCvolta1, SCvolta2, SPitir1, SPpei1, SPpesm6, SPpesmA, SPpesmB, SPpesmF, 

os dois são semelhantes: BAjuss, BAuruc, ESsoor, MGipia1, MGvico1, MSjatei, PEalia, PEbrejo, PRanto4, PRanto13, PRanto15, PRtele, RSmorr1, RSsini, SCilho, SCilho2, SCtimbe1, SPcana1, SPcara1, SPigua1, SPpesmC, SPpesmE, SPpesmI, SPpesmJ, SPpesmM, SPpesmS, SPpesmU, 

Comentários:
não é simples fazer essa classificação, em alguns casos (SiteCode) ambos parecem ser ruins, pois acertam em alguns k e erram em outros. E ser melhor não implica em ser bom em si.  


# MNEE idealizado

```{r dados MNEE idealizado SAD}
df_SADcsv <- list.files(path="dados/csv/SADs_neutras/MNEE_idealizado",
                        pattern = ".csv", full.names = TRUE) |> 
  f_dfSADcsv(site_pattern = "(?<=ado\\/).*?(?=\\_k)") |> 
  ddply(.variables="SiteCode",.fun = \(df) df$SAD.path |> map_df(~read_csv(.)))
df_teste <- df$SAD.path |> map_df(~read_csv(.))
df_teste |> summary()
```

