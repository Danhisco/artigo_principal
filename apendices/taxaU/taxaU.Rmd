---
title: "taxaU"
author: "Danilo Pereira Mori"
date: "2022-12-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE,message = FALSE,warning = FALSE)
# pacotes
library(doMC)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(insight)
library(bbmle)
library(DHARMa)
library(lme4)
library(plyr)
library(dplyr)
# df_sim
df_sim <- read_csv("dados/df_simulacao.csv") |> 
  mutate(txt.path = gsub("dados/simulacao/","",txt.path))
# df_Urep
df_Urep <- read_csv("dados/csv/df_Urep.csv")
df_U <- df_Urep |> 
  pivot_longer(cols = `1`:`10`,names_to = "n",values_to = "U") |> 
  group_by(SiteCode,k) |> 
  summarise(Umed = mean(U),
            Usd = sd(U),
            Umin = min(U),
            Umax = max(U)) |> 
  inner_join(x=df_sim,by=c("SiteCode","k"))
# funções
source("source/dinamica_coalescente.R")
```

### Estimativa da taxa U

```{r estimativa de taxa U, echo=TRUE}
setwd("dados/simulacao")
f_taxaU <- function(df,n_replicas=10, Umin = 1.25e-08){
  f_simCoalescente <- function(X){
    v <- dinamica_coalescente(U = Umin, S=X$S_obs, disp_range = X$d, N_simul=1,landscape = X$txt.path)
    v$U_est
  }
  l_dfU <- list()
  for(i in 1:nrow(df)){
    v_U <- replicate(n=n_replicas,f_simCoalescente(X = df[i,]))
    l_dfU[[i]] <- cbind(select(df[i,],SiteCode,k,d),
                        matrix(v_U,nrow=1))
  }
  df_write <- rbind.fill(l_dfU)
  write_csv(df_write,file = paste0("../csv/taxaU/",df$SiteCode[1],".csv"))
}
registerDoMC(3)
d_ply(df_sim,"SiteCode",f_taxaU,.parallel = TRUE)
```

```{r taxa U para SCarar - sitio com NAs quando Umin igual a 1.25e-06}
setwd("dados/simulacao")
m <- as.matrix(read.table("SCarar.txt"))
image(m)
df <- filter(df_sim,SiteCode == "SCarar")
X_i <- df[1,]
f_taxaU2 <- function(df, n_replicas=10, Umin=1.25e-08, diminuir=5, parallel=TRUE, n_cores=3){
  f_simCoalescente <- function(X){
    v <- dinamica_coalescente(U = Umin, S=X$S_obs, disp_range = X$d, N_simul=1,landscape = X$txt.path, decay = diminuir)
    if(any(is.na(v))){
      return(NA)
    } else{
      return(v$U_est)
      }
  }
  f_write <- function(X_i){
    v_U <- replicate(n=n_replicas,f_simCoalescente(X = X_i))
    df_write <- cbind(select(X_i,SiteCode,k,d),
                        matrix(v_U,nrow=1))
    write_csv(df_write,file = paste0("../csv/taxaU/",X_i$SiteCode,"_k",round(X_i$k,2),".csv"))
  }
  registerDoMC(n_cores)
  a_ply(df,1,f_write,.parallel = TRUE)
}
f_taxaU(filter(df_sim,SiteCode == "SCarar"))
```


```{r fig 1 Umed ~ d +(SiteCode ~ p),eval=TRUE,fig.height=18,fig.width=15}
df_plot <- df_U |> 
  arrange(p) |> 
  mutate(label = paste0(SiteCode,", p=",round(p,2), " ,S=",S_obs))
df_plot$label <- factor(df_plot$label,levels = unique(df_plot$label))
df_plot |> 
  ggplot(aes(x=d,y=Umed)) +
  geom_point() +
  geom_line() +
  facet_wrap(~label, ncol=6,scales="free_y")
```

__Figura 1__ Média da taxa U estimada pelo desvio padrão da função de dispersão, média de 10 réplicas. p = proporção de cobertura vegetal, S = riqueza de espécies.

### Análise Estatística de U

<p>Proposta:</p>
<p>i) transformar U para escala logito</p>
<p>ii) fazer seleção de modelos usando LMER para avaliar quais os possíveis offsets: S_obs, razão A_J / A_M, A_J, DA</p>
<p>iii) avaliar a melhor estrutura do GAMM </p>

```{r Umed selecao de offset,echo=T}
# dados
f_z <- function(x){
  m <- base::mean(x,na.rm=FALSE)
  sd <- sd(x,na.rm=FALSE)
  (x-m)/sd
}
df_Ulogit <- df_U |> 
  drop_na() |> 
  mutate(Areas_ratio = effort_ha / 1600,
         DA = Ntotal / effort_ha,
         Ulogit = log(Umed/(1-Umed)),
         logS.z = f_z(log(S_obs)),
         S.z = f_z(S_obs),
         logDA.z = f_z(log(DA)),
         DA.z = f_z(DA),
         logAreas.z = f_z(log(Areas_ratio)),
         effort.z = f_z(effort_ha),
         log_effort.z = f_z(log(effort_ha)),
         Areas.z = f_z(Areas_ratio))
# gráficos
df_Ulogit |> 
  select(Ulogit:Areas.z,effort.z) |> 
  pivot_longer(-Ulogit,names_to = "preditoras",values_to = "values") |> 
  ggplot(aes(x=values,y=Ulogit)) +
  geom_point() +
  geom_smooth(se=F,method = "loess",formula = "y~x") +
  facet_wrap(~preditoras,ncol=2,scales="free_x")
# próximo: fazer gráficos exploratórios 
```


```{r modelos para offsets,eval=TRUE,echo=TRUE}
# modelos
l_md <- list()
l_md[[1]] <- lmer(Ulogit ~ S.z + DA.z + (1|SiteCode), data=df_Ulogit)
l_md[[2]] <- update(l_md[[1]], . ~ . -DA.z)
l_md[[3]] <- lmer(Ulogit ~ logS.z + logDA.z + (1|SiteCode), data=df_Ulogit)
l_md[[4]] <- update(l_md[[3]], . ~ . -logDA.z)
f_nameModel <- function(md){
  paste(unlist(find_predictors(md)),collapse = " + ")
}
names(l_md) <-laply(l_md,f_nameModel)
AICctab(l_md,weights=T)
```


```{r DHARMa residuals, eval=TRUE}
p_plot <- simulateResiduals(l_md[["logS.z + logDA.z"]],n=1000)
plot(p_plot)
plot(density(df_Ulogit$Umed))
```


