---
title: "Mapas para MNEE"
author: "Mori, Danilo"
date: "19/11/2022"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = FALSE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE,eval=TRUE)
# pacotes
library(doMC)
library(raster)
library(gridExtra)
library(ggplot2)
library(readr)
library(stringr)
library(plyr)
library(dplyr)
# df_dados
df_dados <- read_csv("dados/df_dados_disponiveis.csv") |> 
  select(SiteCode, effort_ha, Ntotal, S_obs) |> 
  inner_join(data.frame(tif.path = list.files(path="dados/paisagens_mapbiomas6_padronizadas",pattern=".tif",full.names=T),
                        SiteCode = str_extract(list.files(path="dados/paisagens_mapbiomas6_padronizadas",
                                                          pattern=".tif",full.names=T),"(?<=as\\/).*?(?=.tif)")),
             by = "SiteCode")
# df_se_completo
df_se_completo <- read_csv("dados/csv/df_p_extensoes.csv")
# df_selecao_sitios
df_sitios_se <- df_se_completo |> 
  filter(lado_km>=15.99 & lado_km<=16.02) |>  # como alguns raster tem 743 linhas e outros 744
  arrange(p) |> head(n=5) |> 
  inner_join(select(df_dados,-Ntotal,-S_obs),by="SiteCode") |> 
  mutate(DA = Ntotal/effort_ha)
# df_auditoria dos recortes de paisagens padronizados para MNEE
df_auditoria <- data.frame(txt.path = list.files(path = "dados/simulacao",pattern = ".txt",full.names = T)) |>
  mutate(SiteCode = str_extract(txt.path,"(?<=o\\/).*?(?=.txt)")) |>
  inner_join(df_sitios_se,by="SiteCode")
```

## Como a proporção de cobertura vegetal varia com a extensão espacial da paisagem?

```{r calcular a prop CV para cada extensão espacial,eval=FALSE,echo=TRUE}
f_pEscalas <- function(df){
  df_p <- data.frame(p = NA, lado_km = NA)
  m_full <- raster(df$tif.path) |> raster::as.matrix()
  v_last_i <- (nrow(m_full) - 11)/2
  for(i in 1:v_last_i){
    m_i <- m_full[i:(nrow(m_full)-i),
                  i:(nrow(m_full)-i)]
    df_p[i,] <- c(length(m_i[m_i!=0])/length(m_i),
                  nrow(m_i) * 30/1000)
  }
  df_p$SiteCode <- df$SiteCode
  return(df_p)
}
registerDoMC(3)
df_pEscalas <- adply(df_dados,1,f_pEscalas,.id = "SiteCode",.parallel = TRUE)
write_csv(x = select(df_pEscalas,Ntotal,S_obs,p:SiteCode),
          file = "./dados/csv/df_p_extensoes.csv")
```
```{r grafico da proporção de cobertura vegetal em funcao da extensão espacial da paisagem local,echo=FALSE,eval=TRUE}
df_se_completo |> 
  ggplot(aes(x=lado_km,y=p)) + 
  geom_point(alpha=0.2,size=0.2) +
  geom_line(aes(group=SiteCode),size=0.2,alpha=0.2) +
  scale_y_continuous(breaks = seq(0,1,by=0.1))
```

<p> __Figura 1__ Proporção de cobertura vegetal em função da extensão espacial da paisagem ao redor.</p>

#### Os 5 sítios com menor proporção de cobertura vegetal quando o lado da paisagem possui 16.02 km

```{r auditoria dos sitios selecionados para o estudo do efeito de escala - tif, echo=FALSE,eval=TRUE}
df <- df_sitios_se
v_landExt <- df$lado_km[1] * 1000/30 # the maximum landscape extension simulated, pixel = 30x30m2
par(mfrow=c(2,3))
for(i in 1:nrow(df)){
  m_full <- raster(df$tif.path[i]) |> raster::as.matrix()
  index <- (nrow(m_full)-v_landExt)/2
  m <- m_full[(index+1):(nrow(m_full) - index),
              (index+1):(nrow(m_full) - index)]
  image(m,main=df$SiteCode[i])
  abline(h=0.5)
  abline(v=0.5)
  print(dim(m))
}  
```


### Mapas de cobertura vegetal adequados para MNEE.

```{r rotina para processar as paisagens,eval=FALSE}
source("source/mapa_p_MNEE.R")
registerDoMC(2)
a_ply(df_sitios_se,1,f_landscape_for_MNEE,) # lado_km = 16.02
```

```{r auditoria das paisagens,eval=FALSE,echo=FAlSE,eval=TRUE}
f_auditoria <- function(path_name){
  m <- read_table(file = path_name) |> as.matrix()
  d <- ceiling(sqrt(2500)*2)
  l <- ceiling(dim(m)[1]/2)
  c <- ceiling(dim(m)[2]/2)
  m_temp <- m[(l-d):(l+d),(c-d):(c+d)]
  image(m_temp,main=str_extract(path_name,"(?<=cao\\/).*?(?=\\.txt)"))
}
par(mfrow=c(2,3))
sapply(df_auditoria$txt.path,f_auditoria)
```
  
    
__Figura 2__ Vizinhança imediata da parcela dos 5 sítios com menor cobertura vegetal
  
### Precisa corrigir alguma parcela central?
  
```{r salvar paisagens com as parcelas corrigidas,echo=FALSE,eval=FALSE}
df_correcao <-  df_auditoria |> filter(SiteCode == "PRrico3")
f_correcao <- function(df){
  m_paisagem_corrigida <- f_nova_parcela(df)
  write.table(x = m_paisagem_corrigida,
                file = df$txt.path,
                sep = " ", row.names = FALSE, col.names = FALSE)
}
# a_ply(df_correcao,1,f_correcao)
f_correcao(df_correcao)
```

```{r comparação das paisagens no txt e no tif}
f_p_txt_tif <- function(df){
  m_txt <- read.table(df$txt.path) |> as.matrix()
  m_tif <- raster(df$tif.path) |> as.matrix()
  i_centro <- nrow(m_tif)/2
  i_ladoKm <- 16.02 * 1000/60
  m_i <- m_tif[(i_centro+1-i_ladoKm):(i_centro+i_ladoKm),
               (i_centro+1-i_ladoKm):(i_centro+i_ladoKm)]
  p_txt <- 100*length(m_txt[m_txt!=0])/length(m_txt)
  p_tif <- 100*length(m_i[m_i!=0])/length(m_i)
  data.frame(df$SiteCode,p_txt,p_tif)
}
registerDoMC(3)
df_auditoria <- adply(df_auditoria,1,f_p_txt_tif,.parallel = T)
df_auditoria |> mutate(diff_p = p_txt - p_tif > 2.5)
f_image_raster <- function(df){
  m_raster <- raster(df$tif.path) |> as.matrix()
  i_centro <- nrow(m_tif)/2
  i_ladoKm <- 16.02 * 1000/60
  m_i <- m_tif[(i_centro+1-i_ladoKm):(i_centro+i_ladoKm),
               (i_centro+1-i_ladoKm):(i_centro+i_ladoKm)]
  image(m_i)
}
```

