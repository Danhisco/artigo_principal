---
title: "Análise Dados"
author: "Mori, Danilo"
date: "19/11/2022"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE,message = FALSE,warning = FALSE)
# pacotes
library(sads)
library(doMC)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(MuMIn)
library(AICcmodavg)
library(insight)
library(bbmle)
library(DHARMa)
library(lme4)
library(plyr)
library(dplyr)
# objetos
load("dados/Rdata/md_MNEE.Rdata")
polyK=3
# dados
# df_resultMNEE
df_resultMNEE <- read_csv("dados/csv/resultados_MN/MNEE/df_resultMNEE.csv")
# df_sim
df_sim <- read_csv("dados/df_simulacao.csv")
# df_ad
f_z <- function(x) (x-mean(x))/sd(x)
df_ad <- inner_join(x=select(df_resultMNEE,-(Ssd:Smax)),
                    y=select(df_sim,-tif.path),
                    by=c("SiteCode")) |>
  # escolhi remover depois do ajuste, para obter um melhor ajuste e depois excluir os valores
  # filter(k > 0.20) |> # figuras 5 e 6 apêndice Efeito de Escala
  mutate(k_cont = round(k,2),
         k = factor(round(k,2),levels=round(k,2)[20:1]), 
         across(Ntotal:S_obs,log,.names="log_{.col}"),
         across(c(p,k_cont,log_Ntotal:log_S_obs),f_z,.names = "{.col}_z")) |>
  select(-c(nCongDTS,effort_ha, Ntotal:S_obs))
# df_newdata
df_newdat <- read_csv("dados/csv/df_newdataSADs.csv")
# df_newdat <- expand.grid(p_z = seq(min(df_ad$p_z),max(df_ad$p_z), length=150),
#                          k_cont_z = seq(min(df_ad$k_cont_z),max(df_ad$k_cont_z), length=150))
# df_newdat <- adply(df_newdat,1,.fun = \(x) cbind(x,distinct(select(df_ad,SiteCode,log_S_obs_z,log_Ntotal_z))))
# write_csv(df_newdat,"dados/csv/df_newdataSADs.csv")
```

# MNEE com mapas contemporaneos

## Gráficos Exploratórios

```{r GE congruencia MNEE por p e k}
l_p <- list()
df_plot <- df_ad |> filter(k_cont>0.20)
l_p[[1]] <- df_plot |> 
  ggplot(aes(x=p,y=nCongKS)) +
  geom_point() +
  geom_smooth(method = "loess",se=F) +
  labs(title="a) p, proporção de cobertura vegetal (~k)",
       y="número de SADs réplicas congruentes") +
  theme_bw() +
  facet_wrap(~k,ncol=5)
l_p[[2]] <- df_plot |> 
  mutate(p_cut = cut(p,20)) |> 
  ggplot(aes(x=k_cont,y=nCongKS)) +
  geom_point(alpha=0.4) +
  geom_line(alpha=0.4,aes(group=SiteCode)) +
  geom_smooth(method = "loess",se=F) +
  labs(title="b) k, prop. propágulos até a vizinhança (~cut(p, 20))",
       y="número de SADs réplicas congruentes",
       x="k") +
  theme_bw() +
  scale_x_reverse() +
  facet_wrap(~p_cut,ncol=5)
p <- grid.arrange(grobs=l_p,ncol=1,top="Congruência de MNEE")
ggsave("apendices/analise_dados/figuras/fig1_cong_p_k.png",
       width = 10.2,
       height = 10.7,
       plot = p)
```
  
    
__Figura 1__ Congruência de SADs MNEE por: a) proporção de cobertura vegetal; e b) k, grau de limitação de dispersão.
  
    
```{r congruencia de MNEE por k_cont e sitio de amostragem}
df_plot <- df_ad |> 
  mutate(label = paste0(SiteCode,", p=",round(p,2))) |>
  arrange(p)  |> filter(k_cont>0.20)
df_plot$label <- factor(df_plot$label,levels = unique(df_plot$label))
df_plot |> 
  ggplot(aes(x=k_cont,y=nCongKS)) +
  geom_smooth(method = "loess",se=F) +
  geom_point() +
  # labs(title="b) k, prop. propágulos até a vizinhança (~cut(p, 20))",
  #      y="número de SADs réplicas congruentes",
  #      x="k") +
  theme_bw() +
  scale_x_reverse() +
  facet_wrap(~label,ncol=6)
ggsave("apendices/analise_dados/figuras/fig2_cong_k_SiteCode.png",
       width = 10,
       height = 17.7)
```

```{r}
df_plot <- df_ad |> 
  mutate(log_S.N = log_S_obs - log_Ntotal) 
df_plot |> 
  filter(log_S.N >= -3.75) |>
  ggplot(aes(x=p,y=exp(log_S.N))) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(y="S / N")
df_plot |> 
  filter(log_S.N >= -3.75) |> 
  ggplot(aes(x=log_S.N,y=nCongKS)) +
  geom_point(aes(color=p)) +
  geom_smooth(se=F,method="lm") +
  facet_wrap(~k,ncol = 5)
df_plot |> 
  ggplot(aes(x=p,y=exp(log_Ntotal))) +
  geom_point() +
  geom_smooth()
summary(lm(exp(log_S.N) ~ poly(p,1,raw = T), filter(df_plot,log_S.N >= -3.75)))
```



## Análise Estatística

### Modelo Cheio

```{r selecao modelo cheio,echo=T,eval=F}
polyK=3
md_MNEE <- glmer(cbind(nCongKS,100-nCongKS) ~ 
                   poly(p_z,polyK,raw=T) * poly(k_cont_z,polyK,raw=T) + 
                   (poly(k_cont_z,polyK,raw=T)|SiteCode),
          data=df_ad, family = "binomial",
          control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e9)),na.action = "na.fail")
```


```{r dHARMa residuos md_MNEE_RE,eval=TRUE,cache=TRUE}
p_plot <- DHARMa::simulateResiduals(md_MNEE,n=1000)
plot(p_plot)
```

__Figura 4__ Resíduos Quantílicos modelo cheio selecionado MNEE nCongKS

```{r Quantile-quantile plot random effects,eval=TRUE}
df_ranef <- ranef(md_MNEE)$SiteCode 
df_ranef$SiteCode <- row.names(df_ranef)
row.names(df_ranef) <- NULL
df_ranef |> 
  pivot_longer(-SiteCode) |>
  ggplot(aes(sample=value)) + 
  stat_qq(alpha=0.3) + stat_qq_line(alpha=0.3,col="red") +
  facet_wrap(~name,scales="free",ncol=3)
```

__Figura 5__ Resíduos Quantílicos modelo cheio selecionado MNEE nCongKS


```{r figura 6 observado e predito pelo modelo médio de nCongKS MNEE, eval=T,fig.height=4}
# dados
df_md <- md_MNEE@frame
df_md$nCong_observado <- df_md$`cbind(nCongKS, 100 - nCongKS)`[,1]
df_md$nCong_predito <- predict(md_MNEE,type="response") * 100
# graficos
ggplot(df_md,aes(x=nCong_observado,y=nCong_predito)) +
  geom_smooth(method = "lm",aes(group=SiteCode),se=FALSE,alpha=0.3) +
  geom_abline(slope = 1,intercept = 0,col="red",alpha=0.8,size=2) +
  geom_point(alpha=0.3) +
  labs(x="nSADcong observado",
       y="nSADcong predito",
       subtitle="Modelo Cheio") +
  coord_cartesian(expand = F)
summary(lm(nCong_observado ~ nCong_predito,df_md))
```

__Figura 6__ Observado e predito pelo modelo cheio selecionado 


__Tabela 1__ Coeficiente de determinação marginal e condicional do modelo cheio selecionado para nCongKS de MNEE

```{r R2m e R2c md_MNEE_RE,cache=TRUE}
# md_MNEE <- glmer(cbind(nCongKS,100-nCongKS) ~ 
#                    log_Ntotal_z * log_S_obs_z *
#                    poly(p_z,polyK,raw=T) * poly(k_cont_z,polyK,raw=T) + 
#                    (poly(k_cont_z,polyK,raw=T)|SiteCode),
#           data=df_ad, family = "binomial",
#           control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e9)),na.action = "na.fail")
(df_R2_RE_MNEE <- MuMIn::r.squaredGLMM(md_MNEE))
# kableExtra::kable(df_R2_RE_MNEE)
```

### Predição para novo conjunto de dados

```{r predito newdata MNEE}
#new data
df_newdat$PREDc <- predict(md_MNEE,newdata=df_newdat,type="response")
df_newdat$PREDm <- predict(md_MNEE,newdata=df_newdat,type="response",re.form=~0)
#### em consrução
# f_summarise_qtl <- function(x, q = c(0.05, 0.25,  0.75, 0.95)) {
#   tibble("{{ x }}" := quantile(x, q), "{{ x }}_q" := q) |> 
#     pivot_wider(values_from = 1, names_from = 2, )
# }
##
df_plot <- df_newdat |> 
  group_by(p_z,k_cont_z) |> 
  summarise(Prob_Cong_avg = mean(PREDc),
            Prob_Cong_median = median(PREDc),
            Prob_Cong_q05 = quantile(PREDc,probs = 0.05),
            Prob_Cong_q95 = quantile(PREDc,probs = 0.95)) |> 
  # summarise(across(PREDc:PREDm,list(avg = mean, mdn = median, 
  #                                   qtl05 = quantile(probs=0.05), qtl25 = quantile(probs=0.25),
  #                                   qtl05 = quantile(probs=0.75), qtl25 = quantile(probs=0.95)))) |> 
  mutate(p = p_z * sd(df_ad$p) + mean(df_ad$p),
         k = k_cont_z * sd(df_ad$p) + mean(df_ad$p)) |> 
  filter(k > 0.20 & k <=0.99)
## gráficos
df_plot |>
  pivot_longer(cols = Prob_Cong_avg:Prob_Cong_q95) |> #pull(value) |> (\(.)plot(density(.)))()
  ggplot(aes(x=p,y=k,fill=value)) +
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
  facet_wrap(~name,ncol=2,scales="free") +
  labs(title="predito condicional") +
  theme_classic()
ggsave("apendices/analise_dados/figuras/predito_marginalMNEE.png",
       width = 8.5,
       height = 6.7)
```




<!-- ### Predição Modelo Médio MNEE RE nCongKS -->

<!-- ```{r modelo médio MNEE RE nCongKS} -->
<!-- # todas as combinações de modelo do modelo cheio -->
<!-- registerDoMC(3) -->
<!-- l_md.dredge_nCongKS_MNEE <- llply(dredge(md_MNEE,trace = FALSE,evaluate=FALSE), eval,.parallel = TRUE) -->
<!-- save(l_md.dredge_nCongKS_MNEE,file = "dados/Rdata/l_md_dredge_nCongKS_MNEE.Rdata") -->
<!-- ``` -->

<!-- __tabela 2__ Sub modelos derivados do modelo cheio com maior peso de evidência  -->

<!-- ```{r tabela 2 peso de evidência dos modelos em ordem decrescente,results='hide' } -->
<!-- load("dados/Rdata/l_md_dredge_nCongKS_MNEE.Rdata") -->
<!-- # AICctab -->
<!-- df_tableGLMM <- print(AICctab(l_md.dredge_nCongKS_MNEE,weights=TRUE)) %>%  -->
<!--   as.data.frame() -->
<!-- df_tableGLMM$model_code <- row.names(df_tableGLMM) -->
<!-- df_tableGLMM$weight <- as.character(df_tableGLMM$weight) -->
<!-- df_tableGLMM$dAICc <- as.numeric(as.character(df_tableGLMM$dAICc)) -->
<!-- rownames(df_tableGLMM) <- NULL -->
<!-- df_tableGLMM <- df_tableGLMM[,c(4,1:3)] -->
<!-- ``` -->


<!-- ```{r model averaging MNEE  MuMIn e AICcmodavg} -->
<!-- # Model Averaging for SiteCode predictions -->
<!-- mdAvg_nCongMNEE_MuMIn <- model.avg(l_md.dredge_nCongKS_MNEE) -->
<!-- save(mdAvg_nCongMNEE_MuMIn,file="dados/Rdata/mdAvg_nCongMNEE_MuMIn.Rdata") -->
<!-- # Model Averaging for new data predictions -->
<!-- df_pred <- expand.grid(SiteCode=unique(df_ad$SiteCode)[1], -->
<!--                        d_z=seq(min(df_ad$d_z),max(df_ad$d_z),length=40), -->
<!--                        p_z=seq(min(df_ad$p_z),max(df_ad$p_z),length=200)) -->
<!-- mdAvg_nCongMNEE_AICcmodavg <- modavgPred(l_md.dredge_nCongKS_MNEE,newdata = df_pred,type="link") %>% -->
<!--   cbind(df_pred) -->
<!-- save(mdAvg_nCongMNEE_AICcmodavg,file="dados/Rdata/mdAvg_nCongMNEE_AICcmodavg.Rdata") -->
<!-- ``` -->

<!-- ```{r dados para novo conjunto de dados que interpola e extrapola os valores observados} -->
<!-- load("dados/Rdata/mdAvg_nCongMNEE_AICcmodavg.Rdata") -->
<!-- df_plot <- mdAvg_nCongMNEE_AICcmodavg |>  -->
<!--   select(mod.avg.pred,lower.CL:upper.CL,d_z:p_z) |>  -->
<!--   mutate(across(mod.avg.pred:upper.CL,\(x) exp(x)/(1+exp(x))), -->
<!--          p = p_z*sd(df_ad$p) + mean(df_ad$p), -->
<!--          d = d_z*sd(df_ad$d) + mean(df_ad$d)) -->
<!-- df_plot |>  -->
<!--   ggplot(aes(x=p,y=d,fill=mod.avg.pred)) + -->
<!--   coord_cartesian(expand = FALSE) +  -->
<!--   geom_tile() + -->
<!--   scale_fill_distiller(palette = "Spectral") -->
<!-- ``` -->


