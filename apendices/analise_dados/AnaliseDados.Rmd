---
title: "Análise Dados"
author: "Mori, Danilo"
date: "19/11/2022"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE,message = FALSE,warning = FALSE)
# pacotes
library(sads)
library(doMC)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(insight)
library(bbmle)
library(DHARMa)
library(lme4)
library(plyr)
library(dplyr)
# dados
# df_resultMNEE
df_resultMNEE <- read_csv("dados/csv/resultados_MN/MNEE/df_resultMNEE.csv")
# df_sim
df_sim <- read_csv("dados/df_simulacao.csv")
# df_ad
df_ad <- inner_join(x=select(df_resultMNEE,-(Smed:Smax)),y=select(df_sim,-tif.path),by=c("SiteCode","k")) |> 
  mutate(log10.Sobs = log(S_obs,10),
         log10.N = log(Ntotal,10),
         d.Lplot = d / sqrt(10000*effort_ha)) 
# padronização
df_ad$k <- factor(round(df_ad$k,2),levels=round(unique(df_ad$k),2)[20:1])
f_z <- function(x) (x-mean(x))/sd(x)
df_teste <- apply(select(df_ad,Ntotal:d.Lplot), 2, f_z,simplify = T) 
  
  df_ad |>  
  mutate(Ntotal:d.Lplot, f_z)


df_resultados.z <- as.data.frame(
  apply(
    df_resultados[,
                  c("p","Ntotal","log10_Sobs","k_1","d_Lplot","d","log10_d","modulo_diffS")],
    2,f_z))
names(df_resultados.z) <- sapply(names(df_resultados.z), function(x) paste0(x,".z"))
df_resultados %<>% cbind(.,df_resultados.z) %>% 
  select(-k_1,-k_1.z)

```

# MNEE com mapas contemporaneos

### Qual a relação entre o número de SADs congruentes segundo o teste KS e o teste DTS?

```{r figura 1 DTS e KS diffS,eval=T}
# df_ad |> 
#   ggplot(aes(x=nCongKS,y=nCongDTS,group=SiteCode)) +
#   geom_smooth(method = "lm",se=F,color="blue",alpha=0.4,formula = "y~x") +
#   geom_point(alpha=0.1) +
#   geom_line(alpha=0.1) +
#   geom_abline(slope = 1,intercept = 0,color="red")
# df_ad |> 
#   select(SiteCode:nCongDTS) |> 
#   pivot_longer(cols=nCongDTS:nCongKS,names_to = "variaveis",values_to = "nCong") |> 
#   ggplot(aes(x=variaveis,y=nCong)) +
#   geom_jitter() +
#   geom_boxplot()
v_labels <- c("nCongDTS" = "DTS: sum(p>0.05)",
              "nCongKS" = "KS: sum(p>0.05)")
df_ad |> 
  mutate(diffS = (S_obs - Smed) / S_obs ) |> 
  pivot_longer(cols=nCongKS:nCongDTS,names_to = "variaveis",values_to = "nCong") |> 
  ggplot(aes(x=diffS,y=nCong)) +
  geom_point() +
  geom_smooth(se=F) +
  labs(x="dif. com a riqueza observada",
       y="número de SADs congruentes") + 
  facet_wrap(~variaveis,ncol=2,labeller = as_labeller(v_labels))
# ggsave("figuras/MNEE-nCong_diffS.png")
# df_ad |> 
#   mutate(diffTestes = nCongKS - nCongDTS) |> 
#   ggplot(aes(x=S_obs,y=diffTestes)) +
#   geom_point() +
#   geom_smooth() +
#   labs(y="KS: sum(p value>0.05) - DTS: sum(p value>0.05)")
```

<p> __Figura 1__ Número de SADs congruentes (y) em função da diferença da riqueza da réplica e da SAD observada ( (Sobs - Srep )/ Sobs) por tipo de teste (DTS e KS). </p>


<p> DECISÕES: </p>
<p> 1) ambos os testes apresentam erro pequeno quando a hipótese nula é verdadeira (comparação de réplicas de uma mesma bateria de simulação). </p>
<p> 2) o teste DTS apresenta um erro maior quando a hipótese nula é falsa (comparação de réplicas de um mesmo sítio quando k=0.99 e k=0.05), porém o teste KS apresenta um erro de 47%; ainda vou mostrar para o PI esses resultados, talvez precise complementar essa segunda comparação. 
<p> CONCLUSÃO) Minha decisão é continuar com o teste KS pois no visual ele se sai melhor, apesar de ambos apresentarem problemas. </p>

### nCongKS ~ d|SiteCode

```{r figura 2 nCongKS d SiteCode,fig.width=10, fig.height=27,eval=TRUE}
df_plot <- df_ad |> mutate(title = paste0(SiteCode, " p=",round(p,digits = 3))) |>  arrange(p)
df_plot$title <- factor(df_plot$title,levels = unique(df_plot$title))
ggplot(df_plot,aes(x=d,y=nCongKS)) +
  geom_line(alpha=0.6) +
  geom_point(alpha=0.7) +
  theme_classic() + 
  scale_x_continuous(trans = "log10") +
  labs(x="d(metros)",y="# SADs congruentes (p-value>0.05)") +
  facet_wrap(~title,ncol=8,scales="free_x")
```

__Figura 2__ Número de SADs congruentes (p-value>0.05) pela desvio padrão da função de dispersão (metros) por sítio de amostragem. Os paineis estão organizados pela proporção de cobertura vegetal (p).

Notas:
  
    
1) em PEmata2 a melhora na congruência em cenários de limitação mais brandos pode ser considerada um erro dos testes, na verdade pode ser considerado que existe uma piora? Lembre-se que pelo artigo do teste DTS a maior variabilidade existe justamente nos valores intermediários.
  
    
2) em outros casos acontece o mesmo tipo de erro: nas áreas que mais chama a atenção é aquela em que pode existir maior variabilidade. Penso se isso não deveria aumentar o número de SADs réplicas. 


### Seleção da estrutura aleatória e variável de dispersão

```{r}

```


