---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup4,include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = TRUE,message = FALSE,warning = FALSE,cache=TRUE)
# pacotes
# library(dagitty)
# library(ggdag)
library(gt)
library(gratia)
library(sads)
library(doMC)
# library(metR)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
# library(MuMIn)
# library(AICcmodavg)
# library(insight)
library(bbmle)
library(DHARMa)
library(mgcv)
library(lme4)
library(data.table)
library(plyr)
library(dplyr)
source("source/nameModel.R")
source("source/GAMMtools.R")
source("source/general_tools.R")
f_z <- function(x) (x-mean(x))/sd(x)
```

```{r trackdown chunk SI, include=FALSE,eval=FALSE}
# pacotes
library(trackdown)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
# upload_file(file ="apendices/A2_figuras_tabelas/A2_figuras_tabelas.Rmd",
#             gpath = "mestrado/artigo_principal/apendices/",
#             hide_code = TRUE)
update_file(file ="apendices/A2_figuras_tabelas/A2_figuras_tabelas.Rmd",
            gpath = "mestrado/artigo_principal/apendices/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file = "secoes_texto/Resultados/Resultados.Rmd",
              gpath = "mestrado/artigo_principal/secoes_texto/")
```


# Sumário das simulações em função das paisagens hipotéticas
  
<p>A partir do sumário das paisagens hipotéticas é feito duas operações:
- determinar os valores de logito transformados quando número de SADs simuladas com boa congruência é igual a 0 ou 100.
- parametrizar o teste I de Moran por uma análise de sensibilidade a partir dos resíduos do sumário.
A determinação dos valores de logito observado dos valores extremos de número de SADs simuladas com boa congruência foi aplicado por paisagem hipotética e grau de limitação de dispersão simulado.</p>

```{r roda o sumário dos resultados em função das paisagens hipotéticas,echo=TRUE,eval=FALSE,include=FALSE}
# vlog = TRUE fará o teste de sensibilidade da estatśticas I de Moran e do p valor 
vlog <- TRUE
source("0_apendices/analise_dados/sumario_paisagens_hipoteticas.R")
```



## Transformação dos valores extremos de número de SADs com boa congruência por paisagem hipotética e grau de limitação de dispersão

```{r tab-extremos-transformacao,tab.cap="Transformação dos valores extremos no número de SADs com boa congruência (nSAD) segundo o modelo sumário mais plausível em função da paisagem hipotética (Paisagem) e grau de limitação de dispersão (k)."}
df_extremos <- read_csv(file = "dados/csv_SoE/df_logito_valores_extremos.csv")
df_extremos %>% 
  mutate(land = gsub("ideal","prístina",land) %>% 
           gsub("cont","contemporâneo",.) %>% 
           gsub("non_frag","aglomerado",.)) %>% 
  rename("Transformação" = "response",
         "Paisagem" = "land") %>% 
  flextable() %>% 
  bg(bg="gray",part="header") %>% 
  autofit()
```


## Avaliação do parâmetro k da estatística I de Moran
```{r criacação da figura de sensibilidade da estatística I de Moran, eval=FALSE,include=TRUE}
df_moran <- readRDS(file="1_to_compile_dissertacao_EM_USO/00_Resultados/rds/l_moranK_sumario_paisagens.rds")
df_moran <- lapply(names(df_moran),\(li){
  mutate(df_moran[[li]],modelo=li) %>% 
    relocate(modelo)
}) %>% do.call("rbind",.)
names(df_moran) <- gsub("_res","",names(df_moran)) %>% 
  gsub("StdDev","SD",.)
  c("MoranI_stat","SD","pvalue")
df_sumar <- df_moran %>% 
  group_by(modelo) %>%
  filter(MoranI_stat == max(MoranI_stat)) %>% 
  select(modelo,k) %>% 
  rename(k_max=k)
p <- df_moran %>% 
  inner_join(df_sumar) %>% 
  mutate(k=as.numeric(k),
         k_max=as.numeric(k_max),
         vlabel=paste("valor máximo\nno k =",k_max)) %>% 
  # filter(k<10) %>% 
  ggplot(aes(x=k)) +
  # geom_smooth() +
  # geom_point(size=4) 
  geom_hline(yintercept = 0.05,linetype=2) +
  geom_vline(aes(xintercept = k_max),linetype=3) +
  geom_line(aes(y = MoranI_stat), color = "blue") +
  geom_line(aes(y = pvalue), color = "red") +
  scale_y_continuous(
    "Moran's I (blue)", 
    expand = c(0,0),
    sec.axis = sec_axis(~ ., name = "p-value (red)")
  ) +
  scale_x_continuous(expand = c(0,0)) +
  geom_text(aes(label=vlabel,x=k_max+25,y=0.5),size=3) +
  facet_wrap(~modelo,ncol=3)
ggsave("dados/csv_SoE/figuras/MoranI_k1ate100_PVALeSTAT.jpeg",p,
       width = 10,height = 4.88)
```

```{r MoranI-sensibilidadeK,fig.cap="Sensibilidade da estatítica I de Moran e do p-valor associado em função do valor do parâmetro k"}
knitr::include_graphics("dados/csv_SoE/figuras/MoranI_k1ate100_PVALeSTAT.jpeg")
```


# Diagnóstico dos modelos mais plausíveis para descrever os propostos efeitos da paisagem no debate sobre ecologia de paisagens

## Fragmentação total

```{r}
l_dftabsel <- list()
l_md <- readRDS("dados/csv_SoE/rds/l_md_fragtotal.rds")
l_dftabsel$fragtotal <- f_TabSelGAMM(l_md)
md_fragtotal <- l_md[[df_tabsel$modelo[1]]]
rm(l_md);gc()
v_path <- "dados/csv_SoE/figuras/"
f_diag(hgam = md_fragtotal,
       v_path = "dados/csv_SoE/figuras/",
       vname = "Frag. total",
       patsave = "hgam")
```


## Fragmentação per se

```{r}
l_md <- readRDS("dados/csv_SoE/rds/l_md_fragperse.rds")
l_dftabsel$fragperse <- f_TabSelGAMM(l_md)
md_fragtotal <- l_md[[df_tabsel$modelo[1]]]
rm(l_md);gc()
v_path <- "dados/csv_SoE/figuras/"
f_diag(hgam = md_fragtotal,
       v_path = "dados/csv_SoE/figuras/",
       vname = "Frag. per se",
       patsave = "hgam")
```


## Área per se

```{r}
l_md <- readRDS("dados/csv_SoE/rds/l_md_areaperse.rds")
l_dftabsel$areaperse <- f_TabSelGAMM(l_md)
md_fragtotal <- l_md[[df_tabsel$modelo[1]]]
rm(l_md);gc()
v_path <- "dados/csv_SoE/figuras/"
f_diag(hgam = md_fragtotal,
       v_path = "dados/csv_SoE/figuras/",
       vname = "Área per se",
       patsave = "hgam")
rm(md_fragtotal);gc()
```



### todos os efeitos, procedimentos comuns


```{r}
df_tabsel <- lapply(names(l_dftabsel),\(li){
  mutate(l_dftabsel[[li]],efeito=li)
}) %>% do.call("rbind",.)
saveRDS(df_tabsel,"./5_resultados/df_tabsel_tehgam_efeitos.rds")
```



# Resultados por sítios de amostragem: parâmetros fitossociológicos, mapa contemporâneo, taxa U, congruência com a SAD observada e contrastes

Aqui vão os 105 cards dos sítios simulados 


