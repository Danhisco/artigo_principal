
# Apêndice: Informação de Suporte (SI)  {-#SI}

```{r setup4,include=FALSE,eval=FALSE}
# knitr::opts_chunk$set(echo = FALSE,eval = TRUE,message = FALSE,warning = FALSE,cache=TRUE,
#                       fig.pos = "H", fig.show = "hold",dpi = 72)
# # pacotes
# # library(dagitty)
# # library(ggdag)
# library(gt)
# library(gratia)
# library(sads)
# library(doMC)
# # library(metR)
# library(gridExtra)
# library(ggplot2)
# library(readr)
# library(purrr)
# library(stringr)
# library(tidyr)
# # library(MuMIn)
# # library(AICcmodavg)
# # library(insight)
# library(bbmle)
# library(DHARMa)
# library(mgcv)
# library(lme4)
# library(data.table)
# library(plyr)
# library(dplyr)
# library(flextable)
# source("source/nameModel.R")
# source("source/GAMMtools.R")
# source("source/general_tools.R")
# f_z <- function(x) (x-mean(x))/sd(x)
```

```{r trackdown chunk SI, include=FALSE,eval=FALSE}
# pacotes
library(trackdown)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
# upload_file(file ="apendices/A2_figuras_tabelas/A2_figuras_tabelas.Rmd",
#             gpath = "mestrado/artigo_principal/apendices/",
#             hide_code = TRUE)
update_file(file ="apendices/A2_figuras_tabelas/A2_figuras_tabelas.Rmd",
            gpath = "mestrado/artigo_principal/apendices/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file = "secoes_texto/Resultados/Resultados.Rmd",
              gpath = "mestrado/artigo_principal/secoes_texto/")
```

A delimitação política da Floresta Atlântica foi obtida do IBGE 2021 (@IBGE), acessado em março de 2025.

## Função de dispersão {.unnumbered}
<p>
No código a seguir há a inversa da Função de Distribuição Cumulativa (CDF) da distribuição de Laplace, que foi usada para gerar números aleatórios (em nosso caso, as distâncias de dispersão).
</p>


```{r codigo funcao de dispersao, echo=TRUE,include=FALSE,eval=FALSE}
# código em C++
int laplace(double sigma){
    double u;
    u = - genrand_real2() + 0.5;
    return ((int) (-sigma/sqrt(2.) * sign(u)*log(1-2*abs(u))));
 }
```

<p>
A distribuição de Laplace tem função de densidade descrita por:
</p>


$$ f(x) = \frac{1}{2b} \exp\left(-\frac{|x|}{b}\right) $$

No código em C++ sigma representa o desvio-padrão ($\sigma$) da distribuição de Laplace:

$$ \sigma = \sqrt{2} \cdot b $$
$$ b = \frac{\sigma}{\sqrt{2}} $$

 
## Tabela com as características de todos os sítios selecionados no TreeCo (n=109)   {.unnumbered}

```{r}
vcap <- "Características dos sítios dentro do critério de inclusão. (a) PBH : 'perimeter at breast height' e DBH : 'diameter at breast height'. (b) FPIM : Formacao pioneira sob influencia marinha - demais tipos são o padrão TreeCo"
```

```{r dados-disponiveis, tab.cap=vcap,warning=FALSE,message=FALSE,tab.width=12,results='asis'}
library(kableExtra)
select <- dplyr::select
rename <- dplyr::rename
df_dados_disponiveis <- read_csv(file = "~/Documentos/mestrado_Ecologia/artigo_principal/dados/df_dados_disponiveis.csv") %>% 
  mutate(LAT = ifelse(is.na(lat_correct),lat,lat_correct),
         LONG = ifelse(is.na(long_correct),long,long_correct),
         across(where(is.numeric),~round(.x,digits=2)),
         pert_class = factor(forest_succession,
                             levels=c("primary",
                                      "primary/secondary",
                                      "secondary",
                                      "capoeira"),
                             labels=c("baixa",
                                      "mediana",
                                      "alta",
                                      "altíssima")),
         forest_type_label = gsub("Formacao pioneira sob influencia marinha",
                                  "FPIM",
                                  forest_type) %>% 
           gsub("Contato ","",.),
         year_bestProxy = gsub("2012_2013","2012-2013",year_bestProxy)
         ) %>% 
  select(SiteCode, LAT, LONG, effort_ha, dbh_cutoff, Ntotal, S_obs, forest_type_label,
         pert_class, year_bestProxy)
##############################################
df_dados_disponiveis %>%
  # flextable() %>%
  # bg(bg = "white",part = "all") %>%
  # theme_vanilla() %>%
  # set_header_labels(
  #   SiteCode = "Código",
  #   LAT = "lat",
  #   LONG = "long",
  #   effort_ha = "Área (ha)",
  #   dbh_cutoff = "critério",
  #   Ntotal = "N",
  #   S_obs = "S",
  #   forest_type_label = "floresta",
  #   pert_class = "clas. pert.",
  #   year_bestProxy = "ano"
  #   ) %>%
  # bold(part = "header") %>%
  # colformat_num(digits = 2) %>%
  # align(align = "center", part = "all") %>%
  # flextable::footnote(i = 1, j = c(5,8),
  #          value = flextable::as_paragraph(
  #            c("PBH = 'perimeter at breast height' e DBH = 'diameter at breast height",
  #              "FPIM = Formacao pioneira sob influencia marinha - demais tipos são o padrão TreeCo")),
  #          ref_symbols = c("a", "b"),
  #          part = "header", inline = TRUE) %>% 
  # autofit() %>% 
  # fontsize(size = 8, part = "all") %>%
  # width(width = 0.4) %>%
  # padding(padding = 2, part = "all") %>%
  # set_table_properties(layout = "autofit")
  rename(
    "Código" = SiteCode,
    "lat" = LAT,
    "long" = LONG,
    "Área (ha)" = effort_ha,
    "critério" = dbh_cutoff,
    "N" = Ntotal,
    "S" = S_obs,
    "floresta" = forest_type_label,
    "clas. pert." = pert_class,
    "ano" = year_bestProxy
  ) %>%
  kable(
    format = "latex",
    digits = 2,
    align = "c",
    booktabs = TRUE,
    caption = "Tabela de dados disponíveis",
    longtable = TRUE  # Esta opção é crucial para tabelas longas
  ) %>%
  kable_styling(
    font_size = 8,
    latex_options = c("hold_position", "repeat_header")  # Repete cabeçalho em cada página
  ) #%>%
  # footnote(
  #   general = c(
  #     "a PBH = 'perimeter at breast height' e DBH = 'diameter at breast height'",
  #     "b FPIM = Formacao pioneira sob influencia marinha - demais tipos são o padrão TreeCo"
  #   ),
  #   general_title = "",
  #   footnote_as_chunk = TRUE,
  #   threeparttable = TRUE
  # )
```

## Exemplo de deslocamento da parcela para a vizinhança imediata   {.unnumbered}

```{r deslocamento parcela, eval=FALSE, include=FALSE}
library(purrr)
library(magick)
library(cowplot)
library(ggplot2)
img_to_gg <- function(img) {
  ggdraw() + 
    draw_image(img) +  # Scale de 0.9 para margens
    theme_void()
}
img <- image_read("../0_apendices/mapas_p_MNEE/figuras/exemplo_redesenho_parcela.png") %>% 
  image_trim()
plot <- img_to_gg(img)
saveRDS(plot,"09_SI/RDS/deslocamento_parcela.rds")
```

```{r desloc-parcela, fig.height=2,fig.width=4.5,fig.cap="Exemplo de deslocamenteo da parcela quadrada do centro da parcela para a vizinhança próxima."}
plot <- readRDS("./09_SI/RDS/deslocamento_parcela.rds")
plot
```

## Exemplo das três paisagens hipotéticas   {.unnumbered}

```{r criacao paisagens hipoteticas, eval=FALSE, include=FALSE}
img <- image_read("../figuras/exemplo paisagens hipoteticas-1.png") %>% 
  image_trim() 
altura_original <- 790
porcao_remover <- round(altura_original * 0.10)  # 20% de 790 = 158
nova_altura <- altura_original - porcao_remover
img_cropped <- image_crop(img, paste0("2723x", nova_altura, "+0+", porcao_remover))
plot <- img_to_gg(img_cropped)
saveRDS(plot,"09_SI/RDS/3paisagenship.rds")
```

```{r paisagens-hipoteticas, fig.cap="As 3 paisagem hipotéticas em paisagens com lado de 4 km: na esquerda, paisagem fragmentada; no centro, paisagem aglomerada; na direita paisagem prístina. Detalhes no texto principal",dpi=200}
plot <- readRDS("09_SI/RDS/3paisagenship.rds")
plot
```


## Mapas de cobertura florestal dos sítios simulados (n=105)   {.unnumbered}

```{r criacao de plot_matrix, eval=FALSE,include=FALSE}
img <- image_read("./0_apendices/EfeitoEscala/figuras/may2012_fi1a.png") %>% 
  image_trim()
combined_plot <- ggdraw() +
  draw_image(img, x = 0, y = 0, width = 0.5, height = 1) +  # Metade esquerda
  draw_plot(p, x = 0.5, y = 0, width = 0.5, height = 1)   # Metade direita
saveRDS(object = combined_plot,file = "0_apendices/EfeitoEscala/figuras/fig2comparacao_resultados.rds")
```
```{r criação de plot mat sitios, eval=FALSE, include=FALSE}
l_dfpred <- readRDS(file = "~/Documentos/mestrado_Ecologia/artigo_principal/dados/csv_SoE/rds/l_dfpred_md_cong_absoluta.rds")
vsites105 <- l_dfpred$fixo_e_aleat$SiteCode %>% unique
#
limg <- list.files(path="~/Documentos/mestrado_Ecologia/artigo_principal/dados/paisagens/png_land_sim",pattern = ".png",full.names = TRUE)
names(limg) <- gsub("~/Documentos/mestrado_Ecologia/artigo_principal/dados/paisagens/png_land_sim/","",limg) %>% 
  gsub(".png","",.)
limg <- limg[vsites105]
#
library(purrr)
library(magick)
library(cowplot)
library(ggplot2)
img_to_gg <- function(img) {
  ggdraw() + 
    draw_image(img) +  # Scale de 0.9 para margens
    theme_void()
}
# 
plot_matrix <- map(limg, img_to_gg) %>%
  plot_grid(
    plotlist = .,
    ncol = 10,  # 10 colunas
    nrow = 11,   # 11 linhas
    scale = 1  # Ajuste de espaçamento
  )
# 4. Exportar para PDF
ggsave("1_to_compile_dissertacao_EM_USO/09_SI/RDS/plot_matrix_105parcelas.png", plot_matrix, 
       width = 29.7, height = 21,  # Tamanho A4 em cm (landscape)
       units = "cm", dpi = 400,bg = "white")
saveRDS(plot_matrix,file = "1_to_compile_dissertacao_EM_USO/09_SI/RDS/plot_matrix_105parcelas.rds")
```

```{r mapas-sitios,fig.width=15,fig.height=16,dpi=400,fig.cap="Mapas de cobertura florestal das parcelas simuladas nas paisagens com lado de 4 km, detalhes no texto principal."}
# knitr::include_graphics("1_to_compile_dissertacao_EM_USO/09_SI/RDS/plot_matrix_105parcelas.png")
plot_matrix <- readRDS(file = "./09_SI/RDS/plot_matrix_105parcelas.rds")
plot_matrix
```


## Mapas em que não foi possível criar uma parcela quadrada   {.unnumbered}

```{r criacao sitios remov, eval=FALSE, include=FALSE}
limg <- c("0_apendices/mapas_p_MNEE/figuras/sitio_removido.png",
          "0_apendices/mapas_p_MNEE/figuras/sitio_removido_BAURUC.png")
limg <- lapply(limg,img_to_gg)
saveRDS(limg,file="1_to_compile_dissertacao_EM_USO/09_SI/RDS/mapas_semquadrado.rds")
```
```{r sitios-removidos, fig.cap="Parcelas removidas, detalhes no texto principal"}
p <- readRDS(file="./09_SI/RDS/mapas_semquadrado.rds")
grid.arrange(grobs=p,nrow=1)
```

## Sensibilidade da parametrização da estatística I de Moran  {.unnumbered}

<p>
Para avaliar a sensibilidade da estatística I de Moran usamos modelos mais simples do que os explorados no texto principal, exceto por 'land + land|Site' que é o mesmo descrito na tabela 1. Aqui a variável resposta continua sendo o número de SADs simuladas congruentes com as SADs observadas nas parcelas. As preditoras são mais simples, uma simplificçaão de land + land combinado com a limitação de dispersão (k) enquanto fator.
</p>

```{r criacao de MoranI,eval=FALSE,include=FALSE}
img <- image_read("~/Documentos/mestrado_Ecologia/artigo_principal/dados/csv_SoE/figuras/MoranI_k1ate100_PVALeSTAT.jpeg") %>% 
  image_trim()
plot <- img_to_gg(img)
saveRDS(plot,file="09_SI/RDS/moranI.rds")
```

```{r MoranI, fig.cap="Avaliação da sensibilidade do parâmetro livre da estatística I de Moran e do p-valor associado",dpi=200}
plot <- readRDS(file="./09_SI/RDS/moranI.rds")
plot
```




## Descrição estatística da congruência da SAD simulada e observada  {.unnumbered}

### MAGHs usados para descrever a congruência com a SAD observada  {.unnumbered#formulas-md-CONG}

```{r modelos usados na descrição, eval=FALSE, echo=TRUE}
library(mgcv)
f_gam <- \(vf,dfi){
  gam(formula=vf,
      family='binomial',
      data=dfi,
      method="REML")
}
l_f <- list()
# modelo cheio
l_f$`s(k,by=land + class_pert) + (lat,long)` <- 
  cbind(nSAD,100-nSAD) ~ 
  s(k,by=interaction(land,forest_succession),bs="cr",id="fixo") +
  s(lat,long) + 
  te(k,SiteCode,bs=c("cr","re"),by=land,id="random")
# modelo sem classe de perturbação
l_f$`s(k,by=land) + (lat,long)` <- 
  cbind(nSAD,100-nSAD) ~ 
  s(k,by=land,bs="cr",id="fixo") +
  s(lat,long) + 
  te(k,SiteCode,bs=c("cr","re"),by=land,id="random")
# modelo sem coordenadas
l_f$`s(k,by=land * class_pert)` <- 
  cbind(nSAD,100-nSAD) ~ 
  s(k,by=interaction(land,forest_succession),bs="cr",id="fixo") +
  te(k,SiteCode,bs=c("cr","re"),by=land,id="random")
# modelo sem cov
l_f$`s(k,by=land)` <- 
  cbind(nSAD,100-nSAD) ~ 
  s(k,by=land,bs="cr",id="fixo") +
  te(k,SiteCode,bs=c("cr","re"),by=land,id="random")
#
l_md <- lapply(l_f,f_gam,dfi=df_ad)
```


## Diagnóstico do modelo mais plausível para descrever a congruência absolusta com a SAD observada  {.unnumbered}

```{r criacao diag cong, eval=FALSE, include=FALSE}
img <- image_read("~/Documentos/mestrado_Ecologia/artigo_principal/dados/csv_SoE/figuras/diag_s(k,by=land + class_pert) + (lat,long)_te_pk.png") %>% 
  image_trim() %>%  
  image_resize("50%")
plot <- img_to_gg(img)
saveRDS(plot,file="09_SI/RDS/diag_cong.rds")
```
```{r diag-cong,dpi=200,fig.cap="Diagnóstico do modelo mais plausível para descrever a congruência da SAD simulada e SAD observada, detalhes no texto principal"}
plot <- readRDS(file="./09_SI/RDS/diag_cong.rds")
plot
```

## Descrição estatística de logUi/Uj de cada efeito da paisagem  {.unnumbered#formulasloUU}

```{r modelos usados para logUi/Uj, echo=TRUE,eval=FALSE}
library(plyr)
library(mgcv)
f_gam <- \(dfi){
  l_md <- list()
  l_md[[1]] <- gam(
    Uefeito ~ 
      te(p,k,
         bs=c("cr","cr"),m=2,
         id = "fixo") +
      s(k, SiteCode, 
        bs = "fs", xt=list(bs = "cr"), m=2, 
        id="efeito_sitio"),
    data=dfi, method = "REML")
  l_md[[2]] <- gam(
    Uefeito ~ 
      te(p,k,
         bs=c("cr","cr"),m=2,
         id = "fixo") +
      s(SiteCode,bs = "re"),
    data=dfi, method = "REML")
  names(l_md) <- c("~ te(p,k) + s(k)|Site",
                   "~ te(p,k) + 1|Site")
  return(l_md)
}
# contraste = efeito da paisagem (frag. total, frag. per se e área per se)
l_md <- dlply(df_logUU_pk,"contraste",f_gam)
```


## Diagnóstico dos modelos mais plausíveis para descrever a métrica funcional de cada efeito da paisagem  {.unnumbered}

### Fragmentação total  {.unnumbered}

```{r criacao diag FT, eval=FALSE, include=FALSE}
img <- image_read("~/Documentos/mestrado_Ecologia/artigo_principal/dados/csv_SoE/figuras/diag_fratotal_te_pk.png") %>% 
  image_trim() %>% 
  image_resize("50%")
plot <- img_to_gg(img)
saveRDS(plot,file="09_SI/RDS/diag_FT.rds")
```
```{r diag-FT, fig.cap="Diagnóstico do modelo estatístico mais plausível usado para descreve o efeito de fragmentação total.",dpi=200}
plot <- readRDS(file="./09_SI/RDS/diag_FT.rds")
plot
```


### Fragmentação *per se*  {.unnumbered}

```{r criacao diag FPS, eval=FALSE, include=FALSE, fig.cap="Diagnóstico do modelo estatístico mais plausível usado para descreve o efeito de fragmentação per se."}
img <- image_read("~/Documentos/mestrado_Ecologia/artigo_principal/dados/csv_SoE/figuras/diag_fragperse_te_pk.png") %>% 
  image_trim() %>% 
  image_resize("75%")
plot <- img_to_gg(img)
saveRDS(plot,file="09_SI/RDS/diag_FPS.rds")
```
```{r diag-FPS}
plot <- readRDS(file="./09_SI/RDS/diag_FPS.rds")
plot
```


### Área *per se*  {.unnumbered}


```{r criacao diag APS, eval=FALSE, include=FALSE}
img <- image_read("~/Documentos/mestrado_Ecologia/artigo_principal/dados/csv_SoE/figuras/diag_areaperse_te_pk.png") %>% 
  image_trim() %>% 
  image_resize("50%")
plot <- img_to_gg(img)
saveRDS(plot,file="09_SI/RDS/diag_APS.rds")
```
```{r diag-APS,fig.cap="Diagnóstico do modelo estatístico mais plausível usado para descreve o efeito de área per se."}
plot <- readRDS(file="./09_SI/RDS/diag_APS.rds")
plot
```

