---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup resultados,include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = TRUE,message = FALSE,warning = FALSE,cache=TRUE,
                      fig.align='center',tab.align='center')
# pacotes
library(grid)
library(gtable)
library(ggpubr)
library(gt)
library(flextable)
library(dagitty)
library(ggdag)
library(gratia)
# library(sads)
library(doMC)
# library(metR)
library(kableExtra)
library(gridExtra)
library(ggplot2)
theme_set(theme_bw())
library(readr)
# library(purrr)
library(stringr)
library(tidyr)
# library(MuMIn)
# library(AICcmodavg)
# library(insight)
library(bbmle)
library(DHARMa)
# library(mgcv)
library(lme4)
library(data.table)
library(plyr)
library(dplyr)
source("1_to_compile_dissertacao_EM_USO/00_Resultados/figuras_e_tabelas.R")
source("source/general_tools.R")
source("source/GAMMtools.R")
source("source/fig_tools.R")
# tamanho da fonte dos títulos dos gráficos dos resultados por síio de amosttragem (Umed e nCong)
v_titleS <- 1000
v_ncol_fatetwrap <- 14
figHeight=28
figWidth=40
textsize=1
#
f_z <- function(x) (x-mean(x))/sd(x)
##
# df p extensões
df_p_extensoes <- read_csv("dados/csv/df_p_extensoes.csv")
# df dados da proporção de cobertura vegetal
df_p <- read_csv("dados/df_p.csv")
# df dados para simulação
df_sim <- read_csv("dados/df_simulacao.csv") |> 
  inner_join(x=df_p,by="SiteCode")
# df_SoE
df_Usoe.rep <- read_csv("./dados/csv/df_Usoe.csv") |> 
  pivot_longer(cols=`1`:`10`, names_to = "n", values_to = "U") |> 
  inner_join(x=distinct(select(df_sim,SiteCode,effort_ha:S_obs)),by="SiteCode") |> 
  arrange(S_obs,k)
# df_Urep
df_Urep <- list.files(path = "./dados/csv/taxaU/MNEE", pattern = ".csv",recursive = T,full.names = T) %>%  
  adply(.,1,data.table::fread,.id=NULL) %>% na.omit()
# df_Unull
df_Unull <- df_Usoe.rep |> filter(round(lado_km) == 16)
## df_dados_disponiveis
df_dados_disponiveis <- read_csv(file = "dados/df_dados_disponiveis.csv")
## df_resultados 
df_resultados <- read_csv("dados/csv/resultados_MN/df_resultados.csv")
## df_sim
df_sim <- read_csv("dados/df_simulacao.csv")
## df_ad: dados completos, com todos os logOR e as proporções observadas para os 3 e as preditoras
# df_ad <- df_resultados |>
#   arrange(p) |> 
#   inner_join(distinct(select(df_sim,SiteCode,Ntotal:S_obs)),"SiteCode") |> 
#   mutate(diffS = (Smed - S_obs)/S_obs)
## df_contrastes: contrastes por sítio e grau de limitação de dispersão
df_contrastes <- read_csv(file="dados/csv/taxaU/df_contrastes.csv") |> 
  inner_join(df_sim |> select(SiteCode,Ntotal:S_obs) |> distinct(),
             by="SiteCode") |> 
  rename(N=Ntotal,S=S_obs) |> 
  mutate(across(N:S,log,.names="log.{.col}"),
         across(c(p,k,log.N:log.S),f_z,.names = "{.col}_z"),
         SiteCode = factor(SiteCode)) |> 
  select(-c(N:log.S))
## df_md: dados necessários para os modelos
df_md_Uefeito <- df_contrastes %>% 
  select(SiteCode:p, contains("_logratio")) %>% 
  pivot_longer(-c(SiteCode:p)) %>% 
  mutate(name = gsub("_logratio","",name),
         across(c(p,k),f_z,.names = "{.col}_z"),
         SiteCode = factor(SiteCode)) %>% 
  rename("tp_efeito"="name","v_efeito"=value)
## df_newdata
df_newpred <- read_csv(file="dados/csv/df_newpred.csv") |> 
  select(-starts_with("log_"))
## df_congContrastetsREP.cvs
df_contrastes <- df_contrastes %>%
  select(SiteCode:p, contains("_logratio")) %>% 
  mutate(across(-SiteCode,f_z,.names = "{.col}_z")) %>% 
  select(SiteCode,k,p,k_z:frag.total_logratio_z) %>% 
  rename_with(~str_remove(.,"_logratio_z")) %>% 
  pivot_longer(cols = c("area","frag.perse","frag.total"),
               values_to = "Uefeito",
               names_to = "contraste") %>% 
  mutate(contraste = case_when(contraste=="area" ~ "non_frag-ideal",
                               contraste=="frag.total" ~ "contemp-ideal",
                               contraste=="frag.perse" ~ "contemp-non_frag"))
# precisa ainda?
df_plot <- fread("dados/csv/df_plot_geral.csv")
# themes
basic_theme <- function(data, ...){
  data %>% 
    tab_options(
      table.background.color = "white",
      ...
    )
}
## congruência 
df_adSAD <- readRDS("5_resultados/df_adSAD.rds")
df_adSADifself <- adply(c("contemp","ideal","non_frag"),1,\(i){
  df_return <- df_adSAD %>% filter(taxaU==i & land_type==i) %>% 
    select(-land_type,-c(Smed:Smax)) %>% 
    rename("contrafactual"="taxaU",
           "nCong"="nCongKS")
  inner_join(df_return,
             df_contrastes %>% 
               filter(contraste=="non_frag-ideal") %>% 
               select(SiteCode:p,ends_with("_z")),
             by=c("SiteCode","k"))
},.id=NULL)
# tabelas para o texto
# df_quantisobs_Uefeito <- read_csv(file=paste0(v_path,"tabelas/df_quantisobs_Uefeito.csv"))
df_quantisobs_Uefeito <- read_csv(file=paste0("./","tabelas/df_quantisobs_Uefeito.csv"))
l_quants_contrasteU <- lapply(df_quantisobs_Uefeito$`Contraste log(U/U)`,\(i){
  dfi <- df_quantisobs_Uefeito %>% 
    filter(`Contraste log(U/U)`==i) %>% 
    select(1,starts_with("exp"))
  dfi <- dfi %>% select(all_of(grep("0.05|0.95",names(dfi),value = T))) %>% as.data.frame()
  v_return <- dfi[,2] - dfi[,1]
  round(v_return,2)
})
names(l_quants_contrasteU) <- df_quantisobs_Uefeito$`Contraste log(U/U)`
```

```{r trackdown chunk resultados, include=FALSE,eval=FALSE}
# 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
# pacotes
# install.packages("trackdown")
library(trackdown)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
# upload_file(file="secoes_texto/Resultados/Resultados.Rmd",
#             gpath="mestrado/artigo_principal/secoes_texto/",
#             hide_code=TRUE)
update_file(file ="1_to_compile_dissertacao_EM_USO/00_Resultados/Resultados.Rmd",
            gpath = "mestrado/artigo_principal/secoes_texto/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file = "secoes_texto/Resultados/Resultados.Rmd",
              gpath = "mestrado/artigo_principal/secoes_texto/")
```

## Inventários Florestais na Floresta Atlântica

Dos sítios presentes na base de dados TreeCo, 109 estavam dentro dos critérios de seleção. As coordenadas dos sítios variaram entre -31° e -7° de latitude e entre -55° e -35° de longitude (fig. \@ref(fig:GE-sitios-amostrados) a). A maioria dos trabalhos foi realizada  em áreas de florestas classificadas como primárias no TreeCo. Apenas 2 sítios possuíam menos de 20 anos de recuperação desde o último grande distúrbio na área e foram removidos (fig. \@ref(fig:GE-sitios-amostrados) c). A mediana da área amostrada foi de 1 ha; o número de indivíduos amostrados mediano foi de 1540 indivíduos; a riqueza observada mediana foi de 107 espécies; e o ano de amostragem ou publicação variou entre 1986 e 2016 (fig. \@ref(fig:GE-sitios-amostrados) b). Portanto, todos os 107 sítios restantes possuem paisagens contemporâneas na base de mapas de cobertura vegetal do mapbiomas 6. Não foi possível estimar a taxa U em um sítio com baixa densidade de espécies por número de indivíduos e de baixa proporção de cobertura vegetal na paisagem ao redor. Em outro sítio não foi possível desenhar a parcela quadrado no centro da paisagem devido a configuração espacial da paisagem. Esses dois sítios foram removidos, totalizando 105 sítios simulados.
 

```{r caption GE dados disponiveis,eval=TRUE,include=TRUE}
cap <- "Sítios selecionados na base de dados TreeCo. a) Coordenadas geográficas e proporção de cobertura florestal nas paisagens contemporâneas aos eventos de amostragem com extensão espacial de 4 x 4 km2. b) Características gerais dos inventários, da esquerda para a direita: número de indivíduos amostrados, área da parcela amostrada, número de espécies observado, ano de amostragem. c) Proporção de cobertura florestal na paisagem ao redor da parcela amostrada em função do lado da paisagem ao redor. d) Contagem do número de sítios pelas classes de perturbação usadas no TreeCo, que consideram tanto o tempo desde a última grande perturbação quanto o grau de perturbação."
```
```{r pring GE dados disponiveis,eval=TRUE,include=TRUE,fig.cap=cap}
knitr::include_graphics(path="./figuras/GE_dados_disponiveis.png")
```

## Escala espacial adequada para simular os contrafactuais

Para avaliar qual a escala espacial adequada, investigamos o comportamento da taxa U,  parâmetro livre para aproximar a riqueza observada, em paisagens sem perda de cobertura florestal. A taxa U estimada nos graus de limitação de dispersão simulados nas paisagens com maior extensão espacial (paisagem quadrada de lado 16 km) é qualitativamente similar ao estimado em paisagens infinitas (figura A1 2). Em paisagens infinitas e sem perda de habitat a taxa U necessária para manter uma determinada riqueza na parcela apresenta um máximo global quando o grau de limitação de dispersão é pouco severa (@may2012dispersal). Em graus de limitação à dispersão severa a taxa U estimada é baixa, pois a perda de espécies é pequena: a maior parte das substituições ocorre entre coespecíficos. Com o relaxamento da limitação de dispersão a perda de espécies aumenta com a redução da substituição de coespecíficos, aumentando a perda de espécies por deriva ecológica. Com o aumento da capacidade de dispersão para além de graus pouco severos, há o aumento da contribuição de subpopulações mais distante da parcela, reduzindo novamente a estimativa da taxa U à custa da homogenização na escala da paisagem (REF). 
<!-- Portanto, concluímos que foi adequado utilizar a maior extensão espacial (de lado 16km) como referência de extensão espacial suficiente para simular todos os graus de limitação de dispersão. 
Agrupamos, por sítio de amostragem e grau de limitação de dispersão, as estimativas da taxa U simuladas em paisagens com o lado aumentando de 0.5 km até 16 km. 
-->

O padrão por sítio difere do padrão geral da médio, pois a mudança dos valores da taxa U não é sempre continua, pode ocorrer em patamares. Em graus de limitação de dispersão severos a média da taxa U se mantém baixa e com pouca variação entre graus de limitação de dispersão severos, formando um primeiro patamar de valores baixos (Fig Efeito de Escalar 2a e 2b). Com o relaxamento para graus pouco severos, há um salto na média da taxa U, que pode se manter por alguns graus de limitação de dispersão pouco severos (Fig Efeito de Escalar 2a e 2b). Com o maior relaxamento da limitação de dispersão para graus brandos, há a redução gradual da média da taxa U até valores similares ao observado em graus severos de limitação de dispersão (Fig Efeito de Escalar 2a e 2b). O tamanho dos patamares e a forma com que a redução na taxa U ocorre parece depender de uma relação não trivial entre número de indivíduos, número de espécies e grau de limitação de dispersão (figura Efeito de Escalar 2b).

Para descrever a variação na taxa U associada à variação na extensão espacial para um determinado grau de limitação de dispersão, exploramos um modelo gaussiano em que a taxa U média pode ser descrita em função do número de espécies e indivíduos (na escala log) e do grau de limitação de dispersão e da extensão espacial (como variáveis categóricas) com um intercepto aleatório por sítio de amostragem (detalhes no apêndice ‘Efeito de Escalar’). Avaliamos, por grau de limitação de dispersão, como a média variou em função do aumento da extensão espacial da paisagem. A escala que acumulou a maior parte da variação total (de aumentar o lado da paisagem local de 0.5 km até 16 km) foi considerada como escala adequada para aquele grau de limitação de dispersão. Essa abordagem pressupõe que o efeito de escalar é monotônico. 

Observamos que a extensão espacial mínima adequada tende a aumentar com a redução da limitação de dispersão (Figura 3), exceto em graus de limitação de dispersão pouco severos, nos valores intermediários simulados (Fig Efeito de Escalar 2a e 2b). Nesses graus de limitação de dispersão intermediários há pouca variação na média da taxa U entre escalas e sempre grande variação entre réplicas de uma mesma bateria de simulações (Fig Efeito de Escalar 2a, A1 2b e A1 4b). Quando a proporção de propágulos que permanece até a vizinhança imediata do progenitor (k) varia entre 0.99 e 0.90, a extensão espacial da paisagem adequada é de 1 km de lado (Figura 3). Para k entre 0.80 e 0.55, que corresponde ao campo de parâmetros com máximo global, não é possível determinar uma tendência de redução da média da estimativa de U (Figura 3); a variação entre escalas para um mesmo sítio é baixa (Figuras Efeito de Escalar 2 e A1 3). Em k entre 0.50 e 0.35 a extensão adequada foi de 1 km de lado; entre 0.30 e 0.20, 2 km de lado; e entre 0.15 e 0.05, 4 km de lado (Figura Efeito de Escalar 5 e 6). Pressuposto que a extensão espacial adequada para simular k entre 0.80 e 0.55 pode ser obtida interpolando as escalas adequadas, então nesses graus de limitação de dispersão a extensão suficiente é de 1 km de lado da paisagem ao redor. Uma vez que a paisagem com 4 km de lado foi suficiente para simular todos os graus de limitação de dispersão todas as simulações serão feitas nessa extensão e tambeḿ o calculo da proporção de cobertura florestal. Não simulamos paisagens com lado de 1 km e 2 km, que foram adequadas para os graus de limitação de dispersão de 0.99 até 0.35 e de 0.35 até 0.20, respectivamente.

```{r cap fig5_SoE}
cap <- "A extensão espacial é um dos fatores que determina as medidas tomadas das características da paisagem. No conjunto de áreas analisadas há uma forte relação entre a extensão espacial da paisagem ao redor e a proporção de cobertura vegetal. a). O objetivo do estudo do efeito de escalar foi determinar a extensão espacial adequada para simular os 20 graus de limitação de dispersão. c). Definimos a escala adequada para um grau de limitação de dispersão como a extensão espacial que acumula a maior parte da variação na estimativa da taxa U associada ao aumento da extensão espacial da paisagem ao redor, considerando a amplitude de extensões do lado da paisagem local entre 0.5 km e 16 km. Para detalhes sobre os métodos  do estudo de efeito de escalar veja o apêndice ‘Efeito de Escalar’. Nesse  estudo, 36 sítios foram sorteados e selecionados ao longo do gradiente de número de indivíduos e de espécies na parcela. b). Para esse estudo, as estimativas da taxa U foram simuladas em paisagens totalmente preenchidas com habitat, para descontar o efeito do isolamento estrutural, e explorar apenas o efeito de variar a extensão da paisagem ao redor."
```
```{r figura SoE, eval=TRUE,include=TRUE,fig.cap=cap}
knitr::include_graphics(path = "./figuras/fig5_SoE.png")
```

##[a] Práticas ontológicas em disputa coexistindo em um sistema epistêmico contrafactual baseado em indivíduos[b][c][d][e]

No dispositivo de mimese, à medida que propágulos entram e saem da parcela, a riqueza e a abundância relativa das espécies locais são influenciadas pela paisagem, que determina a quantidade, posição e distância dos progenitores remanescentes. O modelo é calibrado para capturar a influência da paisagem na riqueza de espécies, expressa na taxa U, levando em conta a limitação de dispersão per capita. Essa taxa corresponde à probabilidade de colonização por uma nova espécie na paisagem necessária para atingir a riqueza observada. A validação empírica ocorre pela avaliação da congruência da distribuição de abundância de espécies (SAD) observada e simulada em um particular contrafactual, e, portanto, considera simultaneamente a influência da paisagem na riqueza e abundância relativa da paisagem. Buscamos quantificar os efeitos da paisagem — área per se, fragmentação per se e fragmentação total — como previstos pelas práticas ontológicas em disputa, na congruência da SAD simulada. Para isso, contrastamos pares de contrafactuais, calculando os efeitos causais médios da paisagem na congruência da SAD simulada (REF ABM causal inference). Esses efeitos foram descritos por modelos hierárquicos aditivos generalizados (HGAMs): o log da razão da chance da SAD simulada ter boa congruência (logOR) em função do log da razão da taxa U (log(U/U)) e da proporção de propágulos que permanecem na vizinhança imediata (k). A seguir apresentamos o log(U/U) estimado em função de k, e então descrevemos a tendência central dos efeitos da paisagem na congruência da SAD simulada.



















### Métrica funcional da influência da paisagem na biodiversidade local

Aqui interpretamos como métrica de influência da paisagem na biodiversidade local a razão entre a taxa U estimada nas paisagens contrafactuais em contraste.
Para um mesmo grau de limitação de dispersão, quanto menor a taxa U necessária para obter a riqueza observada, maior é a reposição simulada de espécies pela imigração de propágulos da paisagem ao redor para a parcela. Assim, se o log da razão das taxa U (logU/U) estimadas nas paisagens contrafactuais em contraste for igual a zero não há diferença entre contrafactuais com relação a reposição de espécies locais pela paisagem. Se for positivo, então a paisagem contrafactual no numerador apresenta taxa U superior; e se for negativo o contrário, o denominador apresenta valor superior. 

```{r tabela dos quantis observados dos contrastes}
df_quantisobs_Uefeito <- read_csv(file=paste0("./","tabelas/df_quantisobs_Uefeito.csv"))
# df_quantisobs_Uefeito <- read_csv(file=paste0(v_path,"tabelas/df_quantisobs_Uefeito.csv"))
# df_quantisobs_Uefeito <- df_quantisobs_Uefeito %>% 
#   mutate(`Prática Ontológica` = ifelse(grepl("Frag. total",`Contraste log(U/U)`),
#                                        "Interdependente","Independente")) %>% 
#   relocate(`Prática Ontológica`)
knitr::kable(df_quantisobs_Uefeito,
             caption = "Quantis observados dos contrastes na taxa U previstos em cada prática ontológica.")
```



Cada razão entre taxa Us representa um previsto efeito da paisagem: área per se, fragmentação per se e fragmentação total. 
Nos 3 efeitos, a maior parte dos valores de logU/U ocorre na mesma faixa de valores de paisagens com pouca cobertura florestal, porém em paisagens com perda de cobertura florestal logU/U pode aumentar em magnitude se a limitação de dispersão for branda ou muito severa (fig. \@ref(fig:GE-contraste_taxaU)). Os valores em paisagens sem perda de cobertura florestal ocorrem ao redor do zero, com valores negativos e positivos (fig. \@ref(fig:GE-contraste_taxaU)).
O efeito que apresenta menor amplitude de valores é o de área per se, enquanto o efeito de fragmentação total apresenta a maior amplitude (fig. \@ref(fig:GE-contraste_taxaU)). 
Em alguns sítios, o logU/U do efeito de fragmentação per se pode ser menor do que o observado em paisagens sem perda de cobertura florestal (fig. \@ref(fig:GE-contraste_taxaU)).  
A amplitude dos valores aumenta com a redução do grau de preservação da área amostrada para todos os 3 efeitos (fig. \@ref(fig:GE-contraste_taxaU)). 
Nos graus de limitação de dispersão pouco severos, onde há o máximo global na estimativa da taxa U em paisagens sem perda de habitat (olhar seção ‘Efeito de Escalar’), ocorre a menor variabilidade entre os contrafactuais (fig. \@ref(fig:GE-contraste_taxaU)).

```{r caption figura exploratoria da taxa U}
cap <- "Contrastes na taxa U estimada em pares de paisagens contrafactuais, previstos em cada prática ontológica (tabela X). a) Distribuição dos valores de cada contraste; em vermelhos os quantis de todos os contrastes observados em paisagens com proporção de cobertura florestal igual ou superior 0.95. b) Contraste por sítio de amostragem, pontos ligados pelo sítio de amostragem e coloridos pela proporção de cobertura florestal remanescente."
```
```{r GE-contraste_taxaU, include=TRUE,eval=TRUE,fig.cap=cap}
knitr::include_graphics(path="./figuras/GE_taxaU_contrastes.png")
```

### Descrição dos efeitos causais médios da paisagem na congruência da simulação da biodiversidade local



Os efeitos causais médios da paisagem foram calculados empíricamente com o log odds ratio (logOR). Quando a congruência da SAD simulada em ambos contrafactuais em contraste é igual, o valor de logOR é zero. Se o contrafactual do numerador apresenta maior proporção de SADs com boa congruência. então o logOR será maior do que zero, vice-e-versa se o logOR for negativo. Nosso objetivo é descrever os efeitos totais da paisagem na congruência relativa da SAD simulada. O sistema epistêmico usado para estimar esses efeitos impõem uma estrutura hierárquica aos dados, pois, simula diversos cenários de dispersão em diferentes tipos de paisagens contrafactuais para cada área amostrada. Nessa situação, dados com estrutura hierarquicas podem ser usados para estimar efeitos causais não enviesados (Feller & Gelman 2015; Weinstein & Blei 2024). A lógica é que, uma vez que o sítio de amostragem é sempre o mesmo, todas as possíveis covariáveis estão fixas. A descrição do logOR em função de k (proporção de propágulos que permanece até a vizinhança imediadata do progenitor) e do logU/U (métrica que expressa o efeito da paisagem) pode descrever o efeito completo da paisagem. O efeito completo descreve tanto o efeito na riqueza quanto o efeito na abundância relativa de espécies locais. Para isso, utilizamos como preditoras a métrica funcional de influência da paisagem na riqueza, e a capacidade de dispersão simulada para representar qualquer efeito da paisagem na abundância relativa não contemplado pelo efeito da métrica funcional. 
 
Para cada efeito causal médio da paisagem (área per se, fragmentação per se e fragmentação total), comparamos, via AICc (REF), 7 modelos hierarquicos aditivos generalizados (detalhes em Pedersen et al. 2019): i) com um tensor entre k e logU/U comum e com um tensor dessas duas variáveis por sítio de amostragem (com o tensor por sítio compartilhando o parâmetro de penalizado com o tensor comum); ii) com um tensor entre k e logU/U comum e apenas um intercepto por sítio; iii) 1 spline comum para logU/U e com um spline por sítio (compartilhando a penalização); iv) 1 spline para logU/U e com apenas 1 intercepto por sítio; v) 1 spline comum para k e por sítio (compartilhando a penalização); vi) 1 spline comum para k e apenas 1 intercepto por sítio; vii) 1 intercepto comum e por sítio. 









Para os três efeitos causais da paisagem (área per se, fragmentação per se e fragmentação total), o modelos mais plausível é um modelo generalizado hierarquico aditivo que utiliza um parâmetro de penalização comum entre o spline fixo e os splines por sítio (Pedersen et al., 2019). E o segundo modelo mais plausível utiliza um parâmetro de penalização para cada spline por sítio (Pedersen et al., 2019). Em todos os modelos comparados existe boa evidência a favor da hipótese nula de ausência de autocorrelação espacial nos resíduos (o menor p-value from the Moran’s I statistics = 0.33, figura X tabelas).

__Área per se__

O modelo mais plausível, que explica cerca de 47% da deviance, supera o segundo modelo mais plausível por 91.62 AICc unidades. Esse modelo não apresenta boa performance em todo o gradiente da preditora (FIG. DIAG). Quando o log da razão da taxa U é próximo de zero pode existir grande variação no log odds ratio em alguns sítios, que não é possível ser descrito apenas em função do log da razão da taxa U (FIG. DIAG por sítio).[f] 

O efeito causal médio fixo descrito pelo modelo mais plausível apresenta padrão não linear, variando entre log odds ratio negativo e positivo ao longo dos valores do log da razão da taxa U (figura X). O efeito causal médio por sítio também apresenta padrão não linear, mas pode apresentar grande variabilidade entre sítios e em relação ao efeito fixo (figura X). Em valores negativos de log razão U, o efeito fixo apresenta uma tendência sútil para log odds ratio negativos; no nível dos sítios, há grande diversidade - existem sítios em que a tendência é de log odds ratio positivo, enquanto em outros é similar ao efeito fixo (FIGURA X). Para log razão U entre 0 e cerca de 0.30, o efeito fixo ocorre em valores positivos de log odds ratio aumentando e depois diminuindo. Nos sítios, alguns seguem o padrão fixo, mas com pico mais elevado, enquanto outros sítios apresentam tendência de queda para valores negativos de log odds ratio (FIGURA X). Para log razão U entre 0.30 e 0.50, o efeito fixo e por sítio apresentam tendência de queda. Nessa faixa, o efeito fixo varia entre 0 e -2.5 log odds ratio; os sítios que apresentavam log odds ratio positivo podem cruzar para valores negativos ou permanecerem próximos de zero. Poucos sítios apresentam log da razão U acima de 0.50, o efeito fixo volta a subir, retornando a valores positivos de log odds ratio quando o log razão U é próximo de 1. Nessa faixa a maioria dos sítios ocorre em log odds ratio negativo e a maioria apresenta tendência de aumento, mas nunca chegam a ter valores positivos de log odds ratio (Figura X). 
__Fragmentação per se__

O modelo mais plausível, que explica cerca de 60% da deviance, supera o segundo modelo mais plausível por 93.69 AICc unidades. Esse modelo não apresenta boa performance em todo o gradiente da preditora (FIG. DIAG). Quando o log da razão da taxa U é próximo de zero pode existir grande variação no log odds ratio em alguns sítios, que não é possível ser descrito apenas em função do log da razão da taxa U (FIG. DIAG por sítio).[g] 





######## PRÓXIMO ARTIGO: COVARIÁVEIS E MODEL AVERAGING ABM-REGRESSION CAUSAL EFFECT ESTIMATION ? ########[h]

Para fazer a quantificação do efeito causal a partir de análises de regressão é necessário avaliar se existem covariáveis que precisam ser ajustadas para obter medidas não enviesadas deste efeito causal (REF). 
Em uma proposta de início de conciliação das práticas ontológicas (VALENTE ET AL. 2023), existe um consenso de que a resposta do efeito da paisagem na manutenção da biodiversidade local deve depender do contexto da amostragem (REF). O contexto biogeográfico pode ser um desses fatores que pode modificar o efeito da paisagem (revisado EM VALENTE ET AL. 2023) e também é um fator que deve influenciar a biodiversidade local (REF),[i] sendo, portanto, uma variável de confusão (pelo critério da porta dos fundos) (REF). Outra possível variável de confusão é a classe de preservação do sítio de amostragem, pois, além de ter sido usada como critério de inclusão dos inventários florestais, pode apresentar uma variável de confusão não mensurada com o grau de modificação da paisagem contemporânea, uma vez que locais com baixo grau de preservação também podem estar em paisagens com grande grau de mudança na cobertura florestal remanescente[j][k] (REF). Assim, um possível DAG, que engloba qualquer um dos três efeitos previstos nas duas práticas ontológicas, está descrito na figura X, onde é possível concluir [l]que é necessário incluir variáveis que descrevam o contexto biogeográfico da amostragem e também do grau de preservação da área amostrada. Utilizamos o ano do inventário florestal e a coordenada central do sítio de amostragem como possíveis aproximações do contexto biogeográfico[m].

```{r caption DAG covariaveis}
cap <- "Grafo Acíclico Dirigido (da sigla em inglês DAG) a partir da interpretação de Valente et al. (2023), artigo de revisão e conciliação parcial das práticas ontológicas em disputa. Se as variáveis em vermelho forem incluídas no modelo de regressão, modelos sem estrutura hierarquica podem ser usados para estimar o efeito em investigação (REF) - a influência da paisagem na biodiversidade local. A biodiversidade local (biodiv. local) foi aproximada pela congruência relativa da SAD simulada em cada contrafactual em comparação com a SAD observada. O efeito da paisagem representa o efeito proposto a ser investigado, ele é obtido pelo log da razão da taxa U necessária para obter a riqueza observada em cada contrafactual em comparação. Cada prática ontológica possui contrastes de contrafactuais que oferecem resultados interpretaveis. O contexto biogeográfico foi aproximado pela data do inventário florestal e da coordenada central da área amostrada. A preservação local é uma variável categórica que depende do histórico e do grau de perturbação da área amostrada, pressupomos que deve existir uma covariável não observada que influencia tanto o grau de preservação local da área amostrada quando a modificação da paisagem ao redor. Pelo critério de porta dos funtos as variáveis contexto biogeográfico e preservação local devem ser incluídas no modelo para que o efeito causal em investigação possa ser estimado de forma adequada (REF)."
```
```{r dag ajuste de covariaveis}
# knitr::include_graphics(path=paste0(v_path,"figuras/DAG_var_de_controle.png"))
knitr::include_graphics(path="./figuras/DAG_var_de_controle.png")
```

Por outro lado, o sistema epistêmico usado para estimar esses efeitos impõem uma estrutura hierarquica aos dados, pois, simula diversos cenários de dispersão em diversos tipos de paisagens contrafactuais para cada área amostrada. Nessa situação, modelos hierarquicos podem ser usados para estimar efeitos causais que podem ser não enviesados, mesmo com covariáveis não mensuradas (Feller & Gelman 2015; Weinstein & Blei 2024). A lógica é que, uma vez que o sítio de amostragem é sempre o mesmo, todas as possíveis covariáveis estão fixas, assim, os contrastes entre os contrafactuais simulados oferecem medidas não enviesadas de efeito causal (REF). Portanto, pode não ser necessário incluir as variáveis que aproximam o contexto da amostragem para fazer a estimativa do efeito causal.[n]

Nós comparamos modelos hierarquicos para avaliar a maneira mais apropriada para estimar o efeito causal médio[o]. Primeiro avaliamos formas de expressar o efeito causal médio da paisagem por sítio de amostragem. Para isso a estrutura fixa dos modelos se manteve o mais cheio possível: com 1 intercepto por classe de preservação; 1 spline para efeito de paisagem por classe de preservação; 1 spline para o efeito do ano de amostragem; e 1 spline para o efeito da coordenada geográfica.[p] A partir dessa estrutura fixa foram explorada 3 formas de expressar o efeito da paisagem por sítio de amostragem (REF GAMM 2019) : com 1 spline por sítio de amostragem, em que cada sítio apresenta um parâmetro de penalidade, conferindo maior flexibilidade por sítio; com 1 spline por sítio de amostragem, mas com o mesmo parâmetro de penalidade que o efeito fixo da paisagem, com menor flexibilidade por sítio de amostragem; e 1 intercepto por paisagem. [q]Um modelo sem efeito fixo da paisagem e 1 intercepto por sítio de amostragem foi incluido para representar a ausência de efeito da paisagem por sítio. Caso o modelo mais plausível seja algum dos 3 primeiros modelos, com efeito de paisagem, é possível avaliar qual o conjunto de variáveis mais adequado para descrever o efeito causal médio da paisagem, dado o efeito causal médio da paisagem por sítio. [r]

Para avaliar os modelos usamos o AICc, uma medida que pondera o número de parâmetros do modelo e quanto esse modelo representa dos dados (REF). O peso de evidência, medido a partir do AICc, pode ser interpretado como a probabilidade do modelo ser o modelo correto entre os modelos candidatos (REF). Essas métricas podem ser usadas para comparação relativa dos modelos considerando a possibilidade de overfitting (REF).
Outra métrica relevante na ĩnferência causal é alguma que quantifique qual a variabilidade dos dados expressa pelo modelo, pois permite avaliar a influência do efeito investigado na geração dos dados (REF LAND USE SISTEM CAUSAL INFERENCE REF). Aqui utilizamos a deviance explained, métrica usada no contexto de GAMM, que possui interpretação similar ao R2 (REF). 
Por conta da natureza agregada dos inventários florestais[s] e com possibilidade de agregação na modificação da paisagem ao redor (FIGURA 1 INVENTÁRIOS FLORESTAIS), avaliamos se os resíduos dos modelos apresentam algum tipo de autocorrelação espacial a partir da estatística 1 de Moram. O valor da estatística 1 de Moran varia entre -1 e 1, indicando autocorrelação negativa e positiva, respectivamente. Se o p-valor associado a estatística 1 de Moran for muito baixa, então a hipótese nula de que não existe autocorrelação espacial tem pouco suporte (REF).
Como aproximamos a possível autocorrelação espacial por 1 spline para a coordenada central, autocorrelação positiva pode ser bem expressa, uma vez que splines são desenhados para garantir a continuidade entre valores próximos (REF). Se a autocorrelação espacial for negativa, o spline pode ser uma aproximação ruim, pois não é adequado para estimar mudanças desrupitavas entre valores próximos (REF).  

Assim, é possível fazer algumas perguntas sobre os modelos explorados:[t]
- Qual a melhor forma de expressar o efeito da paisagem por sítio? 
- O efeito médio da paisagem, dado os efeitos médios da paisagem por sítio de amostragem, apresentam alguma influência na congruência da SAD simulada com a SAD observada? Existe alguma tendência geral? 
- Os efeitos da paisagem apresentam grande influência nos dados observados?
- Qual a melhor forma de estimar o efeito causal médio da paisagem a partir dos possíveis conjuntos de covariáveis de ajuste, dado a estrutura hierarquica do modelo de regressão?

#### Qual a melhor forma de expressar o efeito da paisagem por sítio? 

##### Comparação dos modelos usados para descrever o efeito da paisagem na congruência relativa com a SAD observada por sítio de amostragem
```{r tabela de selecao com plot, eval=TRUE,include=TRUE}
knitr::include_graphics(path="./figuras/tabsel_aleat.png")
```

Para todos os efeitos previsto nas práticas ontológicas (efeito de área per se, efeito de fragmentação per se, e efeito de fragmentação total) existe um GAHM que pode ser considerado o mais plausível para descrever o efeito da paisagem por sítio de amostragem, pois acumula a maior parte do peso de evidência. No caso do efeito de área per se o GAHM mais plausível apresenta menor flexibilidade[u] por sítio de amostragem, enquanto para os outros dois efeitos (fragmentação per se e fragmentação total) o GAHM mais plausível apresenta maior flexibilidade[v] por sítio de amostragem. 
Para todos os GAHM explorados, o p-valor da estatística I de Moran apresenta valores altos (acima de 5%, linha verde horizontal nos gráficos), indicando que a hipótese nula de ausência de autocorrelação espacial nos resíduos dos GAHM tem bom suporte. 
A deviance explicada é maior nos modelos que consideram algum efeito da paisagem por sítio de amostragem (com maior ou menor flexibilidade por sítio). A deviance explicada dos modelos mais plausíveis são: 0.78 para o efeito de fragmentação total, 0.58 para o efeito de fragmentação per se, e 0.41 para o efeito de área per se. Os modelos que consideram o efeito da paisagem com menor flexibilidade por sítio, apresentam deviance explicada um pouco menor.

#### Qual a melhor forma de estimar o efeito causal médio da paisagem a partir dos possíveis conjuntos de covariáveis de ajuste, dado a estrutura hierarquica do modelo de regressão?

Determinada a melhor forma de expressar o efeito da paisagem por sítio de amostragem, é possível avaliar qual o conjunto de covariáveis fixas é adequado para estimar o efeito causal médio da paisagem. Um possível próximo passo é avaliar se é necessário estimar um efeito de paisagem por classe de preservação, dado que pode existir um intercepto por classe de preservação[w]. Se não for necessário, os modelo candidatos terão na estrutura fixa, além do efeito da paisagem, 1 intercepto por classe de preservação[x], 1 spline por ano do inventário florestal, 1 spline por coordenada geográfica. Nesse caso os modelos derivados do modelo cheio serão obtidos pela remoção de efeitos fixos 1 a 1, 2 a 2 ou de todos as covariáveis.[y] Se for necessário estimar um efeito de paisagem por classe de preservação, então a mesma operação será feita para obter o conjunto de modelos candidatos, porém o intercepto por classe de preservação será mantido em todos os modelos. Caso a maior parte do peso de evidência não se acumule em um único modelo, o conjunto de modelos candidatos 
[a]Para a discussão:
Em ambas práticas ontológicas primeiro alguma característica da paisagem, que interpreta-se estar relacionada com a biodiversidade local, é mensurada e então é quantificado o efeito desta métrica da paisagem na biodiversidade local. Esse sequência epistemológica é comum em estudos de estimativa de efeito causal médio a partir de modelos de regressão (REF).
[b]Para discutirmos: seriam ontologias coexistindo num sistema epistêmico, ou práticas epistemicas comuns a duas ontologias?
[c]Estava lendo o "Anarquismo Ontológico e Verdade no Antropoceno" e entendo que estamos em uma situação que o Mauro de Almeida chamaria de pseudo ontologias ou pseudo mundos, umas vez que ambas práticas ontológicas se baseiam em um mesmo mundo ecológico, de processos demográficos. Entendo que a ideia de práticas epistêmicas comuns não se aplica aqui, pois eu entendo que elas diferem em como fazem atribuição de causa, por exemplo, na revisão de frag. per se ou de SLOSS da Fahrig 2017 e 2020 a Fahrig não utilizam nenhum arcabouço de quantificação de efeito causal médio explícito, como o Püttker et al. 2020 fazem por exemplo (modelos de equação estrutural tem uma estabelecida conexão com teoria contrafactual). No caso desses estudos da Fahrig, eu percebo algo mais parecido com a visão de padrão e lei ou de regularidades, onde causalidade pode ser atribuida quando há repetição: em uma mesma paisagem existem mais espécies nos fragmentos pequenos do que nos fragmentos grandes (o tipico teste SLOSS, por exemplo e um artigo de 2023 da Eco Let). Então, não há claramente uma convergência de epistemológias. Porém, a partir do artigo programático de estudo do debate SLOSS (Fahrig et al. 2022 Bio Rev) uma nova epistemologia, que pode ter uma interpretação contrafactual, se forma no programa de pesquisa da Fahrig. Então entendo que essa visão mais baseada em regularidades, que difere da baseada em contrafactuais, pode ser colocada em fases mais preliminares de elaboração de hipóteses e investigação de possíveis causas enquanto essa maior convergência contrafactual, que estamos promovendo, ficaria em uma fase mais adiantada onde a ideia é atribuir efeitos. 
REFS:
de Almeida, M. W. B. (2021). Anarquismo ontológico e verdade no Antropoceno. Ilha Revista de Antropologia, 23(1), 10-29.
Fahrig, L. (2017). Ecological responses to habitat fragmentation per se. Annual review of ecology, evolution, and systematics, 48(1), 1-23.
[d]Fahrig, L., Watling, J. I., Arnillas, C. A., Arroyo‐Rodríguez, V., Jörger‐Hickfang, T., Müller, J., ... & May, F. (2022). Resolving the SLOSS dilemma for biodiversity conservation: a research agenda. Biological Reviews, 97(1), 99-114.
Fahrig, L. (2020). Why do several small patches hold more species than few large patches?. Global ecology and biogeography, 29(4), 615-628.
Püttker, T., Crouzeilles, R., Almeida-Gomes, M., Schmoeller, M., Maurenza, D., Alves-Pinto, H., ... & Prevedello, J. A. (2020). Indirect effects of habitat loss via habitat fragmentation: A cross-taxa analysis of forest-dependent species. Biological Conservation, 241, 108368.
[e]Riva, F., & Fahrig, L. (2023). Landscape‐scale habitat fragmentation is positively related to biodiversity, despite patch‐scale ecosystem decay. Ecology Letters, 26(2), 268-277.
[f]The most plausible model for the causal effect of area per se describes the log odds ratio as a function of the log ratio of U rate using a fixed spline effect and a site-specific spline effect (Figure X area per se table). This generalized additive hierarchical model (GAHM) employs a shared penalized parameter between the fixed and site-specific splines (Pedersen et al., 2019).
This model, which explains 47% of the deviance, outperforms the second-most plausible model by a substantial margin of 91.26 AICc units. There is strong evidence against spatial autocorrelation in the residuals (p-value from the Moran’s I statistics = 0.84).
[g]The most plausible model for the causal effect of area per se describes the log odds ratio as a function of the log ratio of U rate using a fixed spline effect and a site-specific spline effect (Figure X area per se table). This generalized additive hierarchical model (GAHM) employs a shared penalized parameter between the fixed and site-specific splines (Pedersen et al., 2019).
This model, which explains 47% of the deviance, outperforms the second-most plausible model by a substantial margin of 91.26 AICc units. There is strong evidence against spatial autocorrelation in the residuals (p-value from the Moran’s I statistics = 0.84).
[h]vai sair agora
[i]contexto da paisagem e contexto biogeográfico precisam ser definidos
[j]Aqui vc se refere a uma mudança em grau, recente  ou frquente? Ou tudo isso? Quero dizer, o grau de perturbação indica que houve muita alteração ou que houve muita alteração recente, ou com frequência?
[k]entendo que a ideia é que a classe primária houve um evento de pertubação muito antigo ou muito brando, a classe secondary seria um evento de perturbação mais recente (~50 anos) e pouco brando/pouco severo.
[l]isso só será auto-evidente se a lógica de análise de causalidade e uso de DAGs para isso for conhecida do leitor.
[m]não é muito óbvio pq ano do inventário teria a ver com contexto biogegráfico.
[n]nesta altura do texto o leitor pode pensar pq então o parágrafo anterior se ocupou de propor o uso das variáveis de contexto da paisagem e biogeográfico, já que agora vc afirma que pode não ser necessário.
[o]de que sobre o que, de maneira geral?
[p]para entender isso, antes é preciso explicar que vai usar GAMMs, e quais seus componentes, como slines e efeitos aleatórios associados a estes splines.
[q]esta parte só vai ficar clara para o lietor se houver uma explicação anterior destes componentes do modelo
[r]Aqui também é uma proposição que só vai ficar clara se houver uma explicação anterior da estrutura geral do modelo e da lógica de seleção de modelos
[s]acho que agregação não é necessária para criar autocorrelação. Basta que haja correlação maior da resposta entre pontos mais próximos no tempo e no espaço.
[t]Acho que precisa ficar mais claro o propósito estas perguntas. Como elas ajudam a responder a pergunta principal da seção, que é o desempenho relativo de diferentes cenários (contrafactuais) na previsão da SAD observada?
[u]definir isto, e mostrar qual resultado demonstra esta maior ou menos flexibilidade.
[v]idem aqui. Não está claro o que seria um modelo com maior flexibilidade
[w]por que?
[x]ué, pelo inćio da sentença entendi que aqui vc descreve o caso em que não é necessário um intercepto por classe de preservação
[y]não entendi
