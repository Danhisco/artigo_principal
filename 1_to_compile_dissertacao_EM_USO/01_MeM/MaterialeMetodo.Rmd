---
title: "Materiais e Método"
output:
  bookdown::pdf_document2:
    latex_engine: lualatex
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
bibliography: /home/danilo/Documentos/mestrado_Ecologia/artigo_principal/1_to_compile_dissertacao_EM_USO/resources/citations.bib
csl: /home/danilo/Documentos/mestrado_Ecologia/artigo_principal/1_to_compile_dissertacao_EM_USO/resources/plos.csl
---
```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = FALSE, include = TRUE, warning = FALSE,cache = TRUE,message=FALSE,eval=TRUE,dev = 'jpeg')
options(knitr.table.format = "simple")
# pacotes adicionais´
source("source/mapa_p_MNEE.R")
library(doMC)
library(readr)
library(scales)
# library(kableExtra)
library(ggnewscale)
library(gridExtra)
library(ggplot2)
library(tidyr)
library(readr)
library(stringr)
library(plyr)
library(dplyr)
# dados disponíveis
df_dados <- read_csv(file = "dados/df_dados_disponiveis.csv")
df_sim <- read_csv("dados/df_simulacao.csv")
df_plot <- read_csv("dados/csv/df_plotSoE.csv") |> 
  mutate(k_factor=factor(round(k_factor,2)))
df_p_extensoes <- read_csv("dados/csv/df_p_extensoes.csv")
```

```{r trackdown rotine, include=FALSE,eval=FALSE}
# pacotes
library(trackdown)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
upload_file(file="secoes_texto/MeM/MaterialeMetodo.Rmd",
            gpath="mestrado/artigo_principal/secoes_texto/",
            hide_code=TRUE)
update_file(file ="secoes_texto/MeM/MaterialeMetodo.Rmd",
            gpath = "mestrado/artigo_principal/secoes_texto/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file = "secoes_texto/MeM/MaterialeMetodo.Rmd",
              gpath = "mestrado/artigo_principal/secoes_texto/")
```


# Estimativa de efeitos causais médios a partir da simulação de contrafactuais: o caso do debate dentro da ecologia de paisagens e da teoria neutra da biodiversidade

## Processo gerador comum dos dados

A divergência entre os programas de pesquisa pode ser compreendido em termos de independência e interdepência dos efeitos da transformação da cobertura espacial na biodiversidade remanescente (REF). Ao pressupor independência, o processo geral de transformação de cobertura florestal é composto de dois processo independentes: um processo que determina a quantidade remanescente de cobertura florestal e outro que determina a configuração espacial da cobertura remanescente (Fahrig et al.). Ao pressupor interdependência o processo que reduz a quantidade de cobertura florestal é o mesmo que altera a configuração espacial do habitat (REF). Em ambas práticas ontológicas os efeitos da paisagem influenciam de forma unidirecional a biodiversidade local. 
A estimativa de efeitos causais médios a partir da simulação de contrafactuais pode se adequar às práticas ontológicas, caso seja possível determinar contrastes adequados entre contrafactuais (REF). 

Ao pressupor independência é possível simular 3 contrafactuais: i) a paisagem contemporânea ao inventário florestal; ii) a paisagem com a cobertura remanescente toda aglomerada ao redor da parcela amostrada, buscando maximizar a conectivadade da cobertura remanescente; e iii) a situação de ausência de perda de cobertura florestal, uma idealização de situação prístina em que tanto a cobertura e a conectividade remanescente são máximas. Ao pressupor interdependência é possível simular 2 contrafactuais: i) a paisagem contemporânea e ii) a paisagem prístina. 


MUDAR MUDAR MUDAR MUDAR

```{r}
tabela_praticas_ontologicas <- data.frame(
  `Prática Ontológica`=c("Interdependente","Independente"),
  `Paisagens Contrafactuais` = c("Contemporânea e Prístina","Contemporâneo, Aglomerada e Prístina"),
  `Contrastes entre Contrafactuais`= c("Fragmentação Total: contemporâneo e prístino",
                                       "Fragmentação per se: contemporâneo e aglomerado\nÁrea per se:aglomerado e prístino")
)
names(tabela_praticas_ontologicas) <- c("Prática Ontológica","Paisagens Contrafactuais","Contraste entre Contrafactuais")
```



```{r}


tabela_contrafactuais <- data.frame(
  paisagens_contrafactuais = c("Contemporânea",
                               "Prístina",
                               "Aglomerada",
                               "Isolamento máximo\nparcela",
                               "Isolamento máximo\nfragmento"),
  interpretacao_MNEE = c(
    # Contemporâneo
    "paisagem com a quantidade de progenitores remanescente e com a conectividade contemporânea entre os indivíduos da parcela e a área ao redor",
    # "Prístina"
    "paisagem com o espaço todo preenchido por progenitores",
    # Aglomerada
    "paisagem com a quantidade de progenitores contemporâneeo e com a maior conectividade possível entre os indivíduos remanescentes na paisagem",
    # Isollamento parcela
    "paisagem com a quantidade contemporânea de progenitores e menor conectividade entre os indivíduos da parcela e da paisagem ao redor",
    # "isoalmento fragmento amostrado"
    "paisagem com a quantidade contemporânea de progenitores a menor conectividade entre o fragmento amostrado e os progenitores de fora do fragmento amostrado"
  ),
  Contraste_de_contrafactuais = c(
    # C1 x C2
    
  ),
  
  
  Interpretacao_Processista_adequadaaMNEE = c(
    # Contemporâneo
    "O processo de perda de cobertura florestal determinou concomitanemente o número de progenitores remanescentes na paisagem e a complexidade da forma espacial da cobertura remanescente, que por sua fez determina a conectividade remanescente entre a parcela amostrada e paisagem ao redor",
    # Prístina
    "O processo de perda de cobertura florestal não ocorreu.",
    # Aglomerada
    "Nesse caso particular, o processo de perda de cobertura resultou em uma configuração espacial remanescente que maxima a conectividade entre os indivíduos remanescentes da parcela e da paisagem ao redor"
    
    
    
  ),
  Interpretacao_Padonista_adequadaaMNEE = c(
    # Contemporâneo
    "O processo de perda de cobertura floreestal determinou o número de progenitores remanesceentes e o processo de fragmentação per se determinou a complexidade da forma espacial da cobertura remanescente a conectividade remanescente",
    # Prístina
    "O processo de perda de cobertura florestal e o processo de fragmentação per se não ocorreram.",
    # Aglomerada
    "O processo de perda de cobertura florestal determinou a quantidade de progenitores remanescente e o processo de fragmentação per determinou o menor isolamento possível"
  )
)
```

* equilíbrio na paisagem





## Revisão da inferência causal baseado em modelos de regressão e DAG

- Dados observacionais podem ser interpretados como experimentos fracassados, onde é possível estruturar um diagrama das causas suficientes para descrever o processo gerados do padrão empírico observado (REF). 
- Experimentos possuem intepretação contrafactual. O efeito causal médio estimado pela diferença entre controle e tratamento é interpretado como o efeito que um indivíduo no controle teria tido caso tivesse sido tratado (REF). A interpretação de que um estudo com dados observacionais é um experimento fracassado possibiliita o estudo de alguns sistemas onde existe um consenso sobre um conjunto adequado e suficiente de causas para descrever um processo gerador dos dados (REF). Modelos de regressão são excelentes ferramentes para modelar de forma fenomenologica esses processos geradores dos dados relacionando métricas de processos gerados com os padrões epmíricos mensurados (REF). 
- Todos os modelos mecanisticos apresentam uma camada inferior de processos fenomelogicos (REF). No caso do modelo neutro espacialmente explícito os detalhes finos da dinâmica de morte, dispersão, e nascimento são muito simplificados por pressupostos de soma zero, espaços indivíduais iguais, sorteios aleatórios (REF). Além do pressuposto central de equivalência funcional entre espécies, onde todos as espécies apresentam as mesmas taxas demográficas e na simulação a mesma função de dispersão (REF). Porém este processo simplificado é suficiente para simular a distribuição de abundância de espécies empírica (Etienne anad Rosindell 2011, Campos et al. 2012, 2013, REF CAMPOS 2015). De tal forma que a comparação de paisagens distintas pode informar o efeito do contrastes entre as caraterísticas das paisagens no mecanismo causal mimetizado (REF). 



- Dos 3 DAGs é possível com GLMM recriar 2 deles: o DAG 1, que descreve a diversidade local como uma função da fragmentação total; e o DAG 3, que  descreve a diversidade local como uma função do efeito indepentende da fragmentação per se e da perda de cobertura florestal. 



# Materiais

Selecionamos na base de dados TreeCo inventários florestais que amostraram indivíduos arbóreos com DBH>=4.8 cm em parcela única de pelo menos 1ha de floresta, com alta confiabilidade taxonômica no nível de morfoespécie e da coordenada central da parcela. A base de dados TreeCo compilou amplamente trabalhos fitossociológicos realizados na Floresta Atlântica (@de2015much). Utilizamos mapas de cobertura vegetal da coleção 6 do mapbiomas com resolução de 30x30 m2, que agregam mapas de 1985 até 2020 (@mapbiomas).  Os mapas de cobertura vegetal distinguem as áreas de cobertura florestal nativa das áreas de outros tipos de cobertura (@mapbiomas). Classificamos as áreas de cobertura florestal como áreas de habitat e as restantes como áreas de não habitat. Os mapas de cobertura florestal foram recortados em quadrados centrados na coordenada central da parcela. A resolução dos mapas foi ajustada para que a densidade de pixels seja igual a densidade de indivíduos na parcela do respectivo inventário florestal. Aproximamos a área da parcela por um quadrado. Em uma paisagem não foi possível desenhar uma área quadrada devido à configuração espacial do habitat e foi descartada (Apêndice: Efeito de Escalar).

# Método

Para comparar os dois programas de pesquisa da ecologia de paisagens (@fahrig2019habitatB e @fletcher2018habitat) em um arcabouço teórico comum e independente desses dois programas de pesquisa utilizamos o programa de pesquisa da Teoria Neutra da Biodiversidade (@rosindell2012case, @bausman2019aims, @leroi2020neutral). O programa de pesquisa da Teoria Neutra se propõe a investigar os pressupostos auxiliares ao pressuposto de equivalência funcional na construção de modelos de dinâmica populacional das espécies no espaço (@rosindell2012case, @leroi2020neutral). Ao pressupor equivalência funcional se torna possível modelar a dinâmica ecológica, que resulta no padrão de diversidade local observado, utilizando um único parâmetro livre enquanto é explorado a relação de escala entre parcela e paisagem ao redor, variando a capacidade de dispersão dos indivíduos (@munoz2016neutral). O parâmetro livre controla a taxa de colonização de uma nova espécie no sistema por evento de nascimento (taxa U), o input de novas espécies pode ser interpretado como especiação ou reposição do banco de propágulos (@condit2012thirty; @azaele2016statistical; @munoz2016neutral). Utilizamos um modelo neutro espacialmente explícito onde todos os indivíduos na paisagem são modelados e as posições e distâncias no espaço em 2D são explicitamente considerados (@campos2012neutral, @campos2013effect). Nos modelos neutros a única interação entre indivíduos é de competição neutra por espaço, resultando em flutuações estocásticas nos tamanhos populacionais das espécies, chamado de deriva ecológica (@azaele2016statistical). Aqui usamos um modelo que pressupõe equilíbrio dinâmico, situação onde a perda de espécies por deriva é compensada pelo constante input de espećies (descrito pela taxa U). Comparamos 3 tipos de paisagens hipotéticas em que o modelo simula a situação de equilíbrio dinâmico: a paisagem contemporânea, com a configuração espacial do habitat remanescente observada no ano que melhor aproxima o ano de amostragem do inventário florestal; a paisagem sem isolamento estrutural, com o habitat remanescente contemporâneo aglomerado ao redor da parcela (em forma de quadrado); e a paisagem idealizada, sem perda de habitat - situação proposta como referência de efeito nulo da perda de habitat na paisagem ao redor na manutenção da diversidade local (@fahrig2022resolving).


```{r ,cache=FALSE}
cap <- "Exemplo de paisagens hipotéticas usadas pelo modelo neutro espacialmene explício na escala de 4x4km2. Paisagem contemporânea: paisagem com a configuração espacial espacial do habitat remanescente do mesmo ano que a amostragem da SAD empírica. Paisagem sem isolamento estrutural: paisagem com o habitat remanescente na paisagem contemporânea todo aglomerado ao redor do sítio de amostragem. Paisagem idealizada:paisagem sem perda de habitat."
# df_glossario
  # gt::gt(caption="Paisagens Hipotéticas") %>% 
  # gt::as_latex()
  # knitr::kable(x=.,caption = "Paisagens Hipotéticas")
# kableExtra::kbl(df_glossario,format = "latex",
#   caption = "Paisagens Hipotéticas",
#   booktabs = TRUE, linesep = "", align = "c")  %>%
#   kableExtra::kable_styling(latex_options = c("striped", "HOLD_position")) %>% 
#   kableExtra::column_spec(2, width = "10cm")
```
```{r exemplo-paisagens-hipotetica,fig.cap=cap,fig.height=3,fig.width=8,fig.pos="H"}
f_image <- \(mat,title){
  image(mat,
        main=title,
        zlim=c(0,2),
        axes=FALSE,
        col=terrain.colors(12,rev = TRUE))
}
#
par(mfrow=c(1,3))
#
path_name <- "dados/simulacao/MGipia1.txt"
m <- read_table(file = path_name) |> as.matrix()
f_image(mat=m,title="Contemporânea")
# sem frag
m_sem_frag <- f_nonFragLand(m)
f_image(mat=m_sem_frag,title="Aglomerada")
# idealizado
m_ideal <- m
m_ideal[m_ideal==0] <- 1
f_image(mat=m_ideal,title="Prístina")
```

## Paisagem local: relação entre extensão espacial e grau de limitação de dispersão
  
    
O conceito de paisagem local é aceito em ambos programas de pesquisa como a área ao redor que pode prover a maior parte da chuva de propágulos que chega na parcela amostrada (@watling2020support,@puttker2020indirect). Esse conceito coincide com o conceito de metacomunidade usado no contexto da Teoria Neutra (@munoz2016neutral; @chase2020biodiversity). Em ambos os programas de pesquisa de ecologia de paisagens a extensão espacial da paisagem ao redor pode ser obtida usando a chamada análise de escala de efeito (@jackson2015ecologists; @puttker2020indirect). A análise de escala de efeito (@jackson2015ecologists) propõe que a extensão espacial adequada é aquela que maximiza o peso de evidência da associação estatística entre o padrão de biodiversidade local estudado e a variável de interesse, por exemplo, a proporção de cobertura vegetal na paisagem. A extensão espacial da paisagem determina a quantidade máxima de habitat disponível ao redor dos sítios de estudo (figura 3). A análise de escala de efeito tem sido adotada em diversos trabalhos (@crouzeilles2016landscape, @stuber2020recent). Optamos por não utilizar a análise de escala de efeito, pois ela pressupõe que existe equilíbrio da resposta ecológica à heterogeneidade contemporânea da paisagem. Alternativamente, vamos investigar a extensão mínima da paisagem ao redor para que a simulação da diversidade local pelo modelo neutro espacialmene explícito não seja restringida pela extensão espacial da paisagem, mas sim pela limitação de dispersão e configuração espacial do habitat remanescente (Apêndice: Efeito de Escalar). 

    
## Modelo Neutro Espacialmente Explícito

O modelo neutro espacialmente explícito utiliza uma abordagem coalescente (@rosindell2008coalescence; @thompson2020pycoalescence). A simulação termina quando todos os indivíduos da área amostral coalescem para o conjunto dos primeiros indivíduos ancestrais que originaram às populações na  paisagem local (@rosindell2008coalescence), criando uma árvore genealógica da comunidade local. Cada ramo da árvore genealógica da comunidade local é constituida por indivíduos que compartilham um único ancestral comum, o indivíduo que primeiro surgiu na paisagem, descrito pela taxa U, detalhes do algoritmo em @rosindell2008coalescence. A abordagem pressupõe que apenas um indivíduo pode colonizar uma unidade de habitat por vez e toda morte é reposta pelo nascimento de um indivíduo adulto (pressuposto de soma zero). Na simulação coalescente a cada momento simulado, um indivíduo é sorteado para ser substituído. Há duas possibilidades de substituição: por um singleton de uma nova espécie na paisagem (probabilidade U) ou pela prole de uma árvore residente na paisagem (1-U). Nos 1-U casos em que a substituição é por um propágulo vindo da paisagem local, a simulação centra a função de dispersão no habitat vago e sortea posições na paisagem até que uma unidade de habitat seja sorteada, determinando a origem do propágulo que coloniza o habitat disponível (@rosindell2008coalescence; @thompson2020pycoalescence). A função de dispersão é simulada com uma distribuição exponencial espelhada (@bullock2017synthesis), i.i.d. em duas dimensões (@thompson2020pycoalescence). Controlamos a capacidade de dispersão dos indivíduos variando a proporção de propágulos que permanecem até a vizinhança imediata da planta progenitora (distância até o vizinho imediato). A taxa U é estimada usando a abordagem analítica proposta por @rosindell2008coalescence no apêndice A, no qual, a partir da árvore genealógica da comunidade local pressuposto ausência de colonização por novas espécies (probabilidade U ~ 0), é calculado a probabilidade U média necessária para obter a riqueza observada (Apêndice: Informação de Suporte). 
  
    
### Avaliação do Efeito de Escalar
  
    
Uma forma de avaliar se a árvore genealógica da comunidade está sendo restringida pela extensão espacial da paisagem é investigar a taxa U. Para isso, consideramos paisagens sem perda de habitat, para desconsiderar a limitação da árvore genealógica pelo isolamento estrutural da parcela na paisagem (@thompson2019characterising). Exploramos uma amostra dos inventários florestais selecionados, incluindo os valores extremos de número de indivíduos e de riqueza de espécies. variando o lado da paisagem local em 6 escalas: 0.5, 1, 2, 4, 8  e 16 km. Buscamos a escala que estabiliza a estimativa da taxa U. Aquele subescala que acumula pelo menos 95% do efeito de aumentar a escala foi considerada adequada para a simulação daquele grau de limitação de dispersão (Apêndice 1: Efeito de Escalar). 
  
    
#### Simulação do Modelo Neutro Espacialmente Explícito
  
    
Para cada sítio de amostragem e tipo de paisagem hipotética foram simuladas 20 graus de limitação de dispersão. A proporção de propágulos que permanece até a vizinhança imediata da árvore progenitora variou entre 0.99 até 0.05. Para cada bateria de simulação (sítio de amostragem, paisagem hipotética e grau de limitação de dispersão) foram estimadas 10 réplicas da taxa U necessária para manter a riqueza observada. A taxa U média é usada para parametrizar as 100 simulações réplicas usadas para predizer a distribuição de abundância de espécies, SAD. Nas paisagens hipotéticas contemporânea e aglomerada foram feitas simulações com a taxa U livre para ajustar a riqueza observada e com a taxa U livre na respectiva paisagem prístina.
  

## Métricas de efeito da paisagem ao redor

As métricas de efeito da paisagem foram obtidas pela comparação da estimativa da taxa U entre paisagens hipotéticas para um mesmo sítio de amostragem e grau de limitação de dispersão. Essas métricas podem ser interpretadas no nível da dinãmica ecológica simulada pelo modelo neutro. No modelo neutro espacialmente explícito quando consideramos a diversidade local na parcela amostrada, os eventos descritos pela probabilidade U sempre aumentam a riqueza local. Nos 1-U nascimentos, aqueles que resultam em aumento da diversidade local certamente ocorrem por propágulos que imigram de fora da parcela. Enquanto os nascimentos que aumentam a abundância relativa de alguma espécie local podem ser de propágulos locais também. Assim, a reposição de espécies perdidas localmente por deriva ecológica podem ser de duas origens, dos eventos descritos por U e por parte dos eventos descritos por 1-U. Como a única diferença entre estimativas é a paisagem hipotética, a comparação entre paisagens hipotéticas pode informar efeitos da paisagem ao redor na conectividade dos indivíduos na cobertura florestal remanescente relacionada com a manutenção da diversidade local. 

Calculamos 3 tipos métricas de efeito da paisagem ao redor baseado na taxa U estimada nas paisagens hipotéticas. A métrica de efeito de fragmentação per se foi obtida pela comparação entre a taxa U estimada em paisagens contemporânea e aglomerada. O simulado nessas duas paisagens pressupõe a mesma quantidade de cobertura, mas difere na particular configuração espacial da cobertura remanescente.
A métrica de efeito de fragmentação total foi obtida pela comparação entre a taxa U estimada em paisagens contemporânea e prístina. O simulada nessas duas paisagem difere na quantidade de cobertura florestal remanescente e na particular configuração espacial dessa cobertura remanescente no momento da amostragem. 
A métrica de efeito de perda de cobertura florestal per se foi obtida pela comparação entre a taxa U estimada em paisagens aglomerada e prístina. O simulado nessas duas paisagens difere na quantidade de cobertura florestal remanescente, porém, em ambas todo o habitat remanesceente está sempre estruturalmente em contato. 



    
## Análise de Dados

No contexto de criação de modelos ecológicos para aproximar a diversidade local de árvores a partir da cobertura florestal na área ao redor, o debate entre os programas de pesquisa em ecologia de paisagens pode resultar em duas perguntas: o efeito de fragmentação per se é relevante ou é suficiente considerar apenas a quantidade de habitat remanescente? dados estaticos de diversidade local são melhor aproximados pela premissa de efeito de longo prazo ou de curto prazo da paisagem ao redor? 

Para responder a primeira pergunta é possível comparar a predição do simulada na paisagem hipotética contemporânea e aglomerada, com o U livre e prístino, em função da métrica de fragmentação per se. Dessa forma, avaliamos o efeito da fragmentação per se na conectividade.

Para responder a segunda pergunta é possível comparar a paisagem prístina com a paisagem contemporânea e aglomerada em função da métrica de efeito de fragmentação total e da métrica de efeito de perda de cobertura per se, respectivamente. Dessa forma comparamos paisagens hipotéticas que utilizam da informação contemporânea com aquela que pressupõe ausência de perda de cobertura.

Avaliamos a congruência entre a distribuição de abundância de espécies (SAD) observada na parcela e a SAD simulada pelo modelo neutro pressuposto as 3 paisagens hipotéticas (contemporânea, aglomerada e prístina). A congruência entre SAD empírica e SAD simulada foi obtida pelo teste de Kolmogorov-Smirnov bootstrap (@2samples), cuja hipotese nula asserta que as duas SADs comparadas são amostras de uma mesma distribuição de abundância de espécies. As SADs simuladas foram classificadas como congruentes se o p-valor do teste for maior ou igual a 5%. Contabilizamos o número de SADs congruêntes por bateria de simulação.

Exploramos modelos hierarquicos de regressão que agregam os dados pelo sítio de amostragem para explorar a congruência relativa da SAD simulada usando uma distribuição binomial. Buscamos avaliar como a congruência relativa varia com o aumento da métrica de efeito   

\newpage

# Referências