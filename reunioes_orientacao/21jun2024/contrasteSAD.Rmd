---
title: "Contraste entre contrafactuais: congruência com a SAD observada"
author: "Mori, Danilo"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---
```{r setup}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE,message = FALSE,warning = FALSE)
# pacotes
library(twosamples)
library(sads)
library(doMC)
library(ggpmisc)
library(gridExtra)
library(ggplot2)
library(readr)
library(purrr)
library(stringr)
library(tidyr)
library(insight)
library(bbmle)
library(DHARMa)
library(lme4)
library(mgcv)
library(plyr)
library(dplyr)
# funções
source("source/dinamica_coalescente.R")
source("source/2samples_testes.R")
f_z <- function(x) (x-mean(x))/sd(x)
# obj comum
v_pares <- c("contemp-ideal","non_frag-ideal","contemp-non_frag")
names(v_pares) <- c("frag.total","area","frag.perse")
# dados
df_dados_disponiveis <- read_csv(file = "dados/df_dados_disponiveis.csv") %>% 
  select(SiteCode,year_bestProxy,matches("(lat|long)")) %>% 
  mutate(lat = ifelse(is.na(lat_correct),lat,lat_correct),
         long = ifelse(is.na(long_correct),long,long_correct),
         data_year = as.numeric(year_bestProxy),
         data_year = ifelse(is.na(data_year),2012.5,data_year)) %>% 
  select(-contains("correct"),-year_bestProxy)
# Resultados
## congruência 
df_adSAD <- readRDS("5_resultados/df_adSAD.rds")
## efeito U
df_contrastes <- read_csv(file="dados/csv/taxaU/df_contrastes.csv")
# dados para modelos
df_md0 <- df_adSAD %>%
  filter(taxaU=="contemp",land_type=="contemp") %>%
  select(SiteCode,k,nCongKS) %>%
  inner_join(df_contrastes %>% select(SiteCode:k,frag.total_logratio)) # versão do
df_contrastes <- df_contrastes %>%
  select(SiteCode:p, contains("_logratio")) %>% 
  mutate(across(-SiteCode,f_z,.names = "{.col}_z")) %>% 
  select(SiteCode,k,p,k_z:frag.total_logratio_z) %>% 
  rename_with(~str_remove(.,"_logratio_z")) %>% 
  pivot_longer(cols = c("area","frag.perse","frag.total"),
               values_to = "Uefeito",
               names_to = "contraste") %>% 
  mutate(contraste = case_when(contraste=="area" ~ "non_frag-ideal",
                               contraste=="frag.total" ~ "contemp-ideal",
                               contraste=="frag.perse" ~ "contemp-non_frag"))
df_logOR <- df_adSAD %>% 
  mutate(nKS = case_when(nCongKS == 0 ~ 0.09, #min pred for a GLMM for a sampled comb
                         nCongKS == 100 ~ 99.73, #max pred for a GLMM for a sampled comb
                         TRUE ~ nCongKS),
         logitoKS = log (nKS / (100-nKS))) %>% 
  select(taxaU:land_type,logitoKS) %>% 
  f_contrasteSAD(.,pares=v_pares) %>% 
  inner_join(y=df_contrastes,by=c("contraste","SiteCode","k")) %>% 
  inner_join(y=df_dados_disponiveis,by="SiteCode") %>% 
  relocate(p,.after=k)
```

# Contraste entre contrafactuais

Para cada contraste existem até 4 pontos de referência da taxa U: i) o correspondente, quando a taxa U e a paisagem contrafactuais coincidem; ii) numerador, taxa U da paisagem contrafactual no numerador do contraste; iii) denominador, taxa U do contrafactual no denominador; e iv) prístino, a taxa U da respectiva paisagem contrafactual sem perda de habitat.


```{r fig 1 cap}
cap = ""
```
```{r figura 1 - GE logOR em funcao da taxa}
theme_set(theme_bw())
df_logOR %>% 
  select(-matches("^k|^p(!pristine)")) %>% 
  pivot_longer(cols = c("itself","pristine","numerator","denominator"),
               values_to="logOR",
               names_to="taxaU") %>% 
  mutate(taxaU = factor(taxaU,
                        levels=c("itself","pristine","numerator","denominator"))) %>% 
  ggplot(aes(x=Uefeito,y=logOR,color=taxaU,group=SiteCode)) +
  geom_hline(yintercept = 0,color="gray") +
  geom_vline(xintercept = 0,color="gray") +
  geom_line(alpha=0.2) +
  geom_point(alpha=0.2) +
  labs(x="respectivo efeito em U (z transformado)",
       y="log( Odds SAD / Odds SAD )",
       title="Congruência relativa da SAD simulada em relação ao respectivo efeito na taxa U") +
  scale_color_manual("Parâmetro usado:",values=c("darkred","darkgreen","darkblue","darkorange")) +
  facet_grid(taxaU~contraste)
```

## Conclusão 4 pontos de referência

Concluímos que o principal ponto de referência é o correspondente, pois é o mais coerente com a prática ontológica, enquanto a referência do numerador e denominador tem um caráter mais de análise de sensibilidade. O ponto de referência prístino pode ter valor para TNB uma vez que é proposto como referência de ausência de débito de extinção. Nesse sentido, uma oportunidade é relacionar a referência de correspondência, alinhada com as práticas ontológicas das ecológia de paisagens e a TNB, com a prístina, alinhada com a ontologia independente e da TNB. Assim, iremos prosseguir na seção dos resultados com a análise dos dados da referência correspondente.

# Análise

Primeiro utilizo um glmer padrão para obter o range de valores de logito adequado para esse conjunto de dados. Antes de discutirmos os 4 pontos de referência a ideia era analisar os 4, o código beta dessa abordagem está oculto nesse documento. <!-- (no próximo segundo chunk)  -->
Então segui ajustando para cada contraste de contrafactuais 3 GAMM:

```{r tabelas dos modelos para }
library(knitr)
df <- data.frame(
  modelo = c("com efeito por paisagem", "com efeito de paisagem", "sem efeito de paisagem","mgcv::s"),
  `efeito em U` = c("1", "1", "0","s(bs='cr')"),
  `ano dados` = c("1", "1", "1","s(bs='cr')"),
  `coord. geo.` = c("1", "1", "1","s(bs='tp')"),
  `intecep. por sítio` = c("1", "1", "1","s(bs='re')"),
  `efeito em U por sítio` = c("1", "0", "0","s(bs='fs',xt=list(bs='cr'))")
)
knitr::kable(df, 
             caption = "Características dos GAMM na 1a fase de comparações\n method='REML'")
```

```{r 1a parte - ajuste de um GLMM para avaliação do range de logito,eval=FALSE,echo=TRUE}
# 1a parte: ajuste de um GLMM para avaliaçã do range de logito necessário para descrição 
md <- glmer(cbind(nCongKS,100-nCongKS) ~ 
              frag.total_logratio + (1|SiteCode),
            data = df_md0, family = "binomial")
df_md0$pred <- predict(md,df_md0,type="response")*100
v_pred <- df_md0 %>% filter(pred %in% range(df_md0$pred)) %>% 
  pull(pred) %>% round(.,digits = 2)
boxplot(df_md0$nCongKS)
```
```{r 2a parte - ajuste de GAMM para descrever cada contraste NÃO USADO,eval=FALSE}
# 2a parte: ajuste de um GAMM para cada contraste de interesse
f_ajuste <- \(dfi,responses=c("itself","pristine","numerator","denominator")){
  df_md <- dfi %>% pivot_longer(cols=all_of(responses),names_to = "taxaU",values_to = "logOR")
  df_md %>% 
    split(.,df_md$taxaU) %>% 
    lapply(.,f_gamm)
}
f_gamm <- \(dfmd){
  if(all(is.na(dfmd$logOR))) return(NA)
  l_md <- list()
  l_md$gs <- gam(logOR ~ 
                   s(Uefeito,bs="cr") + 
                   s(Uefeito, SiteCode, bs="fs",xt=list(bs="cr")) + 
                   s(SiteCode,bs="re"),
                 data=dfmd,method = "REML")
  l_md$gi <- gam(logOR ~ 
                   s(Uefeito,bs="cr") + 
                   s(Uefeito, by=SiteCode, bs="cr") + 
                   s(SiteCode,bs="re"),
                 data=dfmd,method = "REML")
  return(l_md)
}
l_md_logOR <- df_logOR %>% 
  mutate(SiteCode=factor(SiteCode)) %>% 
  split(.,df_logOR$contraste) %>% 
  lapply(.,f_ajuste)
saveRDS(l_md_logOR,file="dados/Rdata/l_md_logOR.rds")
```
```{r 2a parte usada: apenas a referência correspondente, echo=FALSE}
df_md <- df_logOR %>% select(-(pristine:denominator),-matches("(^k|^p)")) %>% 
  rename(logOR = itself)
f_gam <- \(dfi){
  l_md <- list()
  l_md$`com efeito por paisagem` <- gam(logOR ~
        s(Uefeito,bs="cr") + 
        s(data_year,bs="cr") +
        s(lat,long,bs="tp") +
        s(SiteCode,bs="re") + s(Uefeito, SiteCode, bs="fs",xt=list(bs="cr")),
      data=dfi,method = "REML")
  l_md$`com efeito de paisagem` <- gam(logOR ~
        s(Uefeito,bs="cr") + 
        s(data_year,bs="cr") +
        s(lat,long,bs="tp") +
        s(SiteCode,bs="re"),
      data=dfi,method = "REML")
  l_md$`sem efeito de paisagem` <- gam(logOR ~
        s(data_year,bs="cr") +
        s(lat,long,bs="tp") +
        s(SiteCode,bs="re"),
      data=dfi,method = "REML")
  return(l_md)
}
l_md_logOR <- df_md %>% 
  mutate(SiteCode=factor(SiteCode)) %>% 
  split(.,df_md$contraste) %>% 
  lapply(.,f_gam)
saveRDS(l_md_logOR,file="dados/Rdata/l_md_logOR_itself.rds")
```

## 1a fase de comparações: qual estrutura aleatória usar? e é necessário considerar a paisagem?

Para todos os contrastes, o GAMM mais plausível era aquele 'com efeito por paisagem' (tabela anterior). Todos eles apresentam o p-valor no teste de Moran muito maior do que 0·05% e a estatística de Moran I não é maior do que 0.15 em módulo. A deviance explicada dos modelos mais plausíveis varia entre 0.41 e 0.69. A seguir o diagnóstico dos modelos mais plausíveis.

```{r}
l_md.logOR <- readRDS("dados/Rdata/l_md_logOR_itself.rds")
df_tabelaSelecao <- read_csv(file="dados/csv/df_tabelaSelecao_logOR_itself.csv")
f_SML.gamm <- \(df){md <- l_md.logOR[[df$pair[1]]][[df$modelo[[1]]]]}
l_md_1alike <- dlply(df_tabelaSelecao,"pair",f_SML.gamm)
######
knitr::kable(
  df_tabelaSelecao,
  caption="Tabela de seleção dos GAMMs da 1a fase de comparações"
  )
```

### Diagnóstico dos modelos mais plausíveis

```{r}

```





```{r}
df_md <- df_logOR %>% select(-(pristine:denominator),-matches("(^k|^p)")) %>% 
  rename(logOR = itself)
f_gam <- \(dfi){
  l_md <- list()
  l_md$`com efeito por paisagem` <- gam(logOR ~
        s(Uefeito,bs="cr") + 
        s(data_year,bs="cr") +
        s(lat,long,bs="tp") +
        s(SiteCode,bs="re") + s(Uefeito, SiteCode, bs="fs",xt=list(bs="cr")),
      data=dfi,method = "REML")
  l_md$`sem ano` <- gam(logOR ~
        s(Uefeito,bs="cr") + 
        s(lat,long,bs="tp") +
        s(SiteCode,bs="re") + s(Uefeito, SiteCode, bs="fs",xt=list(bs="cr")),
      data=dfi,method = "REML")
  l_md$`sem coord` <- gam(logOR ~
        s(Uefeito,bs="cr") + 
        s(data_year,bs="cr") +
        s(SiteCode,bs="re") + s(Uefeito, SiteCode, bs="fs",xt=list(bs="cr")),
      data=dfi,method = "REML")
  l_md$`sem cov` <- gam(logOR ~
        s(Uefeito,bs="cr") + 
        s(SiteCode,bs="re") + s(Uefeito, SiteCode, bs="fs",xt=list(bs="cr")),
      data=dfi,method = "REML")
  return(l_md)
}
l_md_logOR_aud <- df_md %>% 
  mutate(SiteCode=factor(SiteCode)) %>% 
  split(.,df_md$contraste) %>% 
  lapply(.,f_gam)
saveRDS(l_md_logOR_aud,file="dados/Rdata/l_md_logOR_aud.rds")
```




```{r}
df_logOR %>% 
  filter(contraste=="contemp-ideal")
  ggplot(aes(x=Uefeito,y=response,color=p)) +
  # geom_line(aes(group=SiteCode),alpha=0.5) +
  geom_hline(yintercept = 0,color="darkred") +
  geom_vline(xintercept = 0,color="darkred") +
  geom_point(alpha=0.5) +
  geom_smooth() +
  scale_colour_gradient2(midpoint=0.5,
                         low="darkred",
                         mid = "darkblue",
                         high = "darkgreen") +
  facet_wrap(~k,ncol=5)
```


## Fragmentação total



```{r}


```


## Área per se

## Fragmentação per se

# Apêndice

## Congruência com a SAD observada nos contrafactuais de paisagens e taxa U

```{r}
# df_adSAD
```


