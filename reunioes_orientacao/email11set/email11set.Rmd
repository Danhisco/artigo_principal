---
title: "Apêndice 2: Figuras e Tabelas"
author: "Mori, Danilo"
date: "19/11/2022"
output: 
  html_document:
    toc: true
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = TRUE,message = FALSE,warning = FALSE,cache=TRUE)
library(png)
library(grid)
library(gridExtra)
library(gt)
library(ggplot2)
library(readr)
library(stringr)
library(tidyr)
library(mgcv)
library(plyr)
library(dplyr)
source("source/nameModel.R")
source("source/GAMMtools.R")
df_md <- read_csv("dados/csv/df_md.csv")
```

```{r trackdown chunk, include=FALSE,eval=FALSE}
# pacotes
library(trackdown)
# both overwrite: 
# overwrite the current google drive file with the current Rmd:
upload_file(file="reunioes_orientacao/email11set/email11set.Rmd",
            gpath="mestrado/reunioes_orientacao/",
            hide_code=TRUE)
update_file(file ="secoes_texto/Resultados/Resultados.Rmd",
            gpath = "mestrado/artigo_principal/secoes_texto/",
            hide_code = TRUE)
# overwrite the current Rmd with the current google drive 
download_file(file = "secoes_texto/Resultados/Resultados.Rmd",
              gpath = "mestrado/artigo_principal/secoes_texto/")
```

Olá Paulo, tdo bem? Espero que sim!
Para explicar a duvida vou primeiro fazer um SCORE.
nota: Análise 4 é a tag no .Rmd

# SCORE

Para descrever a probabilidade de boa congruência entre SAD predita e empírica utilizei GAMMs binomial. Há uma estrutura comum entre todos os modelos candidatos: um spline individual geral (estrutura fixa) para `k_z`, um spline para `k_z` para cada sítio de amostragem, e um intercepto por sítio de amostragem - para cada um desses 3 termos há uma cópia por tipo de paisagem hipotética: contemporânea, sem fragmentação, e idealizada. Entre os modelos candidatos há diferentes covariáveis de k que também são copiados para cada tipo de paisagem (sensu Pedersen et al 2019). Atribui um spline individual na estrutura fixa para cada covariável:  os 3 tipos de contrastes (area per se, frag. per se., e contemporaneidade per se) e 2 tipos de variáveis (taxa U e logito da congruência entre SADs preditas); e a proporção de cobertura vegetal (p). Também considerei modelos que combinavam os contrastes de área per se e frag. per se com um spline individual geral (estrutura fixa) para cada contraste. Totalizando 10 modelos.  A seguir as formulas usada para construir os modelos:
 

```{r lista dos 10 modelos usados para descrever a probabilidade}
f0 <- "cbind(nCong,100-nCong) ~ land_hyp + s(k_z,by=land_hyp,bs='cr',k=3) + s(k_z,by=land_hyp,SiteCode,bs='fs',k=3,xt=list(bs='cr')) + s(land_hyp,SiteCode,bs='re')"
l_f <- as.list(paste0("land_hyp + s(",names(select(df_md,contempU_z:p_z)),",by=land_hyp,bs='cr',k=3) + "))
l_f[length(l_f)+1] <- "land_hyp + s(areaU_z,by=land_hyp,bs='cr',k=3) + s(fragU_z,by=land_hyp,bs='cr',k=3) + "
l_f[length(l_f)+1] <- gsub("U_z","SAD_z",l_f[length(l_f)])
l_f <- sapply(l_f, \(s) str_replace(f0,"land_hyp\\s\\+\\s",s))
l_f[length(l_f)+1] <- f0
adply(l_f,1,\(s) sub("cbind\\(nCong,100-nCong\\) ","",s) %>% 
        gsub(",bs\\=\\'cr\\',k\\=3","",.) %>%
        gsub(",k\\=3","",.) %>%
        gsub(",xt\\=list\\(bs\\=\\'cr\\'\\)","",.)) %>%
  select(-X1) %>% 
  rename(modelos = V1)
```

```{r tabela de seleção ad4}
df_tab <- read_csv("./dados/csv/df_ts_prconganalise4.csv") %>% as.data.frame()
df_tab %>% 
  gt::gt()
```

O único modelo plausível foi aquele com splines na estrutura fixa os contrastes de área e frag. 

```{r validacao modelo mais plausivel prcong}
load(file="./dados/Rdata/md_prcong.Rdata")
summary(md_prcong)
k.check(md_prcong)
# gráficos diagnósticos
l_p <- list.files("./apendices/analise_dados/figuras",pattern = "diagGAMM",full.names = T) %>% 
  llply(.,readPNG) %>% 
  llply(.,\(p) ggplot() +
          annotation_custom(rasterGrob(p), xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
          theme_void())
grid.arrange(grobs=l_p,
             layout_matrix = rbind(c(1,1,1),
                                   c(1,1,1),
                                   c(2,2,2),
                                   c(2,2,2),
                                   c(2,2,2),
                                   c(3,3,4)))
```

O resultado da função 'mgcv::k.test' sugere que pode ser adequado aumentar o número de funções base para construir os splines indivíduais. Todos os splines são considerados uma descrição mais adequada dos dados do que um intercepto simples por preditora. Os resíduos quantílicos e teste de outliers indicam que há desvios dos pressupostos do modelo binomial proposto, com observações consideradas outliers. Considerando apenas a relação entre predito e observado, o modelo apresenta ajuste razoável, com estimativas razoáveis dos efeitos parciais médio para todos os splines individuais na estrutura aleatória, exceto para o spline de k em paisagens contemporâneas, onde o efeito parcial tende à uma reta com o erro na esimativa aumentando linearmente nos extremos do gradiente da preditora. Uma vez que o modelo faz predições razoáveis, a interpretação dos resultados usando um intervalo de predição a posteriori será feita com esse modelo mais plausível.

# Dúvida

O conjunto de dados que será usado para construir o intervalo de predição a posteriori precisa considerar as relações entre as preditoras contínuas? Entendo que sim, o que você acha? Optei por prosseguir com a ideia. Para isso comparei modelos que descrevem a média dos contrastes de área e frag. As formulas dos modelos mais plausíveis serão usadas para descrever os quantils de 5% e 95% dos contrastes. Com esses modelos pretendo construir o conjunto de dados para predição a posteriori. 

## Conjunto de dados para construir os intervalos de predição a posteriori

Em minha primeira tentativa tentei construir um conjunto de dados para predição interpolando os valores das 3 preditoras contínuas (k, areaU e fragU).
Entendo que é adequado criar um conjunto de dados para interpretação da predição que explore combinações representativas da relação entre preditoras (k, areaU e fragU).
Os contrastes de U (area e frag.) apresentam elevada assimetria, são pequenos sob severa limitação de dispersão e podem ser elevados sob limitação mais branda (Figura 1). Além disso, há motivações teóricas tanto no programa de pesquisa da teoria neutra, quanto dos dois programas de pesquisa em ecologia de paisagens para esperar uma relação entre essas 3 preditoras. A variável k pode ser interpretada como geradora das outras duas preditoras, pois o que permite a influência da paisagem ao redor na dinâmica local é o potencial dos indivíduos arbóreos colonizarem áreas fora da copa do progenitor. Os dois programas de pesquisa da ecológia de paisagens entendem que o efeito de área per se não pode ser gerado pelo efeito de fragmentação per se, ou seja, o contraste de área pode ser uma preditora do contraste de fragmentação per se - o contrário, não. O programa de pesquisa padronista, pressupõe que os efeitos de área e fragmentação per se, são ortogonais e, portanto, apenas k deve ser uma preditora adequada para descrever o contraste de fragmentação per se (Fahrig 2018/2019, ...). Já o programa de pesquisa processista pressupõe que existem efeitos indiretos da perda de área de habitat associadas aos efeitos de fragmentação per se (Putker et al. 2020), e portanto tanto k quanto o contraste de área podem ser preditoras adequadas para descrever o contraste de fragmentação per se. 

## Modelos Estatísticos

Para avaliar a expectativa comum de que k será uma preditora adequada para descrever o contraste de área, basta ajustar um GAMM com k com spline individual na estrutura aleatória (por sítio de amostragem) e estrutura fixa (padrão comum a todos os sítios). O sumário desse modelo oferece uma comparação de cada spline com um intercepto, modelo nulo (Wood 2016).  
Para avaliar as expectativas sobre o conjunto adequada de preditoras para descrever o contraste de fragmentação per se é possível comparar 3 modelos: 1) splines índivíduais para k, fixos e aleatórios; 2) splines individuais para k e spline fixo para área; e 3) spline fixo para área com intercepto por sítio.


```{r construcao do conjunto de dados para predicao}
l_f <- list()
l_f[[1]] <- "areaU_z ~ s(k_z,bs='cr',k=3) + s(k_z,SiteCode,bs='fs',k=3) + s(SiteCode,bs='re')"
l_f[[2]] <- sub("areaU_z","fragU_z",l_f[[1]])
l_f[[3]] <- sub("~ ","~ s(areaU_z,bs='cr',k=3) + ",l_f[[2]])
l_f[[4]] <- "fragU_z ~ s(areaU_z,bs='cr',k=3) + s(SiteCode,bs='re')"
names(l_f) <- c("areaU ~ f(k|Site)","fragU ~ f(k|Site)","fragU ~ f(areaU,k|Site)",
                "fragU ~ f(areaU,1|Site)")
l_f
```


## Resultados 

Para descrever o contraste de área foi adequado considerar os splines individuais de k, fixo e aleatórios. 

```{r sumario do modelo para a 1a camada}
load("./dados/Rdata/l_md_p_newdatapred_analise4.Rdata")
summary(l_md[[1]])
```

Para descrever o contraste de fragmentação per se o mais plausível foi considerar o spline fixo do contraste de área em adição aos splines de k, fixos e aleatórios (tabela de seleção). 

```{r ts_ad4_camada2}
df_tab <- read_csv(file="./dados/csv/ts_ad4_camada2.csv")
df_tab %>% gt()
```


Avaliei como os quantis de 5% e 95% são descritos segundo a relação proposta pela formula do modelo mais plausível. Esses dois quantis foram usados como valores extremos para criar uma sequência de valores intermediários.

```{r echo=TRUE,eval=FALSE}
library(qgam)
l_md_newdata <- l_md[names(l_md)[c("areaU ~ f(k|Site)",df_tab$modelo[1])]]
l_md_quant_ad4 <- llply(l_md_newdata,\(md) mqgam(form=md$formula,data=md$model,qu=c(0.05,0.95)))
```

Com esse modelo criei o conjunto de dados que considera as relações entre as preditoras. Na figura a seguir há os valores para os contrastes facetado pelos graus de limitação de dispersão simulados (20 valores)

```{r}
df_nd_k <- read_csv("./dados/csv/df_nd_k.csv")
df_nd_k %>% ggplot(aes(x=areaU_z,y=fragU_z)) +
  geom_point() +
  facet_wrap(~k_z,ncol=5)
```

## Próximos passos

Meu computador não tem memória RAM suficiente para construir o intervalo de predição a posteriori criado a partir desse conjunto de dados (~908 mil linhas). Então optei por construir o intervalo de predição a posteriori usando os valores observados e apenas plotar o scatterplot de número de SADs congruentes por grau de limitação de dispersão, colorir os pontos e as estimativas pelo tipo de paisagem hipotética. O


#### SI: 

função usada para criar o novo conjunto de dados

```{r função para criar novo conjunto de dados,echo=TRUE,eval=FALSE}
f_newdata_ad4 <- \(l_md_newdata,quantiles=c(0.05,0.95)){
  # funções
  f_predict <- \(mdq){
    df[[vname]] <- predict(mdq,type="response",
                           newdata=df,
                           exclude = c("s(k_z,SiteCode)","s(SiteCode)"))
    relocate(df, any_of(vname)) 
  }
  f_newdf <- \(d){
    d <- d %>% 
      mutate(diff = Q95-Q05,maxsize = round((150*diff)/max(diff),digits = 0)) %>% 
      select(-diff)
    f_seq <- \(X){
      v <- do.call("seq", as.list(c(from=X$Q05,to=X$Q95,length.out=X$maxsize)))
      X <- cbind(X,v)
      names(X)[ncol(X)] <- vname
      relocate(X, any_of(vname)) }
    adply(d,1,f_seq) %>% 
      select(-starts_with("Q"),-maxsize)
  }
  f_ddply <- \(){
    ddply(data.frame(q = c("Q05","Q95"),quantiles),
          "q",\(d) qgam::qdo(md,d$quantiles,f_predict)) %>% 
      pivot_wider(names_from="q",values_from=vname) %>% 
      f_newdf()
  }
  f_l <- \(s) l_md_newdata[[names(l_md_newdata) %>% str_which(.,sub("_z"," ~",s))]] 
  # 1a camada areaU_z ~ f(k)
  vname="areaU_z"
  md <- f_l(vname)
  df <- data.frame(k_z = do.call("seq", as.list(c(range(md$model$k_z),length.out=150))),
                   SiteCode = "SPigua1")
  df <- f_ddply()
  # 2a camada: frag ~ f(area,k)
  vname="fragU_z"
  md <- f_l(vname)
  f_ddply()
}
```



```{r}

```

